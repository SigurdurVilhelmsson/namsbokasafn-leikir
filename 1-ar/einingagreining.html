<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einingagreining - Kvenno Efnafr√¶√∞i</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --kvenno-orange: #f36b22;
            --kvenno-orange-dark: #d95a1a;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #f9fafb;
        }

        .site-header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-logo {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--kvenno-orange);
            text-decoration: none;
        }

        .site-logo:hover {
            color: var(--kvenno-orange-dark);
        }

        .header-btn {
            background: white;
            border: 2px solid var(--kvenno-orange);
            color: var(--kvenno-orange);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }

        .header-btn:hover {
            background: var(--kvenno-orange);
            color: white;
        }

        .breadcrumb {
            color: #6b7280;
            font-size: 0.875rem;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .breadcrumb a {
            color: var(--kvenno-orange);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .back-btn {
            background: white;
            border: 2px solid var(--kvenno-orange);
            color: var(--kvenno-orange);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 0.875rem;
            margin: 0 1rem 1rem 1rem;
        }

        .back-btn:hover {
            background: var(--kvenno-orange);
            color: white;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .conversion-factor {
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            min-height: 60px;
            font-size: 14px;
        }

        .conversion-factor:active {
            cursor: grabbing;
        }

        .conversion-factor.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            min-height: 100px;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            background-color: #e0e7ff;
            border-color: #6366f1;
        }

        /* Enhanced unit cancellation styles */
        .unit-cancelled {
            color: #22c55e;
            font-weight: bold;
            text-decoration: line-through;
            text-decoration-color: #22c55e;
            text-decoration-thickness: 2px;
        }

        .unit-remaining {
            color: #ef4444;
            font-weight: bold;
        }

        .unit-normal {
            color: #6b7280;
        }

        .fraction {
            display: inline-flex;
            flex-direction: column;
            vertical-align: middle;
            text-align: center;
        }

        .fraction > span {
            display: block;
            padding: 2px 8px;
        }

        .fraction > span:first-child {
            border-bottom: 2px solid currentColor;
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .pulse-success {
            animation: pulse-success 0.5s;
        }

        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .site-logo {
                font-size: 1rem;
            }

            .header-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .conversion-factor {
                font-size: 12px;
                min-height: 50px;
                padding: 0.5rem !important;
            }

            .stats-container {
                flex-direction: column;
            }

            body {
                font-size: 14px;
            }
        }

        @media (max-width: 375px) {
            .conversion-factor {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- Site Header -->
    <header class="site-header">
        <div class="header-content">
            <a href="/" class="site-logo">Kvenno Efnafr√¶√∞i</a>
            <div class="header-actions">
                <button class="header-btn" onclick="alert('Stj√≥rnendaa√∞gangur √≠ √ær√≥un')">Stj√≥rnandi</button>
                <button class="header-btn" onclick="alert('Hj√°lp og uppl√Ωsingar um leikina')">Uppl√Ωsingar</button>
            </div>
        </div>
    </header>

    <!-- Breadcrumbs -->
    <div class="breadcrumb">
        <a href="/">Heim</a> > <a href="/1-ar/">1. √°r</a> > <a href="/1-ar/games/">Leikir</a> > <span>Einingagreining</span>
    </div>

    <!-- Back Button -->
    <div class="nav-container">
        <a href="/1-ar/games/" class="back-btn">
            <span>‚Üê</span>
            <span>Til baka</span>
        </a>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icon components
        const HelpCircle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        const RotateCcw = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
        );

        const Trophy = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                <path d="M4 22h16"></path>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
            </svg>
        );

        const Lightbulb = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M9 18h6"></path>
                <path d="M10 22h4"></path>
                <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"></path>
            </svg>
        );

        const Eye = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        // Utility function to count significant figures
        const countSigFigs = (num) => {
            const str = num.toString();
            const cleaned = str.replace(/^0+/, '').replace('.', '');
            if (Math.abs(num) < 1) {
                const match = str.match(/\.0*([1-9]\d*)/);
                return match ? match[1].length : 1;
            }
            return cleaned.length || 1;
        };

        // Format number to specific significant figures
        const formatToSigFigs = (num, sigFigs) => {
            if (num === 0) return '0';

            const magnitude = Math.floor(Math.log10(Math.abs(num)));
            const precision = sigFigs - magnitude - 1;

            if (precision < 0) {
                const factor = Math.pow(10, -precision);
                return (Math.round(num / factor) * factor).toString();
            } else {
                return num.toFixed(Math.max(0, precision));
            }
        };

        // Expanded question templates with conversion factors
        const questionTemplates = [
            // Easy - single step conversions
            {
                startValue: 5000,
                startUnit: 'g',
                targetUnit: 'kg',
                difficulty: 'easy',
                correctFactors: [{ num: '1 kg', den: '1000 g' }],
                availableFactors: [
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '100 cm', den: '1 m' },
                    { num: '60 s', den: '1 m√≠n' }
                ]
            },
            {
                startValue: 2.5,
                startUnit: 'L',
                targetUnit: 'mL',
                difficulty: 'easy',
                correctFactors: [{ num: '1000 mL', den: '1 L' }],
                availableFactors: [
                    { num: '1000 mL', den: '1 L' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mm', den: '1 m' }
                ]
            },
            {
                startValue: 350,
                startUnit: 'cm',
                targetUnit: 'm',
                difficulty: 'easy',
                correctFactors: [{ num: '1 m', den: '100 cm' }],
                availableFactors: [
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mm', den: '1 m' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '60 m√≠n', den: '1 klst' }
                ]
            },
            {
                startValue: 7500,
                startUnit: 'mL',
                targetUnit: 'L',
                difficulty: 'easy',
                correctFactors: [{ num: '1 L', den: '1000 mL' }],
                availableFactors: [
                    { num: '1000 mL', den: '1 L' },
                    { num: '1000 mg', den: '1 g' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 g', den: '1 kg' }
                ]
            },
            {
                startValue: 273,
                startUnit: 'K',
                targetUnit: '¬∞C',
                difficulty: 'easy',
                correctFactors: [{ num: '1 ¬∞C', den: '1 K - 273' }],
                availableFactors: [
                    { num: '1 ¬∞C', den: '1 K - 273' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 Pa', den: '1 kPa' }
                ]
            },
            {
                startValue: 120,
                startUnit: 's',
                targetUnit: 'm√≠n',
                difficulty: 'easy',
                correctFactors: [{ num: '1 m√≠n', den: '60 s' }],
                availableFactors: [
                    { num: '60 s', den: '1 m√≠n' },
                    { num: '60 m√≠n', den: '1 klst' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '100 cm', den: '1 m' }
                ]
            },
            {
                startValue: 3.5,
                startUnit: 'klst',
                targetUnit: 'm√≠n',
                difficulty: 'easy',
                correctFactors: [{ num: '60 m√≠n', den: '1 klst' }],
                availableFactors: [
                    { num: '60 m√≠n', den: '1 klst' },
                    { num: '60 s', den: '1 m√≠n' },
                    { num: '24 klst', den: '1 dagur' },
                    { num: '1000 mL', den: '1 L' }
                ]
            },
            {
                startValue: 2.5,
                startUnit: 'atm',
                targetUnit: 'kPa',
                difficulty: 'easy',
                correctFactors: [{ num: '101.3 kPa', den: '1 atm' }],
                availableFactors: [
                    { num: '101.3 kPa', den: '1 atm' },
                    { num: '1000 Pa', den: '1 kPa' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '1000 g', den: '1 kg' }
                ]
            },
            {
                startValue: 500,
                startUnit: 'cal',
                targetUnit: 'J',
                difficulty: 'easy',
                correctFactors: [{ num: '4.184 J', den: '1 cal' }],
                availableFactors: [
                    { num: '4.184 J', den: '1 cal' },
                    { num: '1000 J', den: '1 kJ' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '100 cm', den: '1 m' }
                ]
            },
            // Medium - two step conversions
            {
                startValue: 2500,
                startUnit: 'mg',
                targetUnit: 'kg',
                difficulty: 'medium',
                correctFactors: [
                    { num: '1 g', den: '1000 mg' },
                    { num: '1 kg', den: '1000 g' }
                ],
                availableFactors: [
                    { num: '1000 mg', den: '1 g' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mm', den: '1 m' }
                ]
            },
            {
                startValue: 3.2,
                startUnit: 'm',
                targetUnit: 'mm',
                difficulty: 'medium',
                correctFactors: [
                    { num: '100 cm', den: '1 m' },
                    { num: '10 mm', den: '1 cm' }
                ],
                availableFactors: [
                    { num: '100 cm', den: '1 m' },
                    { num: '10 mm', den: '1 cm' },
                    { num: '1000 mm', den: '1 m' },
                    { num: '1000 mg', den: '1 g' },
                    { num: '1000 mL', den: '1 L' }
                ]
            },
            {
                startValue: 0.0045,
                startUnit: 'kg',
                targetUnit: 'mg',
                difficulty: 'medium',
                correctFactors: [
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mg', den: '1 g' }
                ],
                availableFactors: [
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mg', den: '1 g' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '1000 mm', den: '1 m' }
                ]
            },
            {
                startValue: 180,
                startUnit: 'm√≠n',
                targetUnit: 's',
                difficulty: 'medium',
                correctFactors: [
                    { num: '60 s', den: '1 m√≠n' }
                ],
                availableFactors: [
                    { num: '60 s', den: '1 m√≠n' },
                    { num: '60 m√≠n', den: '1 klst' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 g', den: '1 kg' }
                ]
            },
            {
                startValue: 2,
                startUnit: 'atm',
                targetUnit: 'Pa',
                difficulty: 'medium',
                correctFactors: [
                    { num: '101.3 kPa', den: '1 atm' },
                    { num: '1000 Pa', den: '1 kPa' }
                ],
                availableFactors: [
                    { num: '101.3 kPa', den: '1 atm' },
                    { num: '1000 Pa', den: '1 kPa' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '100 cm', den: '1 m' }
                ]
            },
            {
                startValue: 3600,
                startUnit: 'J',
                targetUnit: 'kJ',
                difficulty: 'medium',
                correctFactors: [
                    { num: '1 kJ', den: '1000 J' }
                ],
                availableFactors: [
                    { num: '1000 J', den: '1 kJ' },
                    { num: '4.184 J', den: '1 cal' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '100 cm', den: '1 m' }
                ]
            },
            {
                startValue: 72,
                startUnit: 'km/klst',
                targetUnit: 'm/s',
                difficulty: 'medium',
                correctFactors: [
                    { num: '1000 m', den: '1 km' },
                    { num: '1 klst', den: '3600 s' }
                ],
                availableFactors: [
                    { num: '1000 m', den: '1 km' },
                    { num: '3600 s', den: '1 klst' },
                    { num: '60 s', den: '1 m√≠n' },
                    { num: '100 cm', den: '1 m' },
                    { num: '60 m√≠n', den: '1 klst' }
                ]
            },
            {
                startValue: 1.5,
                startUnit: 'g/mL',
                targetUnit: 'kg/L',
                difficulty: 'medium',
                correctFactors: [
                    { num: '1 kg', den: '1000 g' },
                    { num: '1000 mL', den: '1 L' }
                ],
                availableFactors: [
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mg', den: '1 g' },
                    { num: '1000 mm', den: '1 m' }
                ]
            },
            // Hard - three+ step conversions
            {
                startValue: 15000,
                startUnit: 'mm',
                targetUnit: 'km',
                difficulty: 'hard',
                correctFactors: [
                    { num: '1 cm', den: '10 mm' },
                    { num: '1 m', den: '100 cm' },
                    { num: '1 km', den: '1000 m' }
                ],
                availableFactors: [
                    { num: '10 mm', den: '1 cm' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 m', den: '1 km' },
                    { num: '1000 mg', den: '1 g' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mL', den: '1 L' }
                ]
            },
            {
                startValue: 500000,
                startUnit: '¬µg',
                targetUnit: 'g',
                difficulty: 'hard',
                correctFactors: [
                    { num: '1 mg', den: '1000 ¬µg' },
                    { num: '1 g', den: '1000 mg' }
                ],
                availableFactors: [
                    { num: '1000 ¬µg', den: '1 mg' },
                    { num: '1000 mg', den: '1 g' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mm', den: '1 m' }
                ]
            },
            {
                startValue: 2,
                startUnit: 'dagar',
                targetUnit: 's',
                difficulty: 'hard',
                correctFactors: [
                    { num: '24 klst', den: '1 dagur' },
                    { num: '60 m√≠n', den: '1 klst' },
                    { num: '60 s', den: '1 m√≠n' }
                ],
                availableFactors: [
                    { num: '24 klst', den: '1 dagur' },
                    { num: '60 m√≠n', den: '1 klst' },
                    { num: '60 s', den: '1 m√≠n' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mL', den: '1 L' }
                ]
            },
            {
                startValue: 5,
                startUnit: 'kWh',
                targetUnit: 'J',
                difficulty: 'hard',
                correctFactors: [
                    { num: '1000 W', den: '1 kW' },
                    { num: '3600 s', den: '1 klst' },
                    { num: '1 J/s', den: '1 W' }
                ],
                availableFactors: [
                    { num: '1000 W', den: '1 kW' },
                    { num: '3600 s', den: '1 klst' },
                    { num: '1 J/s', den: '1 W' },
                    { num: '1000 J', den: '1 kJ' },
                    { num: '4.184 J', den: '1 cal' },
                    { num: '60 m√≠n', den: '1 klst' }
                ]
            },
            {
                startValue: 25,
                startUnit: 'm/s',
                targetUnit: 'km/klst',
                difficulty: 'hard',
                correctFactors: [
                    { num: '1 km', den: '1000 m' },
                    { num: '3600 s', den: '1 klst' }
                ],
                availableFactors: [
                    { num: '1000 m', den: '1 km' },
                    { num: '3600 s', den: '1 klst' },
                    { num: '60 s', den: '1 m√≠n' },
                    { num: '60 m√≠n', den: '1 klst' },
                    { num: '100 cm', den: '1 m' },
                    { num: '1000 mL', den: '1 L' }
                ]
            },
            {
                startValue: 100,
                startUnit: 'kPa',
                targetUnit: 'bar',
                difficulty: 'hard',
                correctFactors: [
                    { num: '1 bar', den: '100 kPa' }
                ],
                availableFactors: [
                    { num: '100 kPa', den: '1 bar' },
                    { num: '1000 Pa', den: '1 kPa' },
                    { num: '101.3 kPa', den: '1 atm' },
                    { num: '1000 mL', den: '1 L' },
                    { num: '1000 g', den: '1 kg' },
                    { num: '100 cm', den: '1 m' }
                ]
            }
        ];

        const DimensionalAnalysisGame = () => {
            const [gameState, setGameState] = useState({
                currentQuestion: null,
                score: 0,
                questionsAnswered: 0,
                correctAnswers: 0,
                isPlaying: false,
                gameOver: false,
                difficulty: 'mixed',
                selectedFactors: [],
                feedback: null,
                streak: 0,
                bestStreak: 0,
                hintsRemaining: 3,
                hintsUsed: 0,
                showHint: false,
                hintLevel: 0,
                incorrectAttempts: 0,
                showSolution: false,
                gameMode: 'competition' // 'practice' or 'competition'
            });

            const [showInstructions, setShowInstructions] = useState(true);
            const [showModeSelect, setShowModeSelect] = useState(false);

            // Load game mode preference from localStorage
            useEffect(() => {
                const savedMode = localStorage.getItem('einingagreining-mode');
                if (savedMode) {
                    setGameState(prev => ({ ...prev, gameMode: savedMode }));
                }
            }, []);

            const generateQuestion = (difficulty) => {
                let availableQuestions;

                if (difficulty === 'mixed') {
                    availableQuestions = questionTemplates;
                } else {
                    availableQuestions = questionTemplates.filter(q => q.difficulty === difficulty);
                }

                const template = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];

                return {
                    id: Math.random().toString(36).substr(2, 9),
                    ...template
                };
            };

            const startGame = (mode) => {
                // Save mode preference
                localStorage.setItem('einingagreining-mode', mode);

                const firstQuestion = generateQuestion(gameState.difficulty);
                setGameState(prev => ({
                    ...prev,
                    currentQuestion: firstQuestion,
                    selectedFactors: [],
                    score: 0,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    isPlaying: true,
                    gameOver: false,
                    feedback: null,
                    streak: 0,
                    hintsRemaining: mode === 'practice' ? 999 : 3,
                    hintsUsed: 0,
                    showHint: false,
                    hintLevel: 0,
                    incorrectAttempts: 0,
                    showSolution: false,
                    gameMode: mode
                }));
                setShowModeSelect(false);
            };

            const invertFactor = (factor) => {
                return { num: factor.den, den: factor.num };
            };

            const handleFactorClick = (factor) => {
                if (!gameState.isPlaying || gameState.feedback === 'correct' || gameState.showSolution) return;

                // Add factor to selected factors
                setGameState(prev => ({
                    ...prev,
                    selectedFactors: [...prev.selectedFactors, factor],
                    showHint: false // Hide hint when user takes action
                }));
            };

            const handleInvertClick = (index, e) => {
                e.stopPropagation();
                setGameState(prev => {
                    const newFactors = [...prev.selectedFactors];
                    newFactors[index] = invertFactor(newFactors[index]);
                    return { ...prev, selectedFactors: newFactors };
                });
            };

            const handleRemoveFactor = (index) => {
                setGameState(prev => {
                    const newFactors = [...prev.selectedFactors];
                    newFactors.splice(index, 1);
                    return { ...prev, selectedFactors: newFactors };
                });
            };

            const parseUnit = (unitString) => {
                // Extract units from strings like "1000 mg" -> "mg"
                const match = unitString.match(/[a-zA-Z¬µ¬∞\/]+/);
                return match ? match[0] : unitString;
            };

            // Enhanced: Track compound units and validate conversion path
            const calculateResult = () => {
                if (!gameState.currentQuestion || gameState.selectedFactors.length === 0) {
                    return {
                        value: gameState.currentQuestion?.startValue,
                        numeratorUnits: [gameState.currentQuestion?.startUnit],
                        denominatorUnits: [],
                        cancelledUnits: []
                    };
                }

                let currentValue = gameState.currentQuestion.startValue;
                let numeratorUnits = [gameState.currentQuestion.startUnit];
                let denominatorUnits = [];
                let cancelledUnits = [];

                // Apply each conversion factor
                for (const factor of gameState.selectedFactors) {
                    const numParts = factor.num.split(' ');
                    const denParts = factor.den.split(' ');

                    const numValue = parseFloat(numParts[0]);
                    const numUnit = parseUnit(numParts.slice(1).join(' '));
                    const denValue = parseFloat(denParts[0]);
                    const denUnit = parseUnit(denParts.slice(1).join(' '));

                    // Multiply/divide the numerical values
                    currentValue = (currentValue * numValue) / denValue;

                    // Add units from numerator of conversion factor
                    numeratorUnits.push(numUnit);
                    // Add units from denominator of conversion factor
                    denominatorUnits.push(denUnit);

                    // Cancel out matching units
                    const numIndex = numeratorUnits.indexOf(denUnit);
                    if (numIndex !== -1) {
                        numeratorUnits.splice(numIndex, 1);
                        const denIndex = denominatorUnits.indexOf(denUnit);
                        denominatorUnits.splice(denIndex, 1);
                        cancelledUnits.push(denUnit);
                    }
                }

                return {
                    value: currentValue,
                    numeratorUnits,
                    denominatorUnits,
                    cancelledUnits
                };
            };

            // Format compound units for display
            const formatUnits = (numeratorUnits, denominatorUnits) => {
                if (numeratorUnits.length === 0 && denominatorUnits.length === 0) {
                    return 'einingarlaust';
                }

                const numCounts = {};
                numeratorUnits.forEach(unit => {
                    numCounts[unit] = (numCounts[unit] || 0) + 1;
                });

                const denCounts = {};
                denominatorUnits.forEach(unit => {
                    denCounts[unit] = (denCounts[unit] || 0) + 1;
                });

                const formatUnitGroup = (counts) => {
                    return Object.entries(counts)
                        .map(([unit, count]) => count > 1 ? `${unit}^${count}` : unit)
                        .join('¬∑');
                };

                const numStr = formatUnitGroup(numCounts);
                const denStr = formatUnitGroup(denCounts);

                if (!denStr) return numStr || '1';
                if (!numStr) return `1/${denStr}`;
                return `${numStr}/${denStr}`;
            };

            // Enhanced: Educational feedback based on error analysis
            const getEducationalFeedback = (result) => {
                const targetUnit = gameState.currentQuestion.targetUnit;

                // Check for duplicate factors
                const factorStrings = gameState.selectedFactors.map(f => `${f.num}/${f.den}`);
                const hasDuplicates = factorStrings.length !== new Set(factorStrings).size;

                if (hasDuplicates) {
                    return "√û√∫ ert a√∞ nota sama stu√∞ulinn tvisvar! Fjarl√¶g√∞u afritin.";
                }

                // Check if units didn't cancel properly
                if (result.denominatorUnits.length > 0) {
                    return `Einingarnar strikast ekki √∫t r√©tt. √û√∫ √°tt eftir ${result.denominatorUnits[0]} √≠ nefnara. Athuga√∞u hvort √æ√∫ √æurfir a√∞ sn√∫a vi√∞ stu√∞li.`;
                }

                // Check if we have multiple units in numerator
                if (result.numeratorUnits.length > 1) {
                    return `√û√∫ √°tt of margar einingar √≠ svarinu (${formatUnits(result.numeratorUnits, [])}). Athuga√∞u hvort allir stu√∞lar s√©u nau√∞synlegir.`;
                }

                // Check if we have wrong unit
                if (result.numeratorUnits.length === 1 && result.numeratorUnits[0] !== targetUnit) {
                    return `√û√∫ ert me√∞ ${result.numeratorUnits[0]} en √æarft ${targetUnit}. Pr√≥fa√∞u a√∞ b√¶ta vi√∞ fleiri umbreytingarstu√∞lum.`;
                }

                // Check for irrelevant factors
                const usedUnits = new Set();
                gameState.selectedFactors.forEach(f => {
                    usedUnits.add(parseUnit(f.num.split(' ').slice(1).join(' ')));
                    usedUnits.add(parseUnit(f.den.split(' ').slice(1).join(' ')));
                });

                const relevantUnits = new Set([gameState.currentQuestion.startUnit, targetUnit]);

                return "Athuga√∞u hvort allir stu√∞larnir hj√°lpi til vi√∞ umbreytinguna.";
            };

            // Enhanced: Method validation
            const validateConversionPath = () => {
                // Check if each factor actually contributes to reaching the target
                const result = calculateResult();

                // Detect if using irrelevant factors
                for (const factor of gameState.selectedFactors) {
                    const numUnit = parseUnit(factor.num.split(' ').slice(1).join(' '));
                    const denUnit = parseUnit(factor.den.split(' ').slice(1).join(' '));

                    // Check if this conversion is relevant to the problem
                    const startUnit = gameState.currentQuestion.startUnit;
                    const targetUnit = gameState.currentQuestion.targetUnit;

                    // Example: if converting g to kg, a mL/L factor is irrelevant
                    if (!numUnit.includes(startUnit) && !numUnit.includes(targetUnit) &&
                        !denUnit.includes(startUnit) && !denUnit.includes(targetUnit) &&
                        !result.cancelledUnits.includes(numUnit) && !result.cancelledUnits.includes(denUnit)) {
                        return {
                            valid: false,
                            message: `Stu√∞ullinn ${factor.num}/${factor.den} hj√°lpar ekki vi√∞ a√∞ breyta fr√° ${startUnit}.`
                        };
                    }
                }

                return { valid: true, message: "" };
            };

            const checkAnswer = () => {
                const result = calculateResult();
                const targetUnit = gameState.currentQuestion.targetUnit;
                const validation = validateConversionPath();

                // Check if we have exactly one unit in numerator matching target, and no denominator units
                const isCorrect = result.numeratorUnits.length === 1 &&
                                 result.numeratorUnits[0] === targetUnit &&
                                 result.denominatorUnits.length === 0 &&
                                 validation.valid;

                // In practice mode, don't penalize for points
                const isPracticeMode = gameState.gameMode === 'practice';

                const pointValue = gameState.currentQuestion.difficulty === 'easy' ? 10 :
                                gameState.currentQuestion.difficulty === 'medium' ? 20 : 30;

                const streakBonus = gameState.streak >= 3 ? 10 : 0;
                const hintPenalty = gameState.hintsUsed * 5;

                if (isCorrect) {
                    const earnedPoints = isPracticeMode ? 0 : Math.max(0, pointValue + streakBonus - hintPenalty);

                    setGameState(prev => ({
                        ...prev,
                        score: prev.score + earnedPoints,
                        questionsAnswered: prev.questionsAnswered + 1,
                        correctAnswers: prev.correctAnswers + 1,
                        feedback: 'correct',
                        streak: prev.streak + 1,
                        bestStreak: prev.streak + 1 > prev.bestStreak ? prev.streak + 1 : prev.bestStreak,
                        incorrectAttempts: 0,
                        showSolution: false
                    }));

                    setTimeout(() => {
                        const nextQuestion = generateQuestion(gameState.difficulty);
                        setGameState(prev => ({
                            ...prev,
                            currentQuestion: nextQuestion,
                            selectedFactors: [],
                            feedback: null,
                            hintsUsed: 0,
                            showHint: false,
                            hintLevel: 0,
                            hintsRemaining: isPracticeMode ? 999 : prev.hintsRemaining
                        }));
                    }, 2000);
                } else {
                    const newIncorrectAttempts = gameState.incorrectAttempts + 1;
                    const educationalFeedback = !validation.valid ? validation.message : getEducationalFeedback(result);

                    setGameState(prev => ({
                        ...prev,
                        feedback: 'incorrect',
                        feedbackMessage: educationalFeedback,
                        streak: 0,
                        incorrectAttempts: newIncorrectAttempts,
                        // Show solution option after 2 incorrect attempts
                        showSolution: newIncorrectAttempts >= 2 || isPracticeMode
                    }));

                    setTimeout(() => {
                        setGameState(prev => ({ ...prev, feedback: null }));
                    }, 4000);
                }
            };

            // Hint system
            const showHintHandler = () => {
                if (gameState.hintsRemaining <= 0 && gameState.gameMode !== 'practice') return;

                const newHintLevel = gameState.hintLevel + 1;
                const isPracticeMode = gameState.gameMode === 'practice';

                setGameState(prev => ({
                    ...prev,
                    showHint: true,
                    hintLevel: newHintLevel,
                    hintsRemaining: isPracticeMode ? 999 : prev.hintsRemaining - 1,
                    hintsUsed: prev.hintsUsed + 1
                }));
            };

            const getHintText = () => {
                if (!gameState.showHint) return "";

                const question = gameState.currentQuestion;
                const level = gameState.hintLevel;

                if (level === 1) {
                    return `√û√∫ √æarft ${question.correctFactors.length} umbreytingarskref.`;
                } else if (level === 2) {
                    const firstFactor = question.correctFactors[0];
                    const fromUnit = parseUnit(firstFactor.den.split(' ').slice(1).join(' '));
                    const toUnit = parseUnit(firstFactor.num.split(' ').slice(1).join(' '));
                    return `Byrja√∞u √° a√∞ breyta √∫r ${fromUnit} √≠ ${toUnit}.`;
                } else if (level >= 3) {
                    const firstFactor = question.correctFactors[0];
                    return `Fyrsti stu√∞ullinn er: ${firstFactor.num} / ${firstFactor.den}`;
                }

                return "";
            };

            // Solution display
            const displaySolution = () => {
                const question = gameState.currentQuestion;

                return (
                    <div className="mt-4 p-4 bg-blue-50 border-2 border-blue-300 rounded-xl">
                        <h3 className="font-bold text-lg mb-2 text-blue-800">üìñ Lausn:</h3>
                        <div className="space-y-2">
                            <p className="font-semibold">R√©ttir umbreytingarstu√∞lar:</p>
                            {question.correctFactors.map((factor, idx) => (
                                <div key={idx} className="flex items-center gap-2 ml-4">
                                    <span className="text-blue-600">Skref {idx + 1}:</span>
                                    <div className="inline-flex flex-col border-2 border-blue-400 rounded px-3 py-1 bg-white">
                                        <span className="font-semibold">{factor.num}</span>
                                        <div className="border-t-2 border-blue-500"></div>
                                        <span className="font-semibold">{factor.den}</span>
                                    </div>
                                </div>
                            ))}
                            <div className="mt-3 p-3 bg-white rounded border-2 border-blue-200">
                                <p className="text-sm font-semibold mb-1">√ötsk√Ωring:</p>
                                <p className="text-sm">
                                    {question.correctFactors.map((f, i) => {
                                        const fromUnit = parseUnit(f.den.split(' ').slice(1).join(' '));
                                        const toUnit = parseUnit(f.num.split(' ').slice(1).join(' '));
                                        return `Skref ${i+1}: Notum ${f.num}/${f.den} til a√∞ breyta ${fromUnit} √≠ ${toUnit}. `;
                                    })}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            const skipQuestion = () => {
                const nextQuestion = generateQuestion(gameState.difficulty);
                setGameState(prev => ({
                    ...prev,
                    currentQuestion: nextQuestion,
                    selectedFactors: [],
                    feedback: null,
                    hintsUsed: 0,
                    showHint: false,
                    hintLevel: 0,
                    incorrectAttempts: 0,
                    showSolution: false,
                    questionsAnswered: prev.questionsAnswered + 1
                }));
            };

            const resetGame = () => {
                setGameState(prev => ({
                    ...prev,
                    currentQuestion: null,
                    selectedFactors: [],
                    score: 0,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    isPlaying: false,
                    gameOver: false,
                    feedback: null,
                    streak: 0,
                    hintsRemaining: 3,
                    hintsUsed: 0,
                    showHint: false,
                    hintLevel: 0,
                    incorrectAttempts: 0,
                    showSolution: false
                }));
                setShowModeSelect(true);
            };

            const endGame = () => {
                setGameState(prev => ({
                    ...prev,
                    isPlaying: false,
                    gameOver: true
                }));
            };

            // Enhanced: Unit cancellation visualization with color coding
            const renderUnitCancellation = () => {
                if (!gameState.currentQuestion || gameState.selectedFactors.length === 0) return null;

                const result = calculateResult();
                let currentUnit = gameState.currentQuestion.startUnit;

                return (
                    <div className="flex items-center flex-wrap gap-2 text-lg justify-center">
                        <span className="font-bold">
                            {gameState.currentQuestion.startValue}
                            <span className="ml-1 text-blue-600">{gameState.currentQuestion.startUnit}</span>
                        </span>
                        {gameState.selectedFactors.map((factor, idx) => {
                            const denUnit = parseUnit(factor.den.split(' ').slice(1).join(' '));
                            const numUnit = parseUnit(factor.num.split(' ').slice(1).join(' '));
                            const previousUnit = idx === 0 ? gameState.currentQuestion.startUnit :
                                               parseUnit(gameState.selectedFactors[idx-1].num.split(' ').slice(1).join(' '));
                            const cancelled = denUnit === previousUnit;

                            return (
                                <React.Fragment key={idx}>
                                    <span>√ó</span>
                                    <div className="inline-flex flex-col border-2 border-purple-300 rounded px-2 py-1 bg-purple-50">
                                        <span className={cancelled ? "text-green-600" : "text-gray-700"}>
                                            {factor.num}
                                        </span>
                                        <div className="border-t-2 border-gray-400"></div>
                                        <span className={cancelled ? "unit-cancelled" : "text-gray-700"}>
                                            {factor.den}
                                        </span>
                                    </div>
                                </React.Fragment>
                            );
                        })}
                        <span className="ml-2">=</span>
                        <span className="font-bold ml-2">
                            {formatToSigFigs(result.value, countSigFigs(gameState.currentQuestion.startValue))}
                            <span className={`ml-1 ${result.numeratorUnits[0] === gameState.currentQuestion.targetUnit ? 'text-green-600' : 'text-red-600'}`}>
                                {formatUnits(result.numeratorUnits, result.denominatorUnits)}
                            </span>
                        </span>
                    </div>
                );
            };

            // Mode selection screen
            if (showModeSelect) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 p-4 md:p-8">
                        <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-center mb-6 text-purple-600">
                                üî¨ Veldu leikham
                            </h1>

                            <div className="grid md:grid-cols-2 gap-4 md:gap-6">
                                <button
                                    onClick={() => startGame('practice')}
                                    className="bg-gradient-to-br from-green-400 to-green-600 hover:from-green-500 hover:to-green-700 text-white font-bold py-8 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                                >
                                    <div className="text-4xl md:text-5xl mb-3">üìö</div>
                                    <div className="text-xl md:text-2xl mb-2">√Üfing</div>
                                    <div className="text-sm opacity-90 mt-3 space-y-1">
                                        <p>‚úì Engin t√≠mam√∂rk</p>
                                        <p>‚úì √ìtakmarka√∞ar v√≠sbendingar</p>
                                        <p>‚úì Sko√∞a lausn hven√¶r sem er</p>
                                        <p>‚úì Engin stigagj√∂f</p>
                                    </div>
                                </button>

                                <button
                                    onClick={() => startGame('competition')}
                                    className="bg-gradient-to-br from-orange-400 to-red-600 hover:from-orange-500 hover:to-red-700 text-white font-bold py-8 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                                >
                                    <div className="text-4xl md:text-5xl mb-3">üèÜ</div>
                                    <div className="text-xl md:text-2xl mb-2">Keppni</div>
                                    <div className="text-sm opacity-90 mt-3 space-y-1">
                                        <p>‚ö° Stigagj√∂f virk</p>
                                        <p>üí° 3 v√≠sbendingar</p>
                                        <p>üìä R√∂√∞ (streak) b√≥nus</p>
                                        <p>üéØ √Åskorun</p>
                                    </div>
                                </button>
                            </div>

                            <button
                                onClick={() => setShowInstructions(true)}
                                className="w-full mt-6 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-colors"
                            >
                                üìñ Lei√∞beiningar
                            </button>
                        </div>
                    </div>
                );
            }

            if (showInstructions) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 p-4 md:p-8">
                        <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-center mb-6 text-purple-600">
                                üî¨ Einingagreining
                            </h1>

                            <div className="space-y-4 text-gray-700">
                                <h2 className="text-xl md:text-2xl font-semibold text-purple-500">Lei√∞beiningar</h2>

                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">Markmi√∞:</h3>
                                    <p>Nota√∞u umbreytingarstu√∞la til a√∞ umbreyta √∫r einni einingu √≠ a√∞ra me√∞ stu√∞la-merkingara√∞fer√∞inni (factor-label method)!</p>
                                </div>

                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">Hvernig √° a√∞ spila:</h3>
                                    <ol className="list-decimal ml-5 space-y-2 text-sm md:text-base">
                                        <li>Veldu umbreytingarstu√∞ul fr√° listanum fyrir ne√∞an</li>
                                        <li>Smelltu √° "‚áÖ" til a√∞ sn√∫a stu√∞li vi√∞ ef √æ√∂rf er √°</li>
                                        <li>B√¶ttu vi√∞ fleiri stu√∞lum ef √æ√∂rf er √°</li>
                                        <li>Athuga√∞u hvort einingarnar strika √∫t r√©tt (gr√¶nar l√≠nur)</li>
                                        <li>√ùttu √° "Athuga svar"</li>
                                    </ol>
                                </div>

                                <div className="bg-green-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">D√¶mi:</h3>
                                    <p className="text-sm md:text-base">Til a√∞ umbreyta 5000 g √≠ kg:</p>
                                    <div className="mt-2 p-3 bg-white rounded border-2 border-green-200">
                                        <div className="font-mono text-center text-sm md:text-base">
                                            5000 g √ó (1 kg / 1000 g) = 5 kg
                                        </div>
                                    </div>
                                    <p className="text-sm mt-2 text-gray-600">
                                        Athuga√∞u a√∞ "g" einingin strikast √∫t!
                                    </p>
                                </div>

                                <div className="bg-yellow-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">Stigagj√∂f (Keppnisham):</h3>
                                    <ul className="list-disc ml-5 space-y-1 text-sm md:text-base">
                                        <li>Au√∞velt: 10 stig</li>
                                        <li>Mi√∞lungs: 20 stig</li>
                                        <li>Erfitt: 30 stig</li>
                                        <li>Streak b√≥nus (3+): +10 stig</li>
                                        <li>V√≠sbending: -5 stig</li>
                                    </ul>
                                </div>

                                <div className="bg-red-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">‚ö†Ô∏è Mikilv√¶gt:</h3>
                                    <p className="text-sm md:text-base">G√¶ttu √æess a√∞ nota r√©tta stu√∞la! Ef √æ√∫ notar stu√∞ul rangt, √æ√° munu einingarnar EKKI strikast r√©tt √∫t og √æ√∫ f√¶r√∞ ranga einingu √≠ svarinu.</p>
                                </div>

                                <div className="bg-indigo-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">üí° N√Ωjar eiginleikar:</h3>
                                    <ul className="list-disc ml-5 space-y-1 text-sm md:text-base">
                                        <li>Litk√≥√∞a√∞ar einingar (gr√¶nt = strika√∞ar √∫t, rautt = eftir)</li>
                                        <li>V√≠sbendingakerfi (3 stig af v√≠sbendingum)</li>
                                        <li>Sj√° lausn eftir 2 rangar tilraunir</li>
                                        <li>√Üfingahamur me√∞ √≥takm√∂rku√∞um v√≠sbendingum</li>
                                        <li>Fleiri tegundir umbreytinga (hiti, √ær√Ωstingur, orka, hra√∞i)</li>
                                    </ul>
                                </div>
                            </div>

                            <div className="mt-8 space-y-4">
                                <h2 className="text-lg md:text-xl font-semibold text-center text-purple-600">
                                    Veldu erfi√∞leikastig
                                </h2>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({ ...prev, difficulty: 'easy' }));
                                            setShowInstructions(false);
                                            setShowModeSelect(true);
                                        }}
                                        className="bg-green-500 hover:bg-green-600 text-white font-bold py-4 md:py-6 px-4 md:px-6 rounded-xl transition-colors"
                                    >
                                        <div className="text-2xl mb-2">üòä</div>
                                        <div className="text-lg md:text-xl">Au√∞velt</div>
                                        <div className="text-xs mt-2">1 skref</div>
                                    </button>

                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({ ...prev, difficulty: 'medium' }));
                                            setShowInstructions(false);
                                            setShowModeSelect(true);
                                        }}
                                        className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 md:py-6 px-4 md:px-6 rounded-xl transition-colors"
                                    >
                                        <div className="text-2xl mb-2">ü§î</div>
                                        <div className="text-lg md:text-xl">Mi√∞lungs</div>
                                        <div className="text-xs mt-2">2 skref</div>
                                    </button>

                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({ ...prev, difficulty: 'hard' }));
                                            setShowInstructions(false);
                                            setShowModeSelect(true);
                                        }}
                                        className="bg-red-500 hover:bg-red-600 text-white font-bold py-4 md:py-6 px-4 md:px-6 rounded-xl transition-colors"
                                    >
                                        <div className="text-2xl mb-2">üò∞</div>
                                        <div className="text-lg md:text-xl">Erfitt</div>
                                        <div className="text-xs mt-2">3+ skref</div>
                                    </button>

                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({ ...prev, difficulty: 'mixed' }));
                                            setShowInstructions(false);
                                            setShowModeSelect(true);
                                        }}
                                        className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 md:py-6 px-4 md:px-6 rounded-xl transition-colors"
                                    >
                                        <div className="text-2xl mb-2">üé≤</div>
                                        <div className="text-lg md:text-xl">Blanda√∞</div>
                                        <div className="text-xs mt-2">√ñll stig</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState.gameOver) {
                const accuracy = gameState.questionsAnswered > 0
                    ? ((gameState.correctAnswers / gameState.questionsAnswered) * 100).toFixed(1)
                    : '0';

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 p-4 md:p-8">
                        <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-center mb-6 text-purple-600">
                                üèÅ Leik loki√∞!
                            </h1>

                            <div className="space-y-6">
                                {gameState.gameMode === 'competition' && (
                                    <div className="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl">
                                        <div className="text-center">
                                            <div className="text-5xl md:text-6xl font-bold text-purple-600 mb-2">{gameState.score}</div>
                                            <div className="text-lg md:text-xl text-gray-700">Heildarsta√∞a</div>
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-blue-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-blue-600">{gameState.questionsAnswered}</div>
                                        <div className="text-xs md:text-sm text-gray-700">Spurningar</div>
                                    </div>

                                    <div className="bg-green-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-green-600">{gameState.correctAnswers}</div>
                                        <div className="text-xs md:text-sm text-gray-700">R√©tt</div>
                                    </div>

                                    <div className="bg-yellow-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-yellow-600">{accuracy}%</div>
                                        <div className="text-xs md:text-sm text-gray-700">N√°kv√¶mni</div>
                                    </div>

                                    <div className="bg-orange-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-orange-600">{gameState.bestStreak}</div>
                                        <div className="text-xs md:text-sm text-gray-700">Besta r√∂√∞</div>
                                    </div>
                                </div>

                                <div className="bg-purple-50 p-4 rounded-xl">
                                    <h3 className="font-semibold text-center mb-2">
                                        {gameState.score >= 150 ? 'üåü Fr√°b√¶rt!' :
                                        gameState.score >= 100 ? 'üëç Vel gert!' :
                                        gameState.score >= 50 ? 'üí™ G√≥√∞ byrjun!' :
                                        gameState.gameMode === 'practice' ? 'üìö G√≥√∞ √¶fing!' :
                                        'üìö √Üf√∞u meira!'}
                                    </h3>
                                    <p className="text-center text-sm text-gray-700">
                                        {gameState.gameMode === 'practice'
                                            ? '√û√∫ svara√∞ir ' + gameState.correctAnswers + ' af ' + gameState.questionsAnswered + ' spurningum r√©tt √≠ √¶fingaham!'
                                            : gameState.score >= 150 ? '√û√∫ ert snillingur √≠ einingaumbreytingum!' :
                                            gameState.score >= 100 ? '√û√∫ ert a√∞ fara vel me√∞ √æetta!' :
                                            gameState.score >= 50 ? 'Haltu √°fram a√∞ √¶fa!' :
                                            'Pr√≥fa√∞u a√∞ byrja √° au√∞veldu stigi!'}
                                    </p>
                                </div>

                                <div className="flex gap-4">
                                    <button
                                        onClick={resetGame}
                                        className="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl transition-colors flex items-center justify-center gap-2 text-sm md:text-base"
                                    >
                                        <RotateCcw size={20} />
                                        Spila aftur
                                    </button>
                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({...prev, gameOver: false}));
                                            setShowInstructions(true);
                                        }}
                                        className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl transition-colors flex items-center justify-center gap-2 text-sm md:text-base"
                                    >
                                        <HelpCircle size={20} />
                                        Lei√∞beiningar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main game interface
            const result = calculateResult();
            const sigFigs = countSigFigs(gameState.currentQuestion?.startValue || 1);
            const formattedValue = formatToSigFigs(result.value, sigFigs);
            const unitDisplay = formatUnits(result.numeratorUnits, result.denominatorUnits);

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 p-4 md:p-8">
                    <div className="max-w-5xl mx-auto">
                        {/* Score and Stats Bar */}
                        <div className="bg-white rounded-2xl shadow-xl p-4 mb-6">
                            <div className="stats-container flex justify-between items-center flex-wrap gap-4">
                                <div className="flex items-center gap-4 md:gap-6 flex-wrap">
                                    {/* Mode indicator */}
                                    <div className="text-center">
                                        <div className={`text-xs md:text-sm px-2 md:px-3 py-1 rounded-full font-semibold ${
                                            gameState.gameMode === 'practice'
                                                ? 'bg-green-100 text-green-700'
                                                : 'bg-orange-100 text-orange-700'
                                        }`}>
                                            {gameState.gameMode === 'practice' ? 'üìö √Üfing' : 'üèÜ Keppni'}
                                        </div>
                                    </div>

                                    {gameState.gameMode === 'competition' && (
                                        <div className="text-center">
                                            <div className="flex items-center gap-2 text-purple-600 mb-1">
                                                <Trophy size={20} />
                                                <span className="text-2xl md:text-3xl font-bold">{gameState.score}</span>
                                            </div>
                                            <div className="text-xs text-gray-600">Stig</div>
                                        </div>
                                    )}

                                    <div className="text-center">
                                        <div className="text-xl md:text-2xl font-bold text-green-600">
                                            {gameState.correctAnswers}/{gameState.questionsAnswered}
                                        </div>
                                        <div className="text-xs text-gray-600">R√©tt</div>
                                    </div>

                                    {gameState.streak >= 3 && (
                                        <div className="text-center animate-pulse">
                                            <div className="text-xl md:text-2xl font-bold text-orange-600">
                                                üî• {gameState.streak}
                                            </div>
                                            <div className="text-xs text-gray-600">R√∂√∞</div>
                                        </div>
                                    )}

                                    {gameState.gameMode === 'competition' && (
                                        <div className="text-center">
                                            <div className="text-xl md:text-2xl font-bold text-blue-600">
                                                üí° {gameState.hintsRemaining}
                                            </div>
                                            <div className="text-xs text-gray-600">V√≠sbendingar</div>
                                        </div>
                                    )}
                                </div>

                                <button
                                    onClick={endGame}
                                    className="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 md:px-4 rounded-lg transition-colors text-xs md:text-sm"
                                >
                                    Lj√∫ka leik
                                </button>
                            </div>
                        </div>

                        {/* Question Display */}
                        <div className="bg-white rounded-2xl shadow-xl p-4 md:p-8 mb-6">
                            <div className="text-center mb-6">
                                <div className="inline-block bg-purple-100 px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-semibold text-purple-700 mb-4">
                                    {gameState.currentQuestion?.difficulty === 'easy' ? 'Au√∞velt' :
                                     gameState.currentQuestion?.difficulty === 'medium' ? 'Mi√∞lungs' :
                                     'Erfitt'}
                                </div>

                                <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-2">
                                    Umbreyttu:
                                </h2>
                                <div className="text-3xl md:text-5xl font-bold text-purple-600 mb-2">
                                    {gameState.currentQuestion?.startValue} {gameState.currentQuestion?.startUnit}
                                </div>
                                <div className="text-xl md:text-2xl text-gray-600 mb-2">‚Üí</div>
                                <div className="text-3xl md:text-4xl font-bold text-gray-800">
                                    ? {gameState.currentQuestion?.targetUnit}
                                </div>
                            </div>

                            {/* Conversion Chain Visualization */}
                            {gameState.selectedFactors.length > 0 && (
                                <div className="mb-6 p-3 md:p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
                                    <h3 className="text-xs md:text-sm font-semibold text-gray-700 mb-3 text-center">
                                        √û√≠n umbreyting:
                                    </h3>
                                    {renderUnitCancellation()}
                                </div>
                            )}

                            {/* Hint Display */}
                            {gameState.showHint && (
                                <div className="mb-4 p-3 md:p-4 bg-yellow-50 border-2 border-yellow-300 rounded-xl">
                                    <div className="flex items-start gap-2">
                                        <Lightbulb size={24} className="text-yellow-600 flex-shrink-0" />
                                        <div>
                                            <div className="font-bold text-yellow-800 text-sm md:text-base">V√≠sbending {gameState.hintLevel}:</div>
                                            <div className="text-yellow-700 text-sm md:text-base">{getHintText()}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Selected Factors */}
                            {gameState.selectedFactors.length > 0 && (
                                <div className="mb-6">
                                    <h3 className="text-xs md:text-sm font-semibold text-gray-700 mb-2">
                                        Valdir stu√∞lar:
                                    </h3>
                                    <div className="flex flex-wrap gap-2">
                                        {gameState.selectedFactors.map((factor, idx) => (
                                            <div key={idx} className="inline-flex items-center gap-2 bg-purple-100 border-2 border-purple-300 rounded-lg px-2 md:px-3 py-2">
                                                <div className="flex flex-col text-center text-xs md:text-sm">
                                                    <span className="font-semibold">{factor.num}</span>
                                                    <div className="border-t-2 border-purple-400"></div>
                                                    <span className="font-semibold">{factor.den}</span>
                                                </div>
                                                <button
                                                    onClick={(e) => handleInvertClick(idx, e)}
                                                    className="bg-purple-500 hover:bg-purple-600 text-white rounded px-2 py-1 text-xs font-bold"
                                                    title="Sn√∫a vi√∞"
                                                >
                                                    ‚áÖ
                                                </button>
                                                <button
                                                    onClick={() => handleRemoveFactor(idx)}
                                                    className="bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 md:w-6 md:h-6 flex items-center justify-center text-xs font-bold"
                                                    title="Fjarl√¶gja"
                                                >
                                                    √ó
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Feedback Messages */}
                            {gameState.feedback === 'correct' && (
                                <div className="mb-4 p-3 md:p-4 bg-green-100 border-2 border-green-400 rounded-xl text-center pulse-success">
                                    <div className="text-3xl md:text-4xl mb-2">‚úÖ</div>
                                    <div className="text-xl md:text-2xl font-bold text-green-700">R√©tt!</div>
                                    <div className="text-xs md:text-sm text-green-600 mt-1">A√∞ hla√∞a n√¶stu spurningu...</div>
                                </div>
                            )}

                            {gameState.feedback === 'incorrect' && (
                                <div className="mb-4 p-3 md:p-4 bg-red-100 border-2 border-red-400 rounded-xl shake">
                                    <div className="text-center">
                                        <div className="text-3xl md:text-4xl mb-2">‚ùå</div>
                                        <div className="text-xl md:text-2xl font-bold text-red-700">Rangt</div>
                                        <div className="text-xs md:text-sm text-red-600 mt-2">
                                            {gameState.feedbackMessage}
                                        </div>
                                        <div className="text-xs md:text-sm text-red-500 mt-1">
                                            N√∫verandi eining: {unitDisplay}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Solution Display */}
                            {gameState.showSolution && !gameState.feedback && (
                                <div className="mb-4">
                                    <button
                                        onClick={skipQuestion}
                                        className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 md:px-6 rounded-xl transition-colors flex items-center justify-center gap-2 text-sm md:text-base mb-3"
                                    >
                                        <Eye size={20} />
                                        S√Ωna lausn og fara √≠ n√¶stu spurningu
                                    </button>
                                    {displaySolution()}
                                </div>
                            )}

                            {/* Action Buttons */}
                            <div className="flex gap-2 md:gap-4">
                                {!gameState.feedback && gameState.selectedFactors.length > 0 && (
                                    <button
                                        onClick={checkAnswer}
                                        className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl transition-colors text-base md:text-xl"
                                    >
                                        Athuga svar ‚úì
                                    </button>
                                )}

                                {!gameState.feedback && (gameState.gameMode === 'practice' || gameState.hintsRemaining > 0) && (
                                    <button
                                        onClick={showHintHandler}
                                        className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl transition-colors flex items-center justify-center gap-2 text-sm md:text-base"
                                    >
                                        <Lightbulb size={20} />
                                        V√≠sbending
                                        {gameState.gameMode === 'competition' && ` (${gameState.hintsRemaining})`}
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Available Conversion Factors */}
                        <div className="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                            <h3 className="text-base md:text-lg font-bold text-gray-800 mb-4 text-center">
                                Tilt√¶kir umbreytingarstu√∞lar:
                            </h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3">
                                {gameState.currentQuestion?.availableFactors.map((factor, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => handleFactorClick(factor)}
                                        disabled={gameState.feedback === 'correct' || gameState.showSolution}
                                        className="conversion-factor bg-gradient-to-br from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 disabled:from-gray-300 disabled:to-gray-400 text-white font-semibold p-3 md:p-4 rounded-xl transition-all shadow-md hover:shadow-lg disabled:cursor-not-allowed"
                                    >
                                        <div className="flex flex-col text-center">
                                            <span className="text-sm md:text-lg">{factor.num}</span>
                                            <div className="border-t-2 border-white my-1"></div>
                                            <span className="text-sm md:text-lg">{factor.den}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            <div className="mt-4 text-center text-xs md:text-sm text-gray-600">
                                Smelltu √° stu√∞ul til a√∞ b√¶ta honum vi√∞ ¬∑ Smelltu √° "‚áÖ" til a√∞ sn√∫a vi√∞
                            </div>
                        </div>

                        {/* Help Button */}
                        <div className="mt-6 flex gap-4 justify-center">
                            <button
                                onClick={() => setShowInstructions(true)}
                                className="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 md:py-3 px-4 md:px-6 rounded-xl transition-colors flex items-center gap-2 text-sm md:text-base"
                            >
                                <HelpCircle size={20} />
                                Hj√°lp
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DimensionalAnalysisGame />, document.getElementById('root'));
    </script>
</body>
</html>
