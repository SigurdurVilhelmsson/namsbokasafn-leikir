<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pH Titration Master - Kvenno Efnafræði</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Kvenno Brand Colors */
        :root {
            --kvenno-orange: #f36b22;
            --kvenno-orange-dark: #d95a1a;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #f9fafb;
        }

        /* Header Styles */
        .site-header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-logo {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--kvenno-orange);
            text-decoration: none;
        }

        /* Burette Styles */
        .burette {
            width: 80px;
            height: 400px;
            background: linear-gradient(to bottom, #e0e7ff 0%, #c7d2fe 100%);
            border: 3px solid #4338ca;
            border-radius: 10px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .burette-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, #3b82f6, #1e40af);
            transition: height 0.3s ease;
            border-radius: 0 0 7px 7px;
        }

        .burette-scale {
            position: absolute;
            left: -30px;
            top: 0;
            bottom: 0;
            width: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 11px;
            font-weight: bold;
            color: #4338ca;
        }

        /* Flask Styles */
        .erlenmeyer-flask {
            width: 200px;
            height: 250px;
            position: relative;
        }

        .flask-neck {
            width: 60px;
            height: 80px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.6));
            border: 3px solid #6366f1;
            border-bottom: none;
            margin: 0 auto;
            border-radius: 5px 5px 0 0;
        }

        .flask-body {
            width: 200px;
            height: 170px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border: 3px solid #6366f1;
            border-radius: 0 0 50% 50%;
            position: relative;
            overflow: hidden;
        }

        .flask-solution {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: all 0.5s ease;
            border-radius: 0 0 45% 45%;
        }

        .swirl {
            animation: swirl 2s ease-in-out;
        }

        @keyframes swirl {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }

        @keyframes drip {
            0% { transform: translateY(-10px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(20px); opacity: 0; }
        }

        .drip {
            animation: drip 0.8s ease-out;
        }

        /* pH Meter Styles */
        .ph-meter {
            background: linear-gradient(135deg, #1f2937, #374151);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 3px solid #6b7280;
        }

        .ph-display {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
            border: 2px solid #374151;
        }

        .ph-value {
            font-size: 3.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px currentColor;
        }

        .ph-scale-indicator {
            height: 30px;
            background: linear-gradient(to right,
                #ef4444 0%,
                #f59e0b 14%,
                #eab308 28%,
                #84cc16 42%,
                #22c55e 50%,
                #06b6d4 64%,
                #3b82f6 78%,
                #8b5cf6 92%,
                #a855f7 100%);
            border-radius: 15px;
            position: relative;
            margin-top: 15px;
        }

        .ph-marker {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 40px;
            background: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transition: left 0.3s ease;
        }

        /* Titration Curve Canvas */
        .curve-canvas {
            border: 2px solid #d1d5db;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Animations */
        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse-success {
            animation: pulse-success 0.6s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .shake {
            animation: shake 0.4s ease-in-out;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .burette {
                width: 60px;
                height: 300px;
            }

            .erlenmeyer-flask {
                width: 150px;
                height: 200px;
            }

            .flask-body {
                width: 150px;
                height: 120px;
            }

            .ph-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <a href="../index.html" class="site-logo">Kvenno Efnafræði</a>
            <div>
                <span style="font-weight: 600; color: #374151;">pH Titration Master</span>
            </div>
        </div>
    </header>

    <!-- React App Root -->
    <div id="root"></div>

    <!-- React Application -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Titration Problems Bank
        const TITRATIONS = [
            // Beginner Level (Strong/Strong)
            {
                id: 1,
                type: 'strong-strong',
                name: 'HCl + NaOH',
                analyte: { formula: 'HCl', volume: 25.0, molarity: 0.100, name: 'Saltssýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 25.0,
                equivalencePH: 7.00,
                initialPH: 1.00,
                bestIndicator: 'bromothymol-blue',
                difficulty: 'Byrjandi',
                Ka: null,
                pKa: null
            },
            {
                id: 2,
                type: 'strong-strong',
                name: 'HNO₃ + KOH',
                analyte: { formula: 'HNO₃', volume: 30.0, molarity: 0.0500, name: 'Saltpéturssýra' },
                titrant: { formula: 'KOH', molarity: 0.100, name: 'Kalíumhýdroxíð' },
                equivalenceVolume: 15.0,
                equivalencePH: 7.00,
                initialPH: 1.30,
                bestIndicator: 'bromothymol-blue',
                difficulty: 'Byrjandi',
                Ka: null,
                pKa: null
            },
            {
                id: 3,
                type: 'strong-strong',
                name: 'HCl + NaOH',
                analyte: { formula: 'HCl', volume: 50.0, molarity: 0.200, name: 'Saltssýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 100.0,
                equivalencePH: 7.00,
                initialPH: 0.70,
                bestIndicator: 'bromothymol-blue',
                difficulty: 'Byrjandi',
                Ka: null,
                pKa: null
            },
            {
                id: 4,
                type: 'strong-strong',
                name: 'HClO₄ + LiOH',
                analyte: { formula: 'HClO₄', volume: 15.0, molarity: 0.125, name: 'Perklórsýra' },
                titrant: { formula: 'LiOH', molarity: 0.100, name: 'Litíumhýdroxíð' },
                equivalenceVolume: 18.75,
                equivalencePH: 7.00,
                initialPH: 0.90,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Byrjandi',
                Ka: null,
                pKa: null
            },
            // Intermediate Level (Weak Acid/Strong Base)
            {
                id: 5,
                type: 'weak-strong',
                name: 'CH₃COOH + NaOH',
                analyte: { formula: 'CH₃COOH', volume: 25.0, molarity: 0.100, name: 'Ediksýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 25.0,
                equivalencePH: 8.72,
                initialPH: 2.87,
                halfEquivalencePH: 4.74,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Miðlungs',
                Ka: 1.8e-5,
                pKa: 4.74
            },
            {
                id: 6,
                type: 'weak-strong',
                name: 'HF + NaOH',
                analyte: { formula: 'HF', volume: 30.0, molarity: 0.150, name: 'Flússýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 45.0,
                equivalencePH: 8.08,
                initialPH: 2.08,
                halfEquivalencePH: 3.17,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Miðlungs',
                Ka: 6.8e-4,
                pKa: 3.17
            },
            {
                id: 7,
                type: 'weak-strong',
                name: 'HCOOH + KOH',
                analyte: { formula: 'HCOOH', volume: 20.0, molarity: 0.200, name: 'Maurasýra' },
                titrant: { formula: 'KOH', molarity: 0.100, name: 'Kalíumhýdroxíð' },
                equivalenceVolume: 40.0,
                equivalencePH: 8.35,
                initialPH: 2.22,
                halfEquivalencePH: 3.75,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Miðlungs',
                Ka: 1.8e-4,
                pKa: 3.75
            },
            {
                id: 8,
                type: 'weak-strong',
                name: 'C₆H₅COOH + NaOH',
                analyte: { formula: 'C₆H₅COOH', volume: 25.0, molarity: 0.100, name: 'Bensoesýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 25.0,
                equivalencePH: 8.60,
                initialPH: 2.60,
                halfEquivalencePH: 4.19,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Miðlungs',
                Ka: 6.5e-5,
                pKa: 4.19
            },
            // Weak Base/Strong Acid
            {
                id: 9,
                type: 'strong-weak',
                name: 'NH₃ + HCl',
                analyte: { formula: 'NH₃', volume: 25.0, molarity: 0.100, name: 'Ammoníak' },
                titrant: { formula: 'HCl', molarity: 0.100, name: 'Saltssýra' },
                equivalenceVolume: 25.0,
                equivalencePH: 5.28,
                initialPH: 11.13,
                halfEquivalencePH: 9.26,
                bestIndicator: 'methyl-red',
                difficulty: 'Miðlungs',
                Kb: 1.8e-5,
                pKa: 9.26
            },
            {
                id: 10,
                type: 'strong-weak',
                name: 'CH₃NH₂ + HCl',
                analyte: { formula: 'CH₃NH₂', volume: 25.0, molarity: 0.100, name: 'Metýlamín' },
                titrant: { formula: 'HCl', molarity: 0.100, name: 'Saltssýra' },
                equivalenceVolume: 25.0,
                equivalencePH: 5.82,
                initialPH: 11.82,
                halfEquivalencePH: 10.64,
                bestIndicator: 'methyl-red',
                difficulty: 'Miðlungs',
                Kb: 4.4e-4,
                pKa: 10.64
            },
            // Advanced Level - Polyprotic Acids
            {
                id: 11,
                type: 'polyprotic-diprotic',
                name: 'H₂SO₃ + NaOH',
                analyte: { formula: 'H₂SO₃', volume: 25.0, molarity: 0.100, name: 'Brennisteinssýrling' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolumes: [25.0, 50.0],
                equivalencePHs: [4.5, 9.0],
                initialPH: 1.5,
                halfEquivalencePHs: [1.9, 7.2],
                bestIndicator: 'phenolphthalein',
                difficulty: 'Háþróað',
                Ka1: 1.3e-2,
                Ka2: 6.3e-8,
                pKa1: 1.9,
                pKa2: 7.2
            },
            {
                id: 12,
                type: 'polyprotic-diprotic',
                name: 'H₂C₂O₄ + NaOH',
                analyte: { formula: 'H₂C₂O₄', volume: 30.0, molarity: 0.0800, name: 'Oxalsýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolumes: [24.0, 48.0],
                equivalencePHs: [2.9, 8.4],
                initialPH: 1.3,
                halfEquivalencePHs: [1.3, 4.3],
                bestIndicator: 'phenolphthalein',
                difficulty: 'Háþróað',
                Ka1: 5.9e-2,
                Ka2: 6.4e-5,
                pKa1: 1.3,
                pKa2: 4.3
            },
            {
                id: 13,
                type: 'polyprotic-triprotic',
                name: 'H₃PO₄ + NaOH',
                analyte: { formula: 'H₃PO₄', volume: 25.0, molarity: 0.100, name: 'Fosfórsýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolumes: [25.0, 50.0, 75.0],
                equivalencePHs: [4.7, 9.8, 12.4],
                initialPH: 1.6,
                halfEquivalencePHs: [2.15, 7.20, 12.35],
                bestIndicator: 'phenolphthalein',
                difficulty: 'Sérfræðingur',
                Ka1: 7.1e-3,
                Ka2: 6.3e-8,
                Ka3: 4.5e-13,
                pKa1: 2.15,
                pKa2: 7.20,
                pKa3: 12.35
            },
            // Amino Acid Titrations
            {
                id: 14,
                type: 'amino-acid',
                name: 'Glycine + NaOH',
                analyte: { formula: 'NH₃⁺CH₂COOH', volume: 25.0, molarity: 0.100, name: 'Glýsín (tvíeiginleiki)' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolumes: [25.0, 50.0],
                equivalencePHs: [5.97, 11.3],
                initialPH: 2.35,
                halfEquivalencePHs: [2.35, 9.78],
                bestIndicator: 'phenolphthalein',
                difficulty: 'Sérfræðingur',
                pKa1: 2.35,
                pKa2: 9.78,
                isoelectricPoint: 6.06
            },
            // More Weak Acids with Different pKa Values
            {
                id: 15,
                type: 'weak-strong',
                name: 'HClO + NaOH',
                analyte: { formula: 'HClO', volume: 25.0, molarity: 0.100, name: 'Undirklórsýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 25.0,
                equivalencePH: 10.3,
                initialPH: 4.2,
                halfEquivalencePH: 7.54,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Miðlungs',
                Ka: 2.9e-8,
                pKa: 7.54
            },
            {
                id: 16,
                type: 'weak-strong',
                name: 'HCN + KOH',
                analyte: { formula: 'HCN', volume: 20.0, molarity: 0.0500, name: 'Blásýra' },
                titrant: { formula: 'KOH', molarity: 0.100, name: 'Kalíumhýdroxíð' },
                equivalenceVolume: 10.0,
                equivalencePH: 10.9,
                initialPH: 5.15,
                halfEquivalencePH: 9.31,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Erfitt',
                Ka: 4.9e-10,
                pKa: 9.31
            },
            {
                id: 17,
                type: 'weak-strong',
                name: 'C₆H₅OH + NaOH',
                analyte: { formula: 'C₆H₅OH', volume: 25.0, molarity: 0.0800, name: 'Fenól' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 20.0,
                equivalencePH: 11.2,
                initialPH: 5.5,
                halfEquivalencePH: 9.98,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Erfitt',
                Ka: 1.05e-10,
                pKa: 9.98
            },
            // More Weak Bases
            {
                id: 18,
                type: 'strong-weak',
                name: 'C₅H₅N + HCl',
                analyte: { formula: 'C₅H₅N', volume: 25.0, molarity: 0.100, name: 'Pýridín' },
                titrant: { formula: 'HCl', molarity: 0.100, name: 'Saltssýra' },
                equivalenceVolume: 25.0,
                equivalencePH: 2.95,
                initialPH: 9.12,
                halfEquivalencePH: 5.23,
                bestIndicator: 'methyl-red',
                difficulty: 'Miðlungs',
                Kb: 1.7e-9,
                pKa: 5.23
            },
            {
                id: 19,
                type: 'strong-weak',
                name: 'C₂H₅NH₂ + HCl',
                analyte: { formula: 'C₂H₅NH₂', volume: 30.0, molarity: 0.150, name: 'Etýlamín' },
                titrant: { formula: 'HCl', molarity: 0.100, name: 'Saltssýra' },
                equivalenceVolume: 45.0,
                equivalencePH: 5.55,
                initialPH: 12.03,
                halfEquivalencePH: 10.73,
                bestIndicator: 'methyl-red',
                difficulty: 'Miðlungs',
                Kb: 5.4e-4,
                pKa: 10.73
            },
            // Unknown Concentration Problems
            {
                id: 20,
                type: 'unknown-concentration',
                name: 'HCl (óþekkt) + NaOH',
                analyte: { formula: 'HCl', volume: 25.0, molarity: 0.0856, name: 'Saltssýra (óþekkt styrkur)' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 21.4,
                equivalencePH: 7.00,
                initialPH: 1.07,
                bestIndicator: 'bromothymol-blue',
                difficulty: 'Sérfræðingur',
                unknownType: 'analyte',
                Ka: null,
                pKa: null
            },
            {
                id: 21,
                type: 'unknown-concentration',
                name: 'CH₃COOH (óþekkt) + NaOH',
                analyte: { formula: 'CH₃COOH', volume: 25.0, molarity: 0.134, name: 'Ediksýra (óþekkt styrkur)' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 33.5,
                equivalencePH: 8.85,
                initialPH: 2.72,
                halfEquivalencePH: 4.74,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Sérfræðingur',
                unknownType: 'analyte',
                Ka: 1.8e-5,
                pKa: 4.74
            },
            {
                id: 22,
                type: 'unknown-concentration',
                name: 'HCl + NaOH (óþekkt)',
                analyte: { formula: 'HCl', volume: 25.0, molarity: 0.100, name: 'Saltssýra' },
                titrant: { formula: 'NaOH', molarity: 0.0792, name: 'Natríumhýdroxíð (óþekkt styrkur)' },
                equivalenceVolume: 31.6,
                equivalencePH: 7.00,
                initialPH: 1.00,
                bestIndicator: 'bromothymol-blue',
                difficulty: 'Sérfræðingur',
                unknownType: 'titrant',
                Ka: null,
                pKa: null
            },
            // Mixed Concentrations
            {
                id: 23,
                type: 'strong-strong',
                name: 'HCl + NaOH (hár styrkur)',
                analyte: { formula: 'HCl', volume: 25.0, molarity: 0.500, name: 'Saltssýra' },
                titrant: { formula: 'NaOH', molarity: 0.250, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 50.0,
                equivalencePH: 7.00,
                initialPH: 0.30,
                bestIndicator: 'bromothymol-blue',
                difficulty: 'Miðlungs',
                Ka: null,
                pKa: null
            },
            {
                id: 24,
                type: 'weak-strong',
                name: 'CH₃COOH + NaOH (lágur styrkur)',
                analyte: { formula: 'CH₃COOH', volume: 50.0, molarity: 0.0250, name: 'Ediksýra' },
                titrant: { formula: 'NaOH', molarity: 0.0500, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 25.0,
                equivalencePH: 8.52,
                initialPH: 3.17,
                halfEquivalencePH: 4.74,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Erfitt',
                Ka: 1.8e-5,
                pKa: 4.74
            },
            {
                id: 25,
                type: 'weak-strong',
                name: 'HNO₂ + NaOH',
                analyte: { formula: 'HNO₂', volume: 25.0, molarity: 0.100, name: 'Nitrósýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 25.0,
                equivalencePH: 8.19,
                initialPH: 2.17,
                halfEquivalencePH: 3.37,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Miðlungs',
                Ka: 4.3e-4,
                pKa: 3.37
            },
            {
                id: 26,
                type: 'weak-strong',
                name: 'C₆H₄(OH)COOH + NaOH',
                analyte: { formula: 'C₆H₄(OH)COOH', volume: 25.0, molarity: 0.0750, name: 'Salicýlsýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 18.75,
                equivalencePH: 8.35,
                initialPH: 2.26,
                halfEquivalencePH: 2.98,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Erfitt',
                Ka: 1.05e-3,
                pKa: 2.98
            },
            {
                id: 27,
                type: 'strong-weak',
                name: '(CH₃)₃N + HCl',
                analyte: { formula: '(CH₃)₃N', volume: 25.0, molarity: 0.100, name: 'Trímetýlamín' },
                titrant: { formula: 'HCl', molarity: 0.100, name: 'Saltssýra' },
                equivalenceVolume: 25.0,
                equivalencePH: 5.50,
                initialPH: 11.70,
                halfEquivalencePH: 9.80,
                bestIndicator: 'methyl-red',
                difficulty: 'Miðlungs',
                Kb: 6.3e-5,
                pKa: 9.80
            },
            {
                id: 28,
                type: 'polyprotic-diprotic',
                name: 'H₂CO₃ + NaOH',
                analyte: { formula: 'H₂CO₃', volume: 25.0, molarity: 0.100, name: 'Kolsýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolumes: [25.0, 50.0],
                equivalencePHs: [8.3, 11.3],
                initialPH: 3.7,
                halfEquivalencePHs: [6.35, 10.33],
                bestIndicator: 'phenolphthalein',
                difficulty: 'Háþróað',
                Ka1: 4.5e-7,
                Ka2: 4.7e-11,
                pKa1: 6.35,
                pKa2: 10.33
            },
            {
                id: 29,
                type: 'weak-strong',
                name: 'CH₃CH₂COOH + NaOH',
                analyte: { formula: 'CH₃CH₂COOH', volume: 30.0, molarity: 0.120, name: 'Própanósýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 36.0,
                equivalencePH: 8.61,
                initialPH: 2.64,
                halfEquivalencePH: 4.87,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Miðlungs',
                Ka: 1.35e-5,
                pKa: 4.87
            },
            {
                id: 30,
                type: 'weak-strong',
                name: 'CH₂ClCOOH + NaOH',
                analyte: { formula: 'CH₂ClCOOH', volume: 25.0, molarity: 0.100, name: 'Klórediksýra' },
                titrant: { formula: 'NaOH', molarity: 0.100, name: 'Natríumhýdroxíð' },
                equivalenceVolume: 25.0,
                equivalencePH: 8.97,
                initialPH: 1.89,
                halfEquivalencePH: 2.87,
                bestIndicator: 'phenolphthalein',
                difficulty: 'Erfitt',
                Ka: 1.35e-3,
                pKa: 2.87
            }
        ];

        // Indicator Database
        const INDICATORS = {
            'methyl-orange': {
                name: 'Methyl Orange',
                nameIs: 'Metýlappelsínugult',
                pHRange: [3.1, 4.4],
                acidColor: '#ff4444',
                baseColor: '#ffff44',
                textAcid: 'rauður',
                textBase: 'gulur'
            },
            'methyl-red': {
                name: 'Methyl Red',
                nameIs: 'Metýlrautt',
                pHRange: [4.4, 6.2],
                acidColor: '#ff0000',
                baseColor: '#ffff00',
                textAcid: 'rauður',
                textBase: 'gulur'
            },
            'bromothymol-blue': {
                name: 'Bromothymol Blue',
                nameIs: 'Brómótýmólblátt',
                pHRange: [6.0, 7.6],
                acidColor: '#ffff00',
                baseColor: '#4444ff',
                textAcid: 'gulur',
                textBase: 'blár'
            },
            'phenolphthalein': {
                name: 'Phenolphthalein',
                nameIs: 'Fenólftaleín',
                pHRange: [8.3, 10.0],
                acidColor: 'transparent',
                baseColor: '#ff69b4',
                textAcid: 'litlaus',
                textBase: 'bleikur'
            },
            'thymol-blue': {
                name: 'Thymol Blue',
                nameIs: 'Týmólblátt',
                pHRange: [8.0, 9.6],
                acidColor: '#ffff00',
                baseColor: '#4444ff',
                textAcid: 'gulur',
                textBase: 'blár'
            }
        };

        // pH Calculation Functions
        const calculateStrongStrongPH = (volumeAcid, molarityAcid, volumeBase, molarityBase) => {
            const molesAcid = volumeAcid * molarityAcid / 1000;
            const molesBase = volumeBase * molarityBase / 1000;
            const totalVolume = (volumeAcid + volumeBase) / 1000;

            if (Math.abs(molesAcid - molesBase) < 1e-10) {
                return 7.00;
            } else if (molesAcid > molesBase) {
                const excessH = (molesAcid - molesBase) / totalVolume;
                return -Math.log10(excessH);
            } else {
                const excessOH = (molesBase - molesAcid) / totalVolume;
                const pOH = -Math.log10(excessOH);
                return 14 - pOH;
            }
        };

        const calculateWeakStrongPH = (volumeAcid, molarityAcid, Ka, volumeBase, molarityBase) => {
            const molesAcid = volumeAcid * molarityAcid / 1000;
            const molesBase = volumeBase * molarityBase / 1000;
            const totalVolume = (volumeAcid + volumeBase) / 1000;
            const pKa = -Math.log10(Ka);

            if (molesBase === 0) {
                // Initial pH (weak acid)
                const sqrtKaCa = Math.sqrt(Ka * molarityAcid / 1000);
                return -Math.log10(sqrtKaCa);
            } else if (molesBase < molesAcid - 1e-10) {
                // Buffer region (Henderson-Hasselbalch)
                const molesA = molesBase;
                const molesHA = molesAcid - molesBase;
                return pKa + Math.log10(molesA / molesHA);
            } else if (Math.abs(molesBase - molesAcid) < 1e-10) {
                // Equivalence point (weak base solution)
                const Cb = molesBase / totalVolume;
                const Kb = 1e-14 / Ka;
                const pOH = 0.5 * (-Math.log10(Kb) - Math.log10(Cb));
                return 14 - pOH;
            } else {
                // Excess strong base
                const excessOH = (molesBase - molesAcid) / totalVolume;
                return 14 + Math.log10(excessOH);
            }
        };

        const calculateStrongWeakPH = (volumeBase, molarityBase, pKa, volumeAcid, molarityAcid) => {
            const molesBase = volumeBase * molarityBase / 1000;
            const molesAcid = volumeAcid * molarityAcid / 1000;
            const totalVolume = (volumeBase + volumeAcid) / 1000;
            const Ka = Math.pow(10, -pKa);

            if (molesAcid === 0) {
                // Initial pH (weak base)
                const Kb = 1e-14 / Ka;
                const pOH = 0.5 * (-Math.log10(Kb) - Math.log10(molarityBase / 1000));
                return 14 - pOH;
            } else if (molesAcid < molesBase - 1e-10) {
                // Buffer region
                const molesBH = molesAcid;
                const molesB = molesBase - molesAcid;
                return pKa + Math.log10(molesB / molesBH);
            } else if (Math.abs(molesAcid - molesBase) < 1e-10) {
                // Equivalence point (weak acid solution)
                const Ca = molesAcid / totalVolume;
                const sqrtKaCa = Math.sqrt(Ka * Ca);
                return -Math.log10(sqrtKaCa);
            } else {
                // Excess strong acid
                const excessH = (molesAcid - molesBase) / totalVolume;
                return -Math.log10(excessH);
            }
        };

        // Polyprotic Acid Calculations
        const calculatePolyproticDiproticPH = (volumeAcid, molarityAcid, Ka1, Ka2, volumeBase, molarityBase) => {
            const molesAcid = volumeAcid * molarityAcid / 1000;
            const molesBase = volumeBase * molarityBase / 1000;
            const totalVolume = (volumeAcid + volumeBase) / 1000;
            const pKa1 = -Math.log10(Ka1);
            const pKa2 = -Math.log10(Ka2);

            if (molesBase === 0) {
                // Initial pH - diprotic acid (use Ka1 only)
                const sqrtKaCa = Math.sqrt(Ka1 * molarityAcid / 1000);
                return -Math.log10(sqrtKaCa);
            } else if (molesBase < molesAcid * 0.5 - 1e-10) {
                // First buffer region (H2A/HA-)
                const molesHA = molesBase;
                const molesH2A = molesAcid - molesBase;
                return pKa1 + Math.log10(molesHA / molesH2A);
            } else if (Math.abs(molesBase - molesAcid * 0.5) < 1e-10) {
                // First half-equivalence point
                return pKa1;
            } else if (molesBase < molesAcid - 1e-10) {
                // Between half-eq and first eq point
                const molesHA = molesAcid - molesBase;
                const molesA = molesBase - molesHA;
                return pKa1 + Math.log10(molesA / molesHA);
            } else if (Math.abs(molesBase - molesAcid) < 1e-10) {
                // First equivalence point (HA- amphoteric)
                return (pKa1 + pKa2) / 2;
            } else if (molesBase < molesAcid * 1.5 - 1e-10) {
                // Second buffer region (HA-/A2-)
                const molesA = molesBase - molesAcid;
                const molesHA = 2 * molesAcid - molesBase;
                return pKa2 + Math.log10(molesA / molesHA);
            } else if (Math.abs(molesBase - molesAcid * 1.5) < 1e-10) {
                // Second half-equivalence point
                return pKa2;
            } else if (molesBase < molesAcid * 2 - 1e-10) {
                // Between second half-eq and second eq
                const molesHA = molesAcid * 2 - molesBase;
                const molesA = molesBase - molesAcid;
                return pKa2 + Math.log10(molesA / molesHA);
            } else if (Math.abs(molesBase - molesAcid * 2) < 1e-10) {
                // Second equivalence point (A2- weak base)
                const Cb = molesBase / totalVolume;
                const Kb = 1e-14 / Ka2;
                const pOH = 0.5 * (-Math.log10(Kb) - Math.log10(Cb));
                return 14 - pOH;
            } else {
                // Excess strong base
                const excessOH = (molesBase - molesAcid * 2) / totalVolume;
                return 14 + Math.log10(excessOH);
            }
        };

        const calculatePolyproticTriproticPH = (volumeAcid, molarityAcid, Ka1, Ka2, Ka3, volumeBase, molarityBase) => {
            const molesAcid = volumeAcid * molarityAcid / 1000;
            const molesBase = volumeBase * molarityBase / 1000;
            const totalVolume = (volumeAcid + volumeBase) / 1000;
            const pKa1 = -Math.log10(Ka1);
            const pKa2 = -Math.log10(Ka2);
            const pKa3 = -Math.log10(Ka3);

            if (molesBase === 0) {
                // Initial pH - triprotic acid
                const sqrtKaCa = Math.sqrt(Ka1 * molarityAcid / 1000);
                return -Math.log10(sqrtKaCa);
            } else if (molesBase < molesAcid * 0.5) {
                // First buffer region (H3A/H2A-)
                const molesH2A = molesBase;
                const molesH3A = molesAcid - molesBase;
                return pKa1 + Math.log10(molesH2A / molesH3A);
            } else if (Math.abs(molesBase - molesAcid) < 1e-10) {
                // First equivalence point
                return (pKa1 + pKa2) / 2;
            } else if (molesBase < molesAcid * 1.5) {
                // Second buffer region (H2A-/HA2-)
                const molesHA = molesBase - molesAcid;
                const molesH2A = 2 * molesAcid - molesBase;
                return pKa2 + Math.log10(molesHA / molesH2A);
            } else if (Math.abs(molesBase - molesAcid * 2) < 1e-10) {
                // Second equivalence point
                return (pKa2 + pKa3) / 2;
            } else if (molesBase < molesAcid * 2.5) {
                // Third buffer region (HA2-/A3-)
                const molesA = molesBase - 2 * molesAcid;
                const molesHA = 3 * molesAcid - molesBase;
                return pKa3 + Math.log10(molesA / molesHA);
            } else if (Math.abs(molesBase - molesAcid * 3) < 1e-10) {
                // Third equivalence point
                const Cb = molesBase / totalVolume;
                const Kb = 1e-14 / Ka3;
                const pOH = 0.5 * (-Math.log10(Kb) - Math.log10(Cb));
                return 14 - pOH;
            } else {
                // Excess strong base
                const excessOH = (molesBase - molesAcid * 3) / totalVolume;
                return 14 + Math.log10(excessOH);
            }
        };

        const calculateAminoAcidPH = (volumeAcid, molarityAcid, pKa1, pKa2, volumeBase, molarityBase) => {
            // Amino acids are amphoteric (zwitterionic)
            const molesAcid = volumeAcid * molarityAcid / 1000;
            const molesBase = volumeBase * molarityBase / 1000;
            const totalVolume = (volumeAcid + volumeBase) / 1000;
            const Ka1 = Math.pow(10, -pKa1);
            const Ka2 = Math.pow(10, -pKa2);

            if (molesBase === 0) {
                // Initial pH - cationic form (NH3+CH2COOH)
                return (pKa1 + pKa2) / 2;  // At isoelectric point initially
            } else if (molesBase < molesAcid - 1e-10) {
                // First buffer region (deprotonation of COOH)
                const molesCOO = molesBase;
                const molesCOOH = molesAcid - molesBase;
                return pKa1 + Math.log10(molesCOO / molesCOOH);
            } else if (Math.abs(molesBase - molesAcid) < 1e-10) {
                // First equivalence point (zwitterion)
                return (pKa1 + pKa2) / 2;
            } else if (molesBase < molesAcid * 2 - 1e-10) {
                // Second buffer region (deprotonation of NH3+)
                const molesNH2 = molesBase - molesAcid;
                const molesNH3 = 2 * molesAcid - molesBase;
                return pKa2 + Math.log10(molesNH2 / molesNH3);
            } else if (Math.abs(molesBase - molesAcid * 2) < 1e-10) {
                // Second equivalence point (anionic form)
                const Cb = molesBase / totalVolume;
                const Kb = 1e-14 / Ka2;
                const pOH = 0.5 * (-Math.log10(Kb) - Math.log10(Cb));
                return 14 - pOH;
            } else {
                // Excess strong base
                const excessOH = (molesBase - molesAcid * 2) / totalVolume;
                return 14 + Math.log10(excessOH);
            }
        };

        // Get Indicator Color
        const getIndicatorColor = (pH, indicatorKey) => {
            const indicator = INDICATORS[indicatorKey];
            if (!indicator) return '#e0e7ff';

            const [pHLow, pHHigh] = indicator.pHRange;

            if (pH < pHLow) return indicator.acidColor;
            if (pH > pHHigh) return indicator.baseColor;

            // Transition zone (simple linear blend)
            const fraction = (pH - pHLow) / (pHHigh - pHLow);

            if (indicator.acidColor === 'transparent') {
                return `rgba(255, 105, 180, ${fraction})`;
            }

            return blendColors(indicator.acidColor, indicator.baseColor, fraction);
        };

        const blendColors = (color1, color2, fraction) => {
            const hex1 = color1.replace('#', '');
            const hex2 = color2.replace('#', '');

            const r1 = parseInt(hex1.substring(0, 2), 16);
            const g1 = parseInt(hex1.substring(2, 4), 16);
            const b1 = parseInt(hex1.substring(4, 6), 16);

            const r2 = parseInt(hex2.substring(0, 2), 16);
            const g2 = parseInt(hex2.substring(2, 4), 16);
            const b2 = parseInt(hex2.substring(4, 6), 16);

            const r = Math.round(r1 + (r2 - r1) * fraction);
            const g = Math.round(g1 + (g2 - g1) * fraction);
            const b = Math.round(b1 + (b2 - b1) * fraction);

            return `rgb(${r}, ${g}, ${b})`;
        };

        // Get pH Color for display
        const getPHColor = (pH) => {
            if (pH < 4) return '#ef4444';
            if (pH < 6) return '#f59e0b';
            if (pH < 8) return '#22c55e';
            return '#3b82f6';
        };

        // Main Game Component
        function TitrationGame() {
            const [screen, setScreen] = useState('menu');
            const [gameMode, setGameMode] = useState(null);
            const [currentTitration, setCurrentTitration] = useState(null);
            const [selectedIndicator, setSelectedIndicator] = useState('bromothymol-blue');
            const [volumeAdded, setVolumeAdded] = useState(0);
            const [currentPH, setCurrentPH] = useState(7.0);
            const [curveData, setCurveData] = useState([]);
            const [score, setScore] = useState(0);
            const [questionsAnswered, setQuestionsAnswered] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [showHint, setShowHint] = useState(false);
            const [isAnimating, setIsAnimating] = useState(false);
            const [startTime, setStartTime] = useState(null);
            const [highScore, setHighScore] = useState(0);
            const [totalTitrations, setTotalTitrations] = useState(0);

            const canvasRef = useRef(null);

            // Load progress from localStorage
            useEffect(() => {
                const savedHighScore = localStorage.getItem('titrationHighScore');
                const savedTotal = localStorage.getItem('titrationTotal');
                if (savedHighScore) setHighScore(parseInt(savedHighScore));
                if (savedTotal) setTotalTitrations(parseInt(savedTotal));
            }, []);

            // Save progress to localStorage
            useEffect(() => {
                if (questionsAnswered > 0) {
                    localStorage.setItem('titrationHighScore', Math.max(highScore, score).toString());
                    localStorage.setItem('titrationTotal', totalTitrations.toString());
                }
            }, [score, questionsAnswered]);

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    if (screen !== 'game' || !currentTitration) return;

                    switch(e.key.toLowerCase()) {
                        case ' ':
                            e.preventDefault();
                            addTitrant(0.1);
                            break;
                        case 'arrowup':
                            e.preventDefault();
                            addTitrant(0.1);
                            break;
                        case 'arrowdown':
                            e.preventDefault();
                            // Could subtract if we implement that
                            break;
                        case 'r':
                            e.preventDefault();
                            resetTitration();
                            break;
                        case 'h':
                            e.preventDefault();
                            if (gameMode === 'practice') {
                                setShowHint(!showHint);
                            }
                            break;
                        case 'enter':
                            e.preventDefault();
                            if (!feedback) {
                                checkAnswer();
                            } else {
                                nextQuestion();
                            }
                            break;
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [screen, currentTitration, volumeAdded, isAnimating, feedback, showHint, gameMode]);

            // Start new titration
            const startNewTitration = (mode) => {
                const randomTitration = TITRATIONS[Math.floor(Math.random() * TITRATIONS.length)];
                setGameMode(mode);
                setCurrentTitration(randomTitration);
                setSelectedIndicator(randomTitration.bestIndicator);
                setVolumeAdded(0);
                setCurveData([]);
                setFeedback(null);
                setShowHint(false);
                setStartTime(Date.now());

                // Calculate initial pH
                const initialPH = calculatePH(randomTitration, 0);
                setCurrentPH(initialPH);
                setCurveData([{ volume: 0, pH: initialPH }]);

                setScreen('game');
            };

            // Calculate pH based on titration type
            const calculatePH = (titration, volume) => {
                if (titration.type === 'strong-strong' || titration.type === 'unknown-concentration') {
                    return calculateStrongStrongPH(
                        titration.analyte.volume,
                        titration.analyte.molarity,
                        volume,
                        titration.titrant.molarity
                    );
                } else if (titration.type === 'weak-strong') {
                    return calculateWeakStrongPH(
                        titration.analyte.volume,
                        titration.analyte.molarity,
                        titration.Ka,
                        volume,
                        titration.titrant.molarity
                    );
                } else if (titration.type === 'strong-weak') {
                    return calculateStrongWeakPH(
                        titration.analyte.volume,
                        titration.analyte.molarity,
                        titration.pKa,
                        volume,
                        titration.titrant.molarity
                    );
                } else if (titration.type === 'polyprotic-diprotic') {
                    return calculatePolyproticDiproticPH(
                        titration.analyte.volume,
                        titration.analyte.molarity,
                        titration.Ka1,
                        titration.Ka2,
                        volume,
                        titration.titrant.molarity
                    );
                } else if (titration.type === 'polyprotic-triprotic') {
                    return calculatePolyproticTriproticPH(
                        titration.analyte.volume,
                        titration.analyte.molarity,
                        titration.Ka1,
                        titration.Ka2,
                        titration.Ka3,
                        volume,
                        titration.titrant.molarity
                    );
                } else if (titration.type === 'amino-acid') {
                    return calculateAminoAcidPH(
                        titration.analyte.volume,
                        titration.analyte.molarity,
                        titration.pKa1,
                        titration.pKa2,
                        volume,
                        titration.titrant.molarity
                    );
                }
                return 7.0;
            };

            // Add titrant
            const addTitrant = (amount) => {
                if (!currentTitration || isAnimating) return;

                setIsAnimating(true);
                const newVolume = Math.min(volumeAdded + amount, 60);
                const newPH = calculatePH(currentTitration, newVolume);

                setVolumeAdded(newVolume);
                setCurrentPH(newPH);
                setCurveData(prev => [...prev, { volume: newVolume, pH: newPH }]);

                setTimeout(() => setIsAnimating(false), 300);
            };

            // Reset titration
            const resetTitration = () => {
                setVolumeAdded(0);
                const initialPH = calculatePH(currentTitration, 0);
                setCurrentPH(initialPH);
                setCurveData([{ volume: 0, pH: initialPH }]);
                setFeedback(null);
                setShowHint(false);
            };

            // Generate detailed analysis
            const generateAnalysis = () => {
                if (!currentTitration) return null;

                const analysis = {
                    molarity: null,
                    moles: null,
                    hendersonHasselbalch: null,
                    bufferCapacity: null,
                    equivalencePoints: []
                };

                // Calculate moles
                const molesAnalyte = (currentTitration.analyte.volume * currentTitration.analyte.molarity) / 1000;
                const molesTitrant = (volumeAdded * currentTitration.titrant.molarity) / 1000;

                analysis.moles = {
                    analyte: molesAnalyte.toExponential(3),
                    titrant: molesTitrant.toExponential(3),
                    analyteValue: molesAnalyte,
                    titrantValue: molesTitrant
                };

                // Henderson-Hasselbalch for weak acids/bases
                if (currentTitration.type === 'weak-strong' && currentTitration.pKa) {
                    if (molesTitrant > 0 && molesTitrant < molesAnalyte) {
                        const molesAcid = molesAnalyte - molesTitrant;
                        const molesBase = molesTitrant;
                        const ratio = molesBase / molesAcid;
                        const calculatedPH = currentTitration.pKa + Math.log10(ratio);

                        analysis.hendersonHasselbalch = {
                            pKa: currentTitration.pKa.toFixed(2),
                            molesAcid: molesAcid.toExponential(3),
                            molesBase: molesBase.toExponential(3),
                            ratio: ratio.toFixed(3),
                            calculatedPH: calculatedPH.toFixed(2),
                            formula: `pH = pKa + log([A⁻]/[HA]) = ${currentTitration.pKa.toFixed(2)} + log(${ratio.toFixed(3)}) = ${calculatedPH.toFixed(2)}`
                        };
                    }
                }

                // Equivalence point information
                if (currentTitration.equivalenceVolume) {
                    analysis.equivalencePoints.push({
                        volume: currentTitration.equivalenceVolume.toFixed(2),
                        pH: currentTitration.equivalencePH.toFixed(2),
                        halfEquivalencePH: currentTitration.halfEquivalencePH?.toFixed(2)
                    });
                } else if (currentTitration.equivalenceVolumes) {
                    currentTitration.equivalenceVolumes.forEach((vol, idx) => {
                        analysis.equivalencePoints.push({
                            number: idx + 1,
                            volume: vol.toFixed(2),
                            pH: currentTitration.equivalencePHs[idx].toFixed(2),
                            halfEquivalencePH: currentTitration.halfEquivalencePHs?.[idx]?.toFixed(2)
                        });
                    });
                }

                // Ka calculation from half-equivalence point
                if (currentTitration.halfEquivalencePH && volumeAdded >= (currentTitration.equivalenceVolume || currentTitration.equivalenceVolumes?.[0])) {
                    analysis.kaCalculation = {
                        pKa: currentTitration.pKa || currentTitration.pKa1,
                        Ka: Math.pow(10, -(currentTitration.pKa || currentTitration.pKa1)).toExponential(2),
                        explanation: `På halvpunkten: pH = pKa = ${(currentTitration.pKa || currentTitration.pKa1).toFixed(2)}`
                    };
                }

                return analysis;
            };

            // Check answer
            const checkAnswer = () => {
                if (!currentTitration) return;

                // Determine target equivalence point
                let targetVolume, targetPH;
                if (currentTitration.equivalenceVolume) {
                    targetVolume = currentTitration.equivalenceVolume;
                    targetPH = currentTitration.equivalencePH;
                } else if (currentTitration.equivalenceVolumes) {
                    // For polyprotic, check which equivalence point is closest
                    let minDiff = Infinity;
                    let closestIdx = 0;
                    currentTitration.equivalenceVolumes.forEach((vol, idx) => {
                        const diff = Math.abs(volumeAdded - vol);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestIdx = idx;
                        }
                    });
                    targetVolume = currentTitration.equivalenceVolumes[closestIdx];
                    targetPH = currentTitration.equivalencePHs[closestIdx];
                }

                const difference = Math.abs(volumeAdded - targetVolume);
                const timeElapsed = (Date.now() - startTime) / 1000;

                let points = 0;
                let message = '';
                let isCorrect = false;

                if (difference <= 0.05) {
                    points = 150;
                    message = 'Fullkomið! Nákvæmni: ±0.05 mL';
                    isCorrect = true;
                } else if (difference <= 0.2) {
                    points = 100;
                    message = 'Frábært! Innan vikmarka: ±0.2 mL';
                    isCorrect = true;
                } else if (difference <= 0.5) {
                    points = 50;
                    message = 'Gott! Nálægt réttri upphæð';
                    isCorrect = true;
                } else {
                    points = 0;
                    message = `Ekki nægjanlega nákvæmt. Jafngildistaður: ${targetVolume.toFixed(2)} mL`;
                    isCorrect = false;
                }

                // Indicator bonus
                if (selectedIndicator === currentTitration.bestIndicator) {
                    points += 20;
                }

                // Time bonus (Practice mode)
                if (gameMode === 'practice' && timeElapsed < 120 && isCorrect) {
                    points += 30;
                }

                setScore(score + points);
                setQuestionsAnswered(questionsAnswered + 1);
                setTotalTitrations(totalTitrations + 1);
                if (score + points > highScore) {
                    setHighScore(score + points);
                }

                const analysis = generateAnalysis();

                setFeedback({
                    isCorrect,
                    message,
                    points,
                    difference: difference.toFixed(2),
                    equivalenceVolume: targetVolume.toFixed(2),
                    equivalencePH: targetPH.toFixed(2),
                    currentVolume: volumeAdded.toFixed(2),
                    currentPH: currentPH.toFixed(2),
                    timeElapsed: timeElapsed.toFixed(1),
                    analysis
                });
            };

            // Next question
            const nextQuestion = () => {
                startNewTitration(gameMode);
            };

            // Export data as CSV
            const exportToCSV = () => {
                if (curveData.length === 0) return;

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Volume (mL),pH\n";

                curveData.forEach(point => {
                    csvContent += `${point.volume.toFixed(2)},${point.pH.toFixed(2)}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `titration_${currentTitration.name.replace(/\s+/g, '_')}_${Date.now()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Export detailed report
            const exportDetailedReport = () => {
                if (!currentTitration) return;

                let report = `pH TITRATION REPORT\n`;
                report += `==================\n\n`;
                report += `Titration: ${currentTitration.name}\n`;
                report += `Date: ${new Date().toLocaleString('is-IS')}\n\n`;
                report += `SETUP:\n`;
                report += `- Analyte: ${currentTitration.analyte.formula} (${currentTitration.analyte.molarity} M, ${currentTitration.analyte.volume} mL)\n`;
                report += `- Titrant: ${currentTitration.titrant.formula} (${currentTitration.titrant.molarity} M)\n`;
                report += `- Indicator: ${INDICATORS[selectedIndicator].nameIs}\n`;
                report += `- Type: ${currentTitration.type}\n`;
                report += `- Difficulty: ${currentTitration.difficulty}\n\n`;

                if (currentTitration.pKa || currentTitration.pKa1) {
                    report += `ACID/BASE PROPERTIES:\n`;
                    if (currentTitration.pKa) {
                        report += `- pKa: ${currentTitration.pKa}\n`;
                        report += `- Ka: ${Math.pow(10, -currentTitration.pKa).toExponential(2)}\n`;
                    } else if (currentTitration.pKa1) {
                        report += `- pKa1: ${currentTitration.pKa1}\n`;
                        report += `- pKa2: ${currentTitration.pKa2}\n`;
                        if (currentTitration.pKa3) report += `- pKa3: ${currentTitration.pKa3}\n`;
                    }
                    report += `\n`;
                }

                report += `EQUIVALENCE POINT(S):\n`;
                if (currentTitration.equivalenceVolume) {
                    report += `- Volume: ${currentTitration.equivalenceVolume} mL\n`;
                    report += `- pH: ${currentTitration.equivalencePH}\n`;
                } else if (currentTitration.equivalenceVolumes) {
                    currentTitration.equivalenceVolumes.forEach((vol, idx) => {
                        report += `- Point ${idx + 1}: ${vol} mL (pH ${currentTitration.equivalencePHs[idx]})\n`;
                    });
                }
                report += `\n`;

                report += `TITRATION DATA:\n`;
                report += `Volume (mL)\tpH\n`;
                curveData.forEach(point => {
                    report += `${point.volume.toFixed(2)}\t${point.pH.toFixed(2)}\n`;
                });

                if (feedback) {
                    report += `\n\nRESULTS:\n`;
                    report += `- Your volume: ${feedback.currentVolume} mL\n`;
                    report += `- Your pH: ${feedback.currentPH}\n`;
                    report += `- Accuracy: ±${feedback.difference} mL\n`;
                    report += `- Time: ${feedback.timeElapsed} seconds\n`;
                    report += `- Score: ${feedback.points} points\n`;
                    report += `- Result: ${feedback.isCorrect ? 'CORRECT' : 'INCORRECT'}\n`;
                }

                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `titration_report_${currentTitration.name.replace(/\s+/g, '_')}_${Date.now()}.txt`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // Draw titration curve
            useEffect(() => {
                if (!canvasRef.current || curveData.length === 0) return;

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                // Clear canvas
                ctx.clearRect(0, 0, width, height);

                // Draw grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;

                // Vertical grid lines
                for (let i = 0; i <= 10; i++) {
                    const x = (i / 10) * width;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }

                // Horizontal grid lines
                for (let i = 0; i <= 14; i++) {
                    const y = height - (i / 14) * height;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, width, height);

                // Draw curve
                if (curveData.length > 1) {
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 3;
                    ctx.beginPath();

                    curveData.forEach((point, index) => {
                        const x = (point.volume / 60) * width;
                        const y = height - (point.pH / 14) * height;

                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });

                    ctx.stroke();

                    // Draw current point
                    const lastPoint = curveData[curveData.length - 1];
                    const x = (lastPoint.volume / 60) * width;
                    const y = height - (lastPoint.pH / 14) * height;

                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // Draw buffer regions (if weak acid/base or polyprotic)
                if (currentTitration && (currentTitration.type === 'weak-strong' ||
                    currentTitration.type === 'strong-weak' ||
                    currentTitration.type === 'polyprotic-diprotic' ||
                    currentTitration.type === 'polyprotic-triprotic' ||
                    currentTitration.type === 'amino-acid')) {

                    ctx.fillStyle = 'rgba(255, 193, 7, 0.15)'; // Light yellow/orange for buffer region

                    if (currentTitration.type === 'weak-strong' || currentTitration.type === 'strong-weak') {
                        const pKa = currentTitration.pKa || currentTitration.pKa1;
                        if (pKa) {
                            const pKaY = height - (pKa / 14) * height;
                            const bufferTop = height - ((pKa + 1) / 14) * height;
                            const bufferBottom = height - ((pKa - 1) / 14) * height;
                            ctx.fillRect(0, bufferTop, width, bufferBottom - bufferTop);

                            // Draw pKa line
                            ctx.strokeStyle = '#f59e0b';
                            ctx.setLineDash([5, 5]);
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(0, pKaY);
                            ctx.lineTo(width, pKaY);
                            ctx.stroke();
                            ctx.setLineDash([]);

                            // Label pKa
                            ctx.fillStyle = '#f59e0b';
                            ctx.font = 'bold 12px sans-serif';
                            ctx.fillText(`pKa = ${pKa.toFixed(2)}`, width - 80, pKaY - 5);
                        }
                    } else if (currentTitration.type === 'polyprotic-diprotic' ||
                               currentTitration.type === 'amino-acid') {
                        // Draw two buffer regions
                        [currentTitration.pKa1, currentTitration.pKa2].forEach((pKa, idx) => {
                            if (pKa) {
                                const pKaY = height - (pKa / 14) * height;
                                const bufferTop = height - ((pKa + 1) / 14) * height;
                                const bufferBottom = height - ((pKa - 1) / 14) * height;
                                ctx.fillStyle = idx === 0 ? 'rgba(255, 193, 7, 0.15)' : 'rgba(147, 197, 253, 0.15)';
                                ctx.fillRect(0, bufferTop, width, bufferBottom - bufferTop);

                                // Draw pKa line
                                ctx.strokeStyle = idx === 0 ? '#f59e0b' : '#3b82f6';
                                ctx.setLineDash([5, 5]);
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(0, pKaY);
                                ctx.lineTo(width, pKaY);
                                ctx.stroke();
                                ctx.setLineDash([]);

                                // Label pKa
                                ctx.fillStyle = idx === 0 ? '#f59e0b' : '#3b82f6';
                                ctx.font = 'bold 11px sans-serif';
                                ctx.fillText(`pKa${idx + 1} = ${pKa.toFixed(2)}`, width - 85, pKaY - 5);
                            }
                        });
                    } else if (currentTitration.type === 'polyprotic-triprotic') {
                        // Draw three buffer regions
                        [currentTitration.pKa1, currentTitration.pKa2, currentTitration.pKa3].forEach((pKa, idx) => {
                            if (pKa) {
                                const pKaY = height - (pKa / 14) * height;
                                const bufferTop = height - ((pKa + 1) / 14) * height;
                                const bufferBottom = height - ((pKa - 1) / 14) * height;
                                const colors = ['rgba(255, 193, 7, 0.15)', 'rgba(147, 197, 253, 0.15)', 'rgba(134, 239, 172, 0.15)'];
                                ctx.fillStyle = colors[idx];
                                ctx.fillRect(0, bufferTop, width, bufferBottom - bufferTop);

                                // Draw pKa line
                                const lineColors = ['#f59e0b', '#3b82f6', '#22c55e'];
                                ctx.strokeStyle = lineColors[idx];
                                ctx.setLineDash([5, 5]);
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(0, pKaY);
                                ctx.lineTo(width, pKaY);
                                ctx.stroke();
                                ctx.setLineDash([]);

                                // Label pKa
                                ctx.fillStyle = lineColors[idx];
                                ctx.font = 'bold 11px sans-serif';
                                ctx.fillText(`pKa${idx + 1} = ${pKa.toFixed(2)}`, width - 85, pKaY - 5);
                            }
                        });
                    }
                }

                // Draw half-equivalence point markers
                if (currentTitration && curveData.length > 5) {
                    if (currentTitration.halfEquivalencePH) {
                        const halfEqVol = (currentTitration.equivalenceVolume || currentTitration.equivalenceVolumes?.[0]) / 2;
                        const halfEqX = (halfEqVol / 60) * width;
                        const halfEqY = height - (currentTitration.halfEquivalencePH / 14) * height;

                        ctx.fillStyle = '#f59e0b';
                        ctx.font = 'bold 18px sans-serif';
                        ctx.fillText('◆', halfEqX - 7, halfEqY + 6);
                    } else if (currentTitration.halfEquivalencePHs) {
                        currentTitration.halfEquivalencePHs.forEach((halfPH, idx) => {
                            const eqVols = currentTitration.equivalenceVolumes;
                            let halfEqVol;
                            if (idx === 0) {
                                halfEqVol = eqVols[0] / 2;
                            } else {
                                halfEqVol = (eqVols[idx - 1] + eqVols[idx]) / 2;
                            }
                            const halfEqX = (halfEqVol / 60) * width;
                            const halfEqY = height - (halfPH / 14) * height;

                            const colors = ['#f59e0b', '#3b82f6', '#22c55e'];
                            ctx.fillStyle = colors[idx] || '#f59e0b';
                            ctx.font = 'bold 18px sans-serif';
                            ctx.fillText('◆', halfEqX - 7, halfEqY + 6);
                        });
                    }
                }

                // Draw equivalence point marker(s) (if feedback shown)
                if (feedback && currentTitration) {
                    if (currentTitration.equivalenceVolume) {
                        // Single equivalence point
                        const eqX = (currentTitration.equivalenceVolume / 60) * width;
                        const eqY = height - (currentTitration.equivalencePH / 14) * height;

                        ctx.fillStyle = '#22c55e';
                        ctx.font = 'bold 20px sans-serif';
                        ctx.fillText('⭐', eqX - 10, eqY + 5);
                    } else if (currentTitration.equivalenceVolumes) {
                        // Multiple equivalence points (polyprotic or amino acid)
                        currentTitration.equivalenceVolumes.forEach((eqVol, idx) => {
                            const eqX = (eqVol / 60) * width;
                            const eqY = height - (currentTitration.equivalencePHs[idx] / 14) * height;

                            const colors = ['#22c55e', '#3b82f6', '#f59e0b'];
                            ctx.fillStyle = colors[idx] || '#22c55e';
                            ctx.font = 'bold 20px sans-serif';
                            ctx.fillText('⭐', eqX - 10, eqY + 5);
                        });
                    }
                }

                // Draw axis labels
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 12px sans-serif';

                // X-axis label
                ctx.fillText('Rúmmál bætt við (mL)', width / 2 - 70, height - 5);

                // Y-axis label
                ctx.save();
                ctx.translate(15, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('pH', 0, 0);
                ctx.restore();

                // pH scale numbers
                for (let i = 0; i <= 14; i += 2) {
                    const y = height - (i / 14) * height;
                    ctx.fillText(i.toString(), 5, y + 4);
                }

                // Volume scale numbers
                for (let i = 0; i <= 60; i += 10) {
                    const x = (i / 60) * width;
                    ctx.fillText(i.toString(), x - 5, height - 20);
                }
            }, [curveData, feedback, currentTitration]);

            // Render different screens
            if (screen === 'menu') {
                return (
                    <div className="max-w-6xl mx-auto px-4 py-8">
                        <div className="bg-white rounded-xl shadow-lg p-8">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold mb-4" style={{ color: 'var(--kvenno-orange)' }}>
                                    pH Þéttigreining Meistari
                                </h1>
                                <p className="text-lg text-gray-600 mb-4">
                                    Læðu að framkvæma sýru-basa þéttigreiningar og túlka pH ferla
                                </p>
                                {/* Progress Stats */}
                                {(highScore > 0 || totalTitrations > 0) && (
                                    <div className="flex justify-center gap-6 text-sm">
                                        <div className="bg-yellow-50 px-4 py-2 rounded-lg border border-yellow-200">
                                            <span className="font-bold text-yellow-800">🏆 Hæsta stig: {highScore}</span>
                                        </div>
                                        <div className="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                                            <span className="font-bold text-blue-800">🧪 Fjöldi þéttigr.: {totalTitrations}</span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="grid md:grid-cols-2 gap-6 mb-8">
                                <div className="bg-blue-50 p-6 rounded-lg border-2 border-blue-200">
                                    <h2 className="text-2xl font-bold mb-3 text-blue-900">Æfingahamur</h2>
                                    <p className="text-gray-700 mb-4">
                                        • Engin tímatakmörk<br/>
                                        • Sjá pH stöðugt<br/>
                                        • Ítarlegar útskýringar<br/>
                                        • Henderson-Hasselbalch greining<br/>
                                        • Vísbendingar í boði
                                    </p>
                                    <button
                                        onClick={() => startNewTitration('practice')}
                                        className="w-full py-3 px-6 rounded-lg font-bold text-white transition hover:opacity-90"
                                        style={{ background: 'var(--kvenno-orange)' }}
                                    >
                                        Byrja að Æfa
                                    </button>
                                </div>

                                <div className="bg-orange-50 p-6 rounded-lg border-2 border-orange-200">
                                    <h2 className="text-2xl font-bold mb-3 text-orange-900">Keppnishamur</h2>
                                    <p className="text-gray-700 mb-4">
                                        • Takmörkuð viðbót<br/>
                                        • Tíma bónus<br/>
                                        • Stigatafla<br/>
                                        • Nákvæmni skipta máli<br/>
                                        • Hraða keppni
                                    </p>
                                    <button
                                        onClick={() => startNewTitration('challenge')}
                                        className="w-full py-3 px-6 rounded-lg font-bold text-white transition hover:opacity-90"
                                        style={{ background: 'var(--kvenno-orange-dark)' }}
                                    >
                                        Byrja Keppni
                                    </button>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6 mb-8">
                                <div className="p-6 bg-gray-50 rounded-lg">
                                    <h3 className="text-xl font-bold mb-3 text-gray-800">📚 Gerðir Þéttigreininga:</h3>
                                    <div className="text-sm text-gray-700 space-y-2">
                                        <div className="bg-white p-3 rounded border-l-4 border-green-500">
                                            <strong>Sterk-Sterk:</strong> HCl + NaOH → pH = 7.00 við jafngildi
                                        </div>
                                        <div className="bg-white p-3 rounded border-l-4 border-blue-500">
                                            <strong>Veik-Sterk:</strong> CH₃COOH + NaOH → pH &gt; 7 við jafngildi (buffer svæði)
                                        </div>
                                        <div className="bg-white p-3 rounded border-l-4 border-purple-500">
                                            <strong>Fjölprótón:</strong> H₃PO₄ → 3 jafngildistaðir, 3 pKa gildi
                                        </div>
                                        <div className="bg-white p-3 rounded border-l-4 border-yellow-500">
                                            <strong>Amínósýrur:</strong> Glycine → tvíeiginleiki, isoelectrisk punktur
                                        </div>
                                    </div>
                                </div>

                                <div className="p-6 bg-gray-50 rounded-lg">
                                    <h3 className="text-xl font-bold mb-3 text-gray-800">🌍 Raunveruleg Notkun:</h3>
                                    <div className="text-sm text-gray-700 space-y-2">
                                        <div className="bg-white p-2 rounded">
                                            <strong>🏭 Iðnaður:</strong> Brennisteinssýru framleiðsla, vatnshreinsun
                                        </div>
                                        <div className="bg-white p-2 rounded">
                                            <strong>🏥 Læknisfræði:</strong> Blóð pH mælingar, æðadropar (IV)
                                        </div>
                                        <div className="bg-white p-2 rounded">
                                            <strong>🌊 Umhverfi:</strong> Súrt regn, súrnun sjávar, jarðvegsgreining
                                        </div>
                                        <div className="bg-white p-2 rounded">
                                            <strong>🍷 Matvæli:</strong> Víngerð, ostaframleiðsla, gerjun
                                        </div>
                                        <div className="bg-white p-2 rounded">
                                            <strong>⚗️ Rannsóknir:</strong> Einangrun próteina, ensím uppskrift
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-2 border-blue-200 mb-8">
                                <h3 className="text-xl font-bold mb-3 text-gray-800">🎯 Það sem þú lærir:</h3>
                                <div className="grid md:grid-cols-3 gap-4 text-sm text-gray-700">
                                    <div>
                                        <strong className="text-blue-800">Útreikningar:</strong>
                                        <ul className="mt-1 ml-4 list-disc">
                                            <li>Henderson-Hasselbalch</li>
                                            <li>pH, pKa, Ka tengsl</li>
                                            <li>Mólatala útreikningar</li>
                                            <li>Buffer svæði</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <strong className="text-purple-800">Túlkun:</strong>
                                        <ul className="mt-1 ml-4 list-disc">
                                            <li>Þéttigreiningarferlar</li>
                                            <li>Jafngildistaðir</li>
                                            <li>Hálf-jafngildi punktar</li>
                                            <li>Litskipti val</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <strong className="text-green-800">Verkleg færni:</strong>
                                        <ul className="mt-1 ml-4 list-disc">
                                            <li>Buretta notkun</li>
                                            <li>pH mælingar</li>
                                            <li>Nákvæmni og villur</li>
                                            <li>Gagnaskráning</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div className="p-6 bg-gray-50 rounded-lg">
                                <h3 className="text-xl font-bold mb-3">💡 Hvernig á að spila:</h3>
                                <ol className="text-left text-gray-700 space-y-2">
                                    <li><strong>1.</strong> Veldu litskipti (indicator) fyrir þéttigreininguna</li>
                                    <li><strong>2.</strong> Bættu við þéttiefni úr burettu í skrefum (5 mL, 1 mL, eða 0.1 mL)</li>
                                    <li><strong>3.</strong> Fylgstu með pH breytingum og lit lausnarinnar í kólfunni</li>
                                    <li><strong>4.</strong> Notaðu flýtilykla: <kbd className="px-2 py-1 bg-white border rounded text-xs">Space</kbd> fyrir 0.1 mL, <kbd className="px-2 py-1 bg-white border rounded text-xs">R</kbd> til að endurstilla</li>
                                    <li><strong>5.</strong> Reyndu að ná jafngildisstað eins nákvæmlega og mögulegt er (±0.05 mL fyrir hámarksstig!)</li>
                                    <li><strong>6.</strong> Túlkaðu ferilinn - sjáðu buffer svæði, pKa gildi, og jafngildistaði</li>
                                    <li><strong>7.</strong> Sæktu gögn þín (CSV) eða skýrslu fyrir frekari greiningu</li>
                                </ol>
                            </div>

                            <div className="mt-8 text-center text-sm text-gray-500">
                                <p>Nú með 30 þéttigreiningar! • Fjölprótón sýrur • Amínósýrur • Óþekktur styrkur</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'game' && currentTitration) {
                const solutionColor = getIndicatorColor(currentPH, selectedIndicator);
                const liquidHeight = Math.min((volumeAdded / 60) * 100, 100);
                const phColor = getPHColor(currentPH);

                return (
                    <div className="max-w-7xl mx-auto px-4 py-6">
                        {/* Header Info */}
                        <div className="bg-white rounded-lg shadow-md p-4 mb-6 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold" style={{ color: 'var(--kvenno-orange)' }}>
                                    {currentTitration.name}
                                </h2>
                                <p className="text-gray-600">
                                    {currentTitration.analyte.volume} mL × {currentTitration.analyte.molarity} M {currentTitration.analyte.formula} + {currentTitration.titrant.molarity} M {currentTitration.titrant.formula}
                                </p>
                            </div>
                            <div className="text-right">
                                <div className="text-sm text-gray-500">Stig: <span className="font-bold text-2xl" style={{ color: 'var(--kvenno-orange)' }}>{score}</span></div>
                                <div className="text-sm text-gray-500">Spurningar: {questionsAnswered}</div>
                            </div>
                        </div>

                        {/* Main Lab Area */}
                        <div className="grid lg:grid-cols-3 gap-6 mb-6">
                            {/* Left: Virtual Lab Equipment */}
                            <div className="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                                <div className="flex justify-around items-end mb-6" style={{ minHeight: '450px' }}>
                                    {/* Burette */}
                                    <div className="flex flex-col items-center">
                                        <h3 className="font-bold mb-2 text-gray-700">Buretta</h3>
                                        <div className="burette">
                                            <div className="burette-scale">
                                                <span>0</span>
                                                <span>10</span>
                                                <span>20</span>
                                                <span>30</span>
                                                <span>40</span>
                                                <span>50</span>
                                            </div>
                                            <div
                                                className="burette-liquid"
                                                style={{ height: `${100 - liquidHeight}%` }}
                                            />
                                        </div>
                                        <div className="mt-2 text-center">
                                            <div className="text-sm font-bold text-indigo-700">
                                                {volumeAdded.toFixed(1)} mL
                                            </div>
                                            {isAnimating && (
                                                <div className="text-blue-500 font-bold drip">💧</div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Flask */}
                                    <div className="flex flex-col items-center">
                                        <h3 className="font-bold mb-2 text-gray-700">Erlenmeyer Kólfur</h3>
                                        <div className={`erlenmeyer-flask ${isAnimating ? 'swirl' : ''}`}>
                                            <div className="flask-neck"></div>
                                            <div className="flask-body">
                                                <div
                                                    className="flask-solution"
                                                    style={{
                                                        height: '70%',
                                                        background: solutionColor === 'transparent'
                                                            ? 'rgba(200, 200, 255, 0.3)'
                                                            : solutionColor
                                                    }}
                                                />
                                            </div>
                                        </div>
                                        <div className="mt-2 text-sm text-gray-600">
                                            {currentTitration.analyte.volume} mL
                                        </div>
                                    </div>

                                    {/* pH Meter */}
                                    <div className="flex flex-col items-center">
                                        <h3 className="font-bold mb-2 text-gray-700">pH Mælir</h3>
                                        <div className="ph-meter">
                                            <div className="text-xs text-gray-400 text-center mb-2">pH METER</div>
                                            <div className="ph-display">
                                                <div
                                                    className="ph-value"
                                                    style={{ color: phColor }}
                                                >
                                                    {currentPH.toFixed(2)}
                                                </div>
                                                <div className="text-xs text-gray-400 mt-2">pH STIG</div>
                                            </div>
                                            <div className="ph-scale-indicator mt-4">
                                                <div
                                                    className="ph-marker"
                                                    style={{ left: `${(currentPH / 14) * 100}%` }}
                                                />
                                            </div>
                                            <div className="flex justify-between text-xs text-gray-400 mt-1">
                                                <span>0</span>
                                                <span>7</span>
                                                <span>14</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Controls */}
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2 text-gray-700">
                                            Litskipti / Indicator:
                                        </label>
                                        <select
                                            value={selectedIndicator}
                                            onChange={(e) => setSelectedIndicator(e.target.value)}
                                            className="w-full p-2 border-2 border-gray-300 rounded-lg"
                                            disabled={volumeAdded > 0}
                                        >
                                            {Object.entries(INDICATORS).map(([key, ind]) => (
                                                <option key={key} value={key}>
                                                    {ind.nameIs} (pH {ind.pHRange[0]}-{ind.pHRange[1]})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2 text-gray-700">
                                            Núverandi litskipti:
                                        </label>
                                        <div
                                            className="w-full h-10 rounded-lg border-2 border-gray-300"
                                            style={{
                                                background: solutionColor === 'transparent'
                                                    ? 'white'
                                                    : solutionColor
                                            }}
                                        />
                                    </div>
                                </div>

                                {/* Add Buttons */}
                                <div className="grid grid-cols-4 gap-3">
                                    <button
                                        onClick={() => addTitrant(5)}
                                        disabled={isAnimating || volumeAdded >= 60}
                                        className="py-3 px-4 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        + 5 mL
                                    </button>
                                    <button
                                        onClick={() => addTitrant(1)}
                                        disabled={isAnimating || volumeAdded >= 60}
                                        className="py-3 px-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        + 1 mL
                                    </button>
                                    <button
                                        onClick={() => addTitrant(0.1)}
                                        disabled={isAnimating || volumeAdded >= 60}
                                        className="py-3 px-4 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        + 0.1 mL
                                    </button>
                                    <button
                                        onClick={resetTitration}
                                        className="py-3 px-4 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600"
                                    >
                                        Endurstilla
                                    </button>
                                </div>

                                {/* Action Buttons */}
                                <div className="grid grid-cols-2 gap-3 mt-4">
                                    <button
                                        onClick={checkAnswer}
                                        className="py-3 px-6 rounded-lg font-bold text-white"
                                        style={{ background: 'var(--kvenno-orange)' }}
                                    >
                                        Athuga Svar
                                    </button>
                                    {gameMode === 'practice' && (
                                        <button
                                            onClick={() => setShowHint(!showHint)}
                                            className="py-3 px-6 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600"
                                        >
                                            {showHint ? 'Fela Vísbendingu' : 'Sýna Vísbendingu'}
                                        </button>
                                    )}
                                </div>

                                {/* Hint */}
                                {showHint && gameMode === 'practice' && (
                                    <div className="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                                        <p className="font-bold text-yellow-900">💡 Vísbending:</p>
                                        <p className="text-gray-700">
                                            Jafngildistaður er þegar mólar sýru = mólar basa. <br/>
                                            Fyrir {currentTitration.type === 'strong-strong' ? 'sterk-sterk' : 'veik-sterk'} þéttigreiningu,
                                            leitaðu að brattasta hluta ferlisins.
                                            {currentTitration.type !== 'strong-strong' && (
                                                <><br/>Hálf-jafngildistaður er þar sem pH = pKa = {currentTitration.pKa.toFixed(2)}</>
                                            )}
                                        </p>
                                    </div>
                                )}

                                {/* Feedback */}
                                {feedback && (
                                    <div className={`mt-4 p-4 rounded-lg ${feedback.isCorrect ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}`}>
                                        <p className={`font-bold text-lg ${feedback.isCorrect ? 'text-green-900' : 'text-red-900'}`}>
                                            {feedback.isCorrect ? '✓ Rétt!' : '✗ Ekki alveg rétt'}
                                        </p>
                                        <p className="text-gray-700 mt-2">{feedback.message}</p>
                                        <div className="mt-3 text-sm text-gray-600">
                                            <p>• Þitt rúmmál: {feedback.currentVolume} mL (pH {feedback.currentPH})</p>
                                            <p>• Jafngildistaður: {feedback.equivalenceVolume} mL (pH {feedback.equivalencePH})</p>
                                            <p>• Nákvæmni: ±{feedback.difference} mL</p>
                                            <p>• Tími: {feedback.timeElapsed} sekúndur</p>
                                            <p className="font-bold mt-2">Stig unnin: +{feedback.points}</p>
                                        </div>

                                        {/* Detailed Analysis */}
                                        {feedback.analysis && gameMode === 'practice' && (
                                            <div className="mt-4 p-3 bg-white rounded border-2 border-blue-200">
                                                <h4 className="font-bold text-blue-900 mb-2">📊 Ítarleg Greining:</h4>

                                                {/* Moles Calculation */}
                                                {feedback.analysis.moles && (
                                                    <div className="mb-3 text-sm">
                                                        <p className="font-semibold text-gray-700">Mólmagn:</p>
                                                        <p className="ml-3">• Sýra/Basi: {feedback.analysis.moles.analyte} mól</p>
                                                        <p className="ml-3">• Þéttiefni: {feedback.analysis.moles.titrant} mól</p>
                                                    </div>
                                                )}

                                                {/* Henderson-Hasselbalch */}
                                                {feedback.analysis.hendersonHasselbalch && (
                                                    <div className="mb-3 text-sm bg-yellow-50 p-2 rounded">
                                                        <p className="font-semibold text-gray-700">Henderson-Hasselbalch jafna:</p>
                                                        <p className="ml-3 font-mono text-xs mt-1">{feedback.analysis.hendersonHasselbalch.formula}</p>
                                                        <p className="ml-3 mt-1">• Hlutfall [A⁻]/[HA]: {feedback.analysis.hendersonHasselbalch.ratio}</p>
                                                        <p className="ml-3">• pKa: {feedback.analysis.hendersonHasselbalch.pKa}</p>
                                                    </div>
                                                )}

                                                {/* Equivalence Points */}
                                                {feedback.analysis.equivalencePoints.length > 0 && (
                                                    <div className="mb-3 text-sm">
                                                        <p className="font-semibold text-gray-700">Jafngildistaðir:</p>
                                                        {feedback.analysis.equivalencePoints.map((ep, idx) => (
                                                            <div key={idx} className="ml-3">
                                                                {ep.number && <span className="font-bold">Punktur {ep.number}: </span>}
                                                                <span>{ep.volume} mL (pH {ep.pH})</span>
                                                                {ep.halfEquivalencePH && (
                                                                    <span className="text-gray-500"> | Hálf-jafng.: pH {ep.halfEquivalencePH}</span>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                {/* Ka Calculation */}
                                                {feedback.analysis.kaCalculation && (
                                                    <div className="text-sm bg-green-50 p-2 rounded">
                                                        <p className="font-semibold text-gray-700">Ka útreikningur:</p>
                                                        <p className="ml-3">• pKa = {feedback.analysis.kaCalculation.pKa}</p>
                                                        <p className="ml-3">• Ka = {feedback.analysis.kaCalculation.Ka}</p>
                                                        <p className="ml-3 text-xs text-gray-600">{feedback.analysis.kaCalculation.explanation}</p>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        <button
                                            onClick={nextQuestion}
                                            className="mt-4 py-2 px-6 rounded-lg font-bold text-white"
                                            style={{ background: 'var(--kvenno-orange)' }}
                                        >
                                            Næsta Þéttigreining → (Enter)
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Right: Titration Curve */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Þéttigreiningarferill</h3>
                                <canvas
                                    ref={canvasRef}
                                    width={350}
                                    height={400}
                                    className="curve-canvas w-full"
                                />
                                <div className="mt-4 text-sm text-gray-600">
                                    <p><strong>Núverandi pH:</strong> {currentPH.toFixed(2)}</p>
                                    <p><strong>Rúmmál bætt við:</strong> {volumeAdded.toFixed(1)} mL</p>
                                    <p><strong>Erfiðleiki:</strong> {currentTitration.difficulty}</p>
                                </div>

                                {/* Export Buttons */}
                                {curveData.length > 1 && (
                                    <div className="mt-4 space-y-2">
                                        <button
                                            onClick={exportToCSV}
                                            className="w-full py-2 px-4 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700"
                                        >
                                            📊 Sækja gögn (CSV)
                                        </button>
                                        <button
                                            onClick={exportDetailedReport}
                                            className="w-full py-2 px-4 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700"
                                        >
                                            📄 Sækja skýrslu
                                        </button>
                                    </div>
                                )}

                                {/* Keyboard Shortcuts Reference */}
                                <div className="mt-4 p-3 bg-gray-50 rounded text-xs">
                                    <p className="font-bold text-gray-700 mb-2">⌨️ Flýtilyklar:</p>
                                    <div className="space-y-1 text-gray-600">
                                        <p>• <kbd className="px-2 py-1 bg-white border rounded">Space</kbd> / <kbd className="px-2 py-1 bg-white border rounded">↑</kbd> Bæta við 0.1 mL</p>
                                        <p>• <kbd className="px-2 py-1 bg-white border rounded">R</kbd> Endurstilla</p>
                                        <p>• <kbd className="px-2 py-1 bg-white border rounded">H</kbd> Vísbending (æfing)</p>
                                        <p>• <kbd className="px-2 py-1 bg-white border rounded">Enter</kbd> Athuga svar</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Back to Menu */}
                        <div className="text-center">
                            <button
                                onClick={() => setScreen('menu')}
                                className="py-2 px-6 border-2 rounded-lg font-bold"
                                style={{
                                    borderColor: 'var(--kvenno-orange)',
                                    color: 'var(--kvenno-orange)'
                                }}
                            >
                                ← Til baka á aðalvalmynd
                            </button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        // Render the app
        ReactDOM.render(<TitrationGame />, document.getElementById('root'));
    </script>
</body>
</html>
