<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lausnir - Kvenno Efnafr√¶√∞i</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --kvenno-orange: #f36b22;
            --kvenno-orange-dark: #d95a1a;
            --practice-green: #10b981;
            --practice-green-dark: #059669;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #f9fafb;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .site-header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 768px) {
            .site-header {
                position: sticky;
                top: 0;
                z-index: 1000;
            }
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-logo {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--kvenno-orange);
            text-decoration: none;
        }

        .site-logo:hover {
            color: var(--kvenno-orange-dark);
        }

        .header-btn {
            background: white;
            border: 2px solid var(--kvenno-orange);
            color: var(--kvenno-orange);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }

        .header-btn:hover {
            background: var(--kvenno-orange);
            color: white;
        }

        .breadcrumb {
            color: #6b7280;
            font-size: 0.875rem;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .breadcrumb a {
            color: var(--kvenno-orange);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .back-btn {
            background: white;
            border: 2px solid var(--kvenno-orange);
            color: var(--kvenno-orange);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
            margin: 1rem;
            min-height: 48px;
            min-width: 48px;
        }

        .back-btn:hover {
            background: var(--kvenno-orange);
            color: white;
        }

        /* Beaker SVG Styles */
        .beaker-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .beaker {
            position: relative;
            display: inline-block;
        }

        .solution-fill {
            transition: all 1.5s ease-in-out;
        }

        .pour-animation {
            animation: pour 2s ease-in-out;
        }

        @keyframes pour {
            0% { transform: translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .mix-animation {
            animation: mix 2s ease-in-out;
        }

        @keyframes mix {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .dissolve-animation {
            animation: dissolve 2s ease-in-out;
        }

        @keyframes dissolve {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Streak flame animation */
        .streak-flame {
            display: inline-block;
            animation: flicker 1s ease-in-out infinite;
        }

        @keyframes flicker {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }

        /* Input validation styles */
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fee2e2;
        }

        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        /* Step-by-step solution styles */
        .solution-step {
            background: #f3f4f6;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid var(--kvenno-orange);
            border-radius: 0.5rem;
        }

        .solution-step h4 {
            color: var(--kvenno-orange);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* Touch targets for mobile */
        @media (max-width: 768px) {
            button, input, a {
                min-height: 48px;
                min-width: 48px;
            }
        }

        /* Formula reference card */
        .formula-card {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border: 2px solid var(--kvenno-orange);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .formula-card {
                position: relative;
                top: 0;
                right: 0;
                margin: 1rem auto;
            }
        }

        /* Timer styles */
        .timer-warning {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Accessibility - focus indicators */
        button:focus,
        input:focus,
        a:focus {
            outline: 3px solid var(--kvenno-orange);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .beaker-container svg {
                filter: contrast(1.5);
            }
        }

        /* Calculation workspace */
        .calc-workspace {
            background: #fef3c7;
            border: 2px dashed #f59e0b;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .calc-input {
            border: 2px solid #f59e0b;
            border-radius: 6px;
            padding: 0.5rem;
            margin: 0.25rem 0;
            width: 100%;
        }

        .calc-result-correct {
            background: #d1fae5;
            color: #065f46;
        }

        .calc-result-close {
            background: #fef3c7;
            color: #92400e;
        }

        .calc-result-far {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <a href="/" class="site-logo">Kvenno Efnafr√¶√∞i</a>
            <div>
                <button class="header-btn" onclick="alert('Admin a√∞gangur kemur flj√≥tlega')">Admin</button>
                <button class="header-btn" onclick="alert('Uppl√Ωsingar um leiki og notkun')">Info</button>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="/">Heim</a> &gt; <a href="/1-ar/">1. √°r</a> &gt; <a href="/1-ar/games/">Leikir</a> &gt; Lausnir
    </div>

    <!-- Back button -->
    <a href="/1-ar/games/" class="back-btn">‚Üê Til baka</a>

    <!-- React App Container -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Real chemicals database for 1st year students
        const CHEMICALS = {
            simple: [
                { name: 'NaCl', molarMass: 58.5, displayName: 'NaCl (bor√∞salt)' },
                { name: 'gl√∫k√≥sa', formula: 'C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ', molarMass: 180, displayName: 'gl√∫k√≥sa (C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ)' },
                { name: 'H‚ÇÇO‚ÇÇ', molarMass: 34, displayName: 'H‚ÇÇO‚ÇÇ (vetursperox√≠√∞)' }
            ],
            medium: [
                { name: 'NaOH', molarMass: 40, displayName: 'NaOH (natr√≠umh√Ωdrox√≠√∞)' },
                { name: 'CaCl‚ÇÇ', molarMass: 111, displayName: 'CaCl‚ÇÇ (kals√≠umkl√≥r√≠√∞)' },
                { name: 'HCl', molarMass: 36.5, displayName: 'HCl (salts√Ωra)' }
            ],
            hard: [
                { name: 'KNO‚ÇÉ', molarMass: 101, displayName: 'KNO‚ÇÉ (kal√≠umnitrat)' },
                { name: 'MgSO‚ÇÑ', molarMass: 120, displayName: 'MgSO‚ÇÑ (magnes√≠ums√∫lfat)' },
                { name: 'H‚ÇÇSO‚ÇÑ', molarMass: 98, displayName: 'H‚ÇÇSO‚ÇÑ (brennisteinss√Ωra)' }
            ]
        };

        // Chemistry facts for students
        const CHEMISTRY_FACTS = [
            'Bl√≥√∞ er u.√æ.b. 0.15 M NaCl lausn (isotonic)',
            'Vi√∞ notum m√≥lstyrk vegna √æess a√∞ hann segir okkur fj√∂lda sameinda',
            '√ûegar √æ√∫ √æynnir s√Ωru, b√¶ttu alltaf s√Ωru vi√∞ vatn - aldrei √∂fugt!',
            '1 M gl√∫k√≥sa lausn er s√¶t - um 180 g gl√∫k√≥si √° l√≠tra!',
            'Vatnssameindir eru p√≥lskar og leysa j√≥natengi vel',
            'M√≥lstyrkur segir til um hversu margar m√≥l eru √≠ einum l√≠tra',
            '1 m√≥l inniheldur 6.022 √ó 10¬≤¬≥ sameindir (Avogadros tala)'
        ];

        // Beaker SVG Component
        const Beaker = ({ volume, maxVolume = 500, concentration, color = '#3b82f6', label, animate = false, animationType = 'fill' }) => {
            const height = 200;
            const width = 120;
            const fillHeight = (volume / maxVolume) * 150;

            // Calculate color intensity based on concentration
            const getColorIntensity = (conc) => {
                if (!conc) return color;
                const intensity = Math.min(Math.max(conc / 5, 0.2), 1);
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                const lightness = 1 - (intensity * 0.7);
                return `rgb(${Math.round(r * lightness)}, ${Math.round(g * lightness)}, ${Math.round(b * lightness)})`;
            };

            return (
                <div className="beaker" style={{ textAlign: 'center' }}>
                    <svg width={width} height={height} viewBox={`0 0 ${width} ${height}`}>
                        {/* Beaker outline */}
                        <path
                            d={`M 20 20 L 20 170 L 30 180 L 90 180 L 100 170 L 100 20`}
                            fill="none"
                            stroke="#4b5563"
                            strokeWidth="2"
                        />

                        {/* Graduation marks */}
                        {[100, 200, 300, 400, 500].map(vol => {
                            const y = 180 - (vol / maxVolume) * 150;
                            return (
                                <g key={vol}>
                                    <line x1="20" y1={y} x2="15" y2={y} stroke="#6b7280" strokeWidth="1" />
                                    <text x="10" y={y + 3} fontSize="8" fill="#6b7280" textAnchor="end">{vol}</text>
                                </g>
                            );
                        })}

                        {/* Solution fill */}
                        <path
                            className={animate ? `${animationType}-animation` : ''}
                            d={`M 21 ${180 - fillHeight} L 21 169 L 30 179 L 90 179 L 99 169 L 99 ${180 - fillHeight} Z`}
                            fill={getColorIntensity(concentration)}
                            opacity="0.8"
                        />

                        {/* Meniscus (wavy line) */}
                        {fillHeight > 0 && (
                            <path
                                d={`M 21 ${180 - fillHeight} Q 35 ${180 - fillHeight - 2} 60 ${180 - fillHeight} T 99 ${180 - fillHeight}`}
                                fill="none"
                                stroke={getColorIntensity(concentration)}
                                strokeWidth="1.5"
                                opacity="0.6"
                            />
                        )}
                    </svg>
                    {label && (
                        <div className="text-sm mt-2 font-semibold text-gray-700">
                            {label}
                        </div>
                    )}
                </div>
            );
        };

        // Visual representation for different problem types
        const BeakerVisualization = ({ problem, animate }) => {
            if (!problem) return null;

            if (problem.type === 'dilution') {
                return (
                    <div className="beaker-container" role="img" aria-label={`√öt√æynning: ${problem.given.M1} M lausn √æynnt ni√∞ur √≠ ${problem.answer} M`}>
                        <Beaker
                            volume={problem.given.V1}
                            concentration={problem.given.M1}
                            label={`M‚ÇÅ = ${problem.given.M1} M\nV‚ÇÅ = ${problem.given.V1} mL`}
                            color="#f97316"
                        />
                        <div className="text-4xl self-center">‚Üí</div>
                        <Beaker
                            volume={problem.given.V2}
                            concentration={problem.answer}
                            label={`M‚ÇÇ = ${problem.answer.toFixed(3)} M\nV‚ÇÇ = ${problem.given.V2} mL`}
                            color="#f97316"
                            animate={animate}
                            animationType="pour"
                        />
                    </div>
                );
            } else if (problem.type === 'molarity' || problem.type === 'molarityFromMass' || problem.type === 'massFromMolarity') {
                return (
                    <div className="beaker-container" role="img" aria-label={`M√≥lstyrkur: ${problem.answer.toFixed(3)} M lausn`}>
                        <Beaker
                            volume={problem.given.volumeInML || problem.given.volume * 1000}
                            concentration={problem.answer}
                            label={`M = ${problem.answer.toFixed(3)} M`}
                            color="#3b82f6"
                            animate={animate}
                            animationType="dissolve"
                        />
                    </div>
                );
            } else if (problem.type === 'mixing') {
                return (
                    <div className="beaker-container" role="img" aria-label={`Bl√∂ndun tveggja lausna: ${problem.answer.toFixed(3)} M`}>
                        <Beaker
                            volume={problem.given.V1}
                            concentration={problem.given.M1}
                            label={`M‚ÇÅ = ${problem.given.M1} M\nV‚ÇÅ = ${problem.given.V1} mL`}
                            color="#3b82f6"
                        />
                        <div className="text-2xl self-center">+</div>
                        <Beaker
                            volume={problem.given.V2}
                            concentration={problem.given.M2}
                            label={`M‚ÇÇ = ${problem.given.M2} M\nV‚ÇÇ = ${problem.given.V2} mL`}
                            color="#ec4899"
                        />
                        <div className="text-4xl self-center">‚Üí</div>
                        <Beaker
                            volume={problem.given.V1 + problem.given.V2}
                            concentration={problem.answer}
                            label={`M = ${problem.answer.toFixed(3)} M\nV = ${problem.given.V1 + problem.given.V2} mL`}
                            color="#8b5cf6"
                            animate={animate}
                            animationType="mix"
                        />
                    </div>
                );
            }

            return null;
        };

        // Step-by-step solution component
        const StepBySolution = ({ problem }) => {
            if (!problem) return null;

            if (problem.type === 'dilution') {
                return (
                    <div className="mt-4 space-y-2">
                        <h3 className="text-lg font-bold text-gray-800">Lausn me√∞ skrefum:</h3>
                        <div className="solution-step">
                            <h4>Gefi√∞:</h4>
                            <p>M‚ÇÅ = {problem.given.M1} M</p>
                            <p>V‚ÇÅ = {problem.given.V1} mL</p>
                            <p>V‚ÇÇ = {problem.given.V2} mL</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 1: Velja form√∫lu</h4>
                            <p>M‚ÇÅV‚ÇÅ = M‚ÇÇV‚ÇÇ (√∫t√æynningarform√∫la)</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 2: Setja inn gildi</h4>
                            <p>({problem.given.M1} M)({problem.given.V1} mL) = M‚ÇÇ({problem.given.V2} mL)</p>
                            <p>{problem.given.M1 * problem.given.V1} = M‚ÇÇ({problem.given.V2})</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 3: Einangra M‚ÇÇ</h4>
                            <p>M‚ÇÇ = {problem.given.M1 * problem.given.V1} √∑ {problem.given.V2}</p>
                            <p>M‚ÇÇ = {problem.answer.toFixed(3)} M</p>
                        </div>
                        <div className="solution-step">
                            <h4>Svar: {problem.answer.toFixed(3)} M</h4>
                        </div>
                    </div>
                );
            } else if (problem.type === 'molarity') {
                return (
                    <div className="mt-4 space-y-2">
                        <h3 className="text-lg font-bold text-gray-800">Lausn me√∞ skrefum:</h3>
                        <div className="solution-step">
                            <h4>Gefi√∞:</h4>
                            <p>m√≥l = {problem.given.moles} mol</p>
                            <p>r√∫mm√°l = {problem.given.volume} L</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 1: Velja form√∫lu</h4>
                            <p>M = m√≥l √∑ L</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 2: Setja inn gildi</h4>
                            <p>M = {problem.given.moles} mol √∑ {problem.given.volume} L</p>
                            <p>M = {problem.answer.toFixed(3)} M</p>
                        </div>
                        <div className="solution-step">
                            <h4>Svar: {problem.answer.toFixed(3)} M</h4>
                        </div>
                    </div>
                );
            } else if (problem.type === 'molarityFromMass') {
                return (
                    <div className="mt-4 space-y-2">
                        <h3 className="text-lg font-bold text-gray-800">Lausn me√∞ skrefum:</h3>
                        <div className="solution-step">
                            <h4>Gefi√∞:</h4>
                            <p>massi = {problem.given.massInGrams} g {problem.chemical?.name || ''}</p>
                            <p>m√≥l√æyngd = {problem.given.molarMass} g/mol</p>
                            <p>r√∫mm√°l = {problem.given.volumeInML} mL</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 1: Breyta mL √≠ L</h4>
                            <p>{problem.given.volumeInML} mL = {problem.given.volumeInML} √∑ 1000 = {(problem.given.volumeInML / 1000).toFixed(3)} L</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 2: Reikna m√≥l</h4>
                            <p>m√≥l = massi √∑ m√≥l√æyngd</p>
                            <p>m√≥l = {problem.given.massInGrams} g √∑ {problem.given.molarMass} g/mol</p>
                            <p>m√≥l = {(problem.given.massInGrams / problem.given.molarMass).toFixed(3)} mol</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 3: Reikna m√≥lstyrk</h4>
                            <p>M = m√≥l √∑ l√≠trar</p>
                            <p>M = {(problem.given.massInGrams / problem.given.molarMass).toFixed(3)} mol √∑ {(problem.given.volumeInML / 1000).toFixed(3)} L</p>
                            <p>M = {problem.answer.toFixed(3)} M</p>
                        </div>
                        <div className="solution-step">
                            <h4>Svar: {problem.answer.toFixed(3)} M</h4>
                        </div>
                    </div>
                );
            } else if (problem.type === 'mixing') {
                const moles1 = (problem.given.M1 * problem.given.V1 / 1000).toFixed(3);
                const moles2 = (problem.given.M2 * problem.given.V2 / 1000).toFixed(3);
                const totalMoles = (parseFloat(moles1) + parseFloat(moles2)).toFixed(3);
                const totalVolume = ((problem.given.V1 + problem.given.V2) / 1000).toFixed(3);

                return (
                    <div className="mt-4 space-y-2">
                        <h3 className="text-lg font-bold text-gray-800">Lausn me√∞ skrefum:</h3>
                        <div className="solution-step">
                            <h4>Gefi√∞:</h4>
                            <p>Lausn 1: M‚ÇÅ = {problem.given.M1} M, V‚ÇÅ = {problem.given.V1} mL</p>
                            <p>Lausn 2: M‚ÇÇ = {problem.given.M2} M, V‚ÇÇ = {problem.given.V2} mL</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 1: Reikna heildarm√≥l</h4>
                            <p>m√≥l‚ÇÅ = M‚ÇÅ √ó V‚ÇÅ = {problem.given.M1} M √ó {(problem.given.V1/1000).toFixed(3)} L = {moles1} mol</p>
                            <p>m√≥l‚ÇÇ = M‚ÇÇ √ó V‚ÇÇ = {problem.given.M2} M √ó {(problem.given.V2/1000).toFixed(3)} L = {moles2} mol</p>
                            <p>m√≥l_alls = {moles1} + {moles2} = {totalMoles} mol</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 2: Reikna heildarr√∫mm√°l</h4>
                            <p>V_alls = V‚ÇÅ + V‚ÇÇ = {problem.given.V1} + {problem.given.V2} = {problem.given.V1 + problem.given.V2} mL = {totalVolume} L</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 3: Reikna endanlegan m√≥lstyrk</h4>
                            <p>M_lokal = m√≥l_alls √∑ V_alls</p>
                            <p>M_lokal = {totalMoles} mol √∑ {totalVolume} L</p>
                            <p>M_lokal = {problem.answer.toFixed(3)} M</p>
                        </div>
                        <div className="solution-step">
                            <h4>Svar: {problem.answer.toFixed(3)} M</h4>
                        </div>
                    </div>
                );
            } else if (problem.type === 'massFromMolarity') {
                const moles = (problem.given.molarity * problem.given.volumeInML / 1000).toFixed(3);
                return (
                    <div className="mt-4 space-y-2">
                        <h3 className="text-lg font-bold text-gray-800">Lausn me√∞ skrefum:</h3>
                        <div className="solution-step">
                            <h4>Gefi√∞:</h4>
                            <p>M = {problem.given.molarity} M</p>
                            <p>V = {problem.given.volumeInML} mL</p>
                            <p>m√≥l√æyngd = {problem.given.molarMass} g/mol</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 1: Breyta mL √≠ L</h4>
                            <p>{problem.given.volumeInML} mL = {(problem.given.volumeInML / 1000).toFixed(3)} L</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 2: Reikna m√≥l</h4>
                            <p>m√≥l = M √ó L</p>
                            <p>m√≥l = {problem.given.molarity} M √ó {(problem.given.volumeInML / 1000).toFixed(3)} L</p>
                            <p>m√≥l = {moles} mol</p>
                        </div>
                        <div className="solution-step">
                            <h4>Skref 3: Reikna massa</h4>
                            <p>massi = m√≥l √ó m√≥l√æyngd</p>
                            <p>massi = {moles} mol √ó {problem.given.molarMass} g/mol</p>
                            <p>massi = {problem.answer.toFixed(1)} g</p>
                        </div>
                        <div className="solution-step">
                            <h4>Svar: {problem.answer.toFixed(1)} g</h4>
                        </div>
                    </div>
                );
            }

            return null;
        };

        // Main game component
        const SolutionLab = () => {
            const [gameState, setGameState] = useState({
                currentProblem: null,
                userAnswer: '',
                score: 0,
                questionsAnswered: 0,
                correctAnswers: 0,
                isPlaying: false,
                gameOver: false,
                difficulty: 'easy',
                showFeedback: false,
                lastAnswerCorrect: null,
                showHint: false,
                hintLevel: 0,
                problemsCompleted: 0,
                totalProblems: 10,
                streak: 0,
                bestStreak: 0,
                incorrectAttempts: 0,
                showSolution: false,
                gameMode: 'competition', // 'competition' or 'practice'
                showFormulaCard: false,
                showWorkspace: false,
                workspaceValues: {},
                timerMode: false,
                timeRemaining: 90,
                soundEnabled: false,
                showBeakers: true,
                inputError: null,
                achievementShown: null
            });

            const [showInstructions, setShowInstructions] = useState(true);
            const [animateBeakers, setAnimateBeakers] = useState(false);
            const [currentFact, setCurrentFact] = useState(null);
            const inputRef = useRef(null);
            const timerRef = useRef(null);

            // localStorage helpers with try-catch
            const getStats = useCallback(() => {
                try {
                    const stats = localStorage.getItem('lausnir_stats');
                    return stats ? JSON.parse(stats) : {
                        gamesPlayed: 0,
                        totalCorrect: 0,
                        byType: {},
                        byDifficulty: {},
                        bestStreak: 0,
                        commonMistakes: {},
                        formulasMastered: []
                    };
                } catch (e) {
                    console.error('Error reading stats:', e);
                    return {};
                }
            }, []);

            const saveStats = useCallback((stats) => {
                try {
                    localStorage.setItem('lausnir_stats', JSON.stringify(stats));
                } catch (e) {
                    console.error('Error saving stats:', e);
                }
            }, []);

            // Generate problems with real chemicals
            const generateProblem = useCallback((difficulty) => {
                const problemTypes = ['dilution', 'molarity', 'mixing', 'molarityFromMass', 'massFromMolarity', 'unitConversion'];
                const availableTypes = difficulty === 'easy' ?
                    ['dilution', 'molarity', 'molarityFromMass'] :
                    problemTypes.filter(t => t !== 'unitConversion' || difficulty === 'medium');

                const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];

                // Get appropriate chemical
                const chemicalSet = difficulty === 'easy' ? CHEMICALS.simple :
                                   difficulty === 'medium' ? CHEMICALS.medium : CHEMICALS.hard;
                const chemical = chemicalSet[Math.floor(Math.random() * chemicalSet.length)];

                if (type === 'dilution') {
                    if (difficulty === 'easy') {
                        const M1 = Math.round(Math.random() * 4 + 1);
                        const V1 = Math.round(Math.random() * 90 + 10);
                        const V2 = Math.round(Math.random() * 400 + 100);
                        const M2 = parseFloat(((M1 * V1) / V2).toFixed(3));

                        return {
                            id: Math.random().toString(),
                            type: 'dilution',
                            chemical,
                            description: '√öt√æynning',
                            given: { M1, V1, V2 },
                            question: `√û√∫ ert me√∞ ${V1} mL af ${M1} M ${chemical.name} lausn. √û√∫ b√¶tir vi√∞ vatni √æannig a√∞ endanlegt r√∫mm√°l ver√∞ur ${V2} mL. Hver er endanlegur m√≥lstyrkur?`,
                            answer: M2,
                            unit: 'M',
                            difficulty: 'easy',
                            hints: [
                                'Nota√∞u M‚ÇÅV‚ÇÅ = M‚ÇÇV‚ÇÇ',
                                `M‚ÇÇ = (M‚ÇÅ √ó V‚ÇÅ) / V‚ÇÇ = (${M1} √ó ${V1}) / ${V2}`,
                                `M‚ÇÇ = ${M2.toFixed(3)} M`
                            ]
                        };
                    } else {
                        const M1 = parseFloat((Math.random() * 4.5 + 0.5).toFixed(2));
                        const V1 = Math.round(Math.random() * 45 + 5);
                        const V2 = Math.round(Math.random() * 450 + 50);
                        const M2 = parseFloat(((M1 * V1) / V2).toFixed(4));

                        return {
                            id: Math.random().toString(),
                            type: 'dilution',
                            chemical,
                            description: 'N√°kv√¶m √∫t√æynning',
                            given: { M1, V1, V2 },
                            question: `√û√∫ √æarft a√∞ √∫tb√∫a ${V2} mL af ${M2.toFixed(3)} M ${chemical.name} lausn me√∞ √æv√≠ a√∞ √æynna ${M1} M stofnlausn. Hversu miki√∞ √æarftu af stofnlausninni?`,
                            answer: V1,
                            unit: 'mL',
                            difficulty: difficulty,
                            hints: [
                                'V‚ÇÅ = (M‚ÇÇ √ó V‚ÇÇ) / M‚ÇÅ',
                                `V‚ÇÅ = (${M2.toFixed(3)} √ó ${V2}) / ${M1}`,
                                `V‚ÇÅ = ${V1} mL`
                            ]
                        };
                    }
                } else if (type === 'molarity') {
                    const moles = parseFloat((Math.random() * 1.9 + 0.1).toFixed(2));
                    const volume = parseFloat((Math.random() * 0.9 + 0.1).toFixed(2));
                    const molarity = parseFloat((moles / volume).toFixed(3));

                    return {
                        id: Math.random().toString(),
                        type: 'molarity',
                        chemical,
                        description: 'Reikna m√≥lstyrk',
                        given: { moles, volume },
                        question: `√û√∫ leysir ${moles} m√≥l af ${chemical.name} √≠ ${volume} L af lausn. Hver er m√≥lstyrkurinn?`,
                        answer: molarity,
                        unit: 'M',
                        difficulty: difficulty,
                        hints: [
                            'M√≥lstyrkur (M) = m√≥l / l√≠trar',
                            `M = ${moles} / ${volume}`,
                            `M = ${molarity.toFixed(3)} M`
                        ]
                    };
                } else if (type === 'molarityFromMass') {
                    const massInGrams = Math.round(Math.random() * 90 + 10);
                    const volumeInML = Math.round(Math.random() * 450 + 50);
                    const moles = massInGrams / chemical.molarMass;
                    const volumeInL = volumeInML / 1000;
                    const molarity = parseFloat((moles / volumeInL).toFixed(3));

                    return {
                        id: Math.random().toString(),
                        type: 'molarityFromMass',
                        chemical,
                        description: 'Reikna m√≥lstyrk √∫t fr√° massa',
                        given: { massInGrams, molarMass: chemical.molarMass, volumeInML },
                        question: `√û√∫ leysir ${massInGrams} g af ${chemical.displayName} (m√≥l√æyngd ${chemical.molarMass} g/mol) √≠ ${volumeInML} mL af lausn. Hver er m√≥lstyrkurinn?`,
                        answer: molarity,
                        unit: 'M',
                        difficulty: difficulty,
                        hints: [
                            'Fyrst reikna√∞u m√≥l = g / (g/mol), s√≠√∞an M = m√≥l / L',
                            `m√≥l = ${massInGrams} / ${chemical.molarMass} = ${moles.toFixed(3)}; L = ${volumeInML}/1000 = ${volumeInL.toFixed(3)}`,
                            `M = ${moles.toFixed(3)} / ${volumeInL.toFixed(3)} = ${molarity.toFixed(3)} M`
                        ]
                    };
                } else if (type === 'massFromMolarity') {
                    const molarity = parseFloat((Math.random() * 2 + 0.5).toFixed(2));
                    const volumeInML = Math.round(Math.random() * 400 + 100);
                    const volumeInL = volumeInML / 1000;
                    const moles = molarity * volumeInL;
                    const mass = parseFloat((moles * chemical.molarMass).toFixed(1));

                    return {
                        id: Math.random().toString(),
                        type: 'massFromMolarity',
                        chemical,
                        description: 'Reikna massa √∫t fr√° m√≥lstyrk',
                        given: { molarity, volumeInML, molarMass: chemical.molarMass },
                        question: `√û√∫ ert me√∞ ${volumeInML} mL af ${molarity} M ${chemical.name} lausn. Hversu m√∂rg gr√∂mm af ${chemical.name} eru √≠ lausninni? (m√≥l√æyngd ${chemical.molarMass} g/mol)`,
                        answer: mass,
                        unit: 'g',
                        difficulty: difficulty,
                        hints: [
                            'Fyrst reikna√∞u m√≥l = M √ó L, s√≠√∞an massi = m√≥l √ó m√≥l√æyngd',
                            `m√≥l = ${molarity} √ó ${volumeInL.toFixed(3)} = ${moles.toFixed(3)}`,
                            `massi = ${moles.toFixed(3)} √ó ${chemical.molarMass} = ${mass.toFixed(1)} g`
                        ]
                    };
                } else if (type === 'mixing') {
                    const M1 = parseFloat((Math.random() * 4 + 1).toFixed(2));
                    const V1 = Math.round(Math.random() * 90 + 10);
                    const M2 = parseFloat((Math.random() * 4 + 1).toFixed(2));
                    const V2 = Math.round(Math.random() * 90 + 10);

                    const totalMoles = (M1 * V1 + M2 * V2) / 1000;
                    const totalVolume = (V1 + V2) / 1000;
                    const finalMolarity = parseFloat((totalMoles / totalVolume).toFixed(3));

                    return {
                        id: Math.random().toString(),
                        type: 'mixing',
                        chemical,
                        description: 'Blanda tv√¶r lausnir',
                        given: { M1, V1, M2, V2 },
                        question: `√û√∫ blandar ${V1} mL af ${M1} M ${chemical.name} lausn me√∞ ${V2} mL af ${M2} M ${chemical.name} lausn. Hver er m√≥lstyrkur bl√∂ndunnar?`,
                        answer: finalMolarity,
                        unit: 'M',
                        difficulty: difficulty,
                        hints: [
                            'M_lokal = (M‚ÇÅV‚ÇÅ + M‚ÇÇV‚ÇÇ) / (V‚ÇÅ + V‚ÇÇ)',
                            `M = (${M1}√ó${V1} + ${M2}√ó${V2}) / (${V1}+${V2})`,
                            `M = ${finalMolarity.toFixed(3)} M`
                        ]
                    };
                }
            }, []);

            // Input validation
            const validateInput = useCallback((value) => {
                if (!value || value.trim() === '') {
                    return { valid: false, error: null };
                }

                // Handle scientific notation
                let numValue;
                try {
                    numValue = parseFloat(value);
                } catch (e) {
                    return { valid: false, error: '√ìgilt sni√∞' };
                }

                // Check if it's a valid number
                if (isNaN(numValue)) {
                    return { valid: false, error: 'Sl√°√∞u inn t√∂lu' };
                }

                // Check if positive
                if (numValue <= 0) {
                    return { valid: false, error: 'Sl√°√∞u inn j√°kv√¶√∞a t√∂lu' };
                }

                // Check reasonable bounds
                if (numValue >= 1000) {
                    return { valid: false, error: 'Talan er of h√° (< 1000)' };
                }

                return { valid: true, error: null, value: numValue };
            }, []);

            // Contextual feedback based on error magnitude
            const getContextualFeedback = useCallback((userValue, correctAnswer) => {
                const percentError = Math.abs((userValue - correctAnswer) / correctAnswer) * 100;

                if (percentError > 50) {
                    return 'Mj√∂g langt fr√°! Athuga√∞u hvort √æ√∫ valdir r√©tta form√∫lu';
                } else if (percentError > 20) {
                    return 'Ekki r√©tt. Athuga√∞u hvort √æ√∫ breyttir mL √≠ L';
                } else if (percentError > 5) {
                    return 'N√°l√¶gt! Kannski reiknivillla e√∞a aukastafavilla';
                } else {
                    return 'Mj√∂g n√°l√¶gt en utan vikmarka. Athuga√∞u n√°kv√¶mni';
                }
            }, []);

            const startGame = () => {
                const problemsCount = gameState.difficulty === 'easy' ? 8 :
                                      gameState.difficulty === 'medium' ? 10 : 12;
                const firstProblem = generateProblem(gameState.difficulty);

                setGameState(prev => ({
                    ...prev,
                    currentProblem: firstProblem,
                    userAnswer: '',
                    score: 0,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    isPlaying: true,
                    gameOver: false,
                    showFeedback: false,
                    lastAnswerCorrect: null,
                    showHint: false,
                    hintLevel: 0,
                    problemsCompleted: 0,
                    totalProblems: problemsCount,
                    streak: 0,
                    incorrectAttempts: 0,
                    showSolution: false,
                    inputError: null,
                    timeRemaining: 90
                }));

                setAnimateBeakers(true);
                setTimeout(() => setAnimateBeakers(false), 2000);

                // Start timer if enabled
                if (gameState.timerMode) {
                    startTimer();
                }
            };

            const startTimer = () => {
                if (timerRef.current) clearInterval(timerRef.current);

                timerRef.current = setInterval(() => {
                    setGameState(prev => {
                        if (prev.timeRemaining <= 1) {
                            clearInterval(timerRef.current);
                            // Auto-submit or skip
                            return { ...prev, timeRemaining: 0, showFeedback: true, lastAnswerCorrect: false };
                        }
                        return { ...prev, timeRemaining: prev.timeRemaining - 1 };
                    });
                }, 1000);
            };

            const checkAnswer = () => {
                if (!gameState.currentProblem || !gameState.userAnswer.trim()) return;

                const validation = validateInput(gameState.userAnswer);
                if (!validation.valid) {
                    setGameState(prev => ({ ...prev, inputError: validation.error }));
                    return;
                }

                const userValue = validation.value;
                const correctAnswer = gameState.currentProblem.answer;

                const tolerance = Math.abs(correctAnswer * 0.02) || 0.01;
                const isCorrect = Math.abs(userValue - correctAnswer) <= tolerance;

                const pointValue = gameState.currentProblem.difficulty === 'easy' ? 10 :
                                   gameState.currentProblem.difficulty === 'medium' ? 15 : 20;

                const hintPenalty = gameState.gameMode === 'competition' ?
                    (gameState.hintLevel === 1 ? 2 : gameState.hintLevel === 2 ? 4 : gameState.hintLevel === 3 ? 7 : 0) : 0;

                // Speed bonus in timer mode
                let speedBonus = 0;
                if (gameState.timerMode && isCorrect) {
                    if (gameState.timeRemaining > 70) speedBonus = 10;
                    else if (gameState.timeRemaining > 60) speedBonus = 5;
                }

                // Streak bonus
                let streakBonus = 0;
                const newStreak = isCorrect ? gameState.streak + 1 : 0;
                if (newStreak === 3) streakBonus = 5;
                if (newStreak === 5) streakBonus = 10;

                // Show achievement
                let achievement = null;
                if (newStreak === 3) achievement = '3 √≠ r√∂√∞! üî•';
                if (newStreak === 5) achievement = '5 r√©ttar! üî•üî•';
                if (newStreak === 3 && gameState.currentProblem.type === 'mixing') achievement = 'Fullkomin bl√∂ndun! üß™';
                if (newStreak === 3 && gameState.currentProblem.type === 'dilution') achievement = '√öt√æynningar s√©rfr√¶√∞ingur! üíß';

                setGameState(prev => {
                    const newProblemsCompleted = prev.problemsCompleted + 1;
                    const isGameOver = newProblemsCompleted >= prev.totalProblems;

                    return {
                        ...prev,
                        score: isCorrect ? prev.score + pointValue - hintPenalty + speedBonus + streakBonus : prev.score,
                        questionsAnswered: prev.questionsAnswered + 1,
                        correctAnswers: isCorrect ? prev.correctAnswers + 1 : prev.correctAnswers,
                        showFeedback: true,
                        lastAnswerCorrect: isCorrect,
                        problemsCompleted: newProblemsCompleted,
                        gameOver: isGameOver,
                        isPlaying: !isGameOver,
                        streak: newStreak,
                        bestStreak: Math.max(prev.bestStreak, newStreak),
                        incorrectAttempts: isCorrect ? 0 : prev.incorrectAttempts + 1,
                        achievementShown: achievement
                    };
                });

                // Clear timer
                if (timerRef.current) {
                    clearInterval(timerRef.current);
                }

                // Show random chemistry fact
                if (Math.random() < 0.3) {
                    setCurrentFact(CHEMISTRY_FACTS[Math.floor(Math.random() * CHEMISTRY_FACTS.length)]);
                }

                setTimeout(() => {
                    if (gameState.problemsCompleted + 1 < gameState.totalProblems) {
                        const nextProblem = generateProblem(gameState.difficulty);
                        setGameState(prev => ({
                            ...prev,
                            currentProblem: nextProblem,
                            userAnswer: '',
                            showFeedback: false,
                            lastAnswerCorrect: null,
                            showHint: false,
                            hintLevel: 0,
                            incorrectAttempts: 0,
                            showSolution: false,
                            inputError: null,
                            timeRemaining: 90,
                            achievementShown: null
                        }));
                        setAnimateBeakers(true);
                        setTimeout(() => setAnimateBeakers(false), 2000);
                        if (inputRef.current) inputRef.current.focus();
                        if (gameState.timerMode) startTimer();
                    } else {
                        setCurrentFact(null);
                    }
                }, 3000);
            };

            const showNextHint = () => {
                setGameState(prev => ({
                    ...prev,
                    hintLevel: Math.min(prev.hintLevel + 1, 3),
                    showHint: true
                }));
            };

            const revealSolution = () => {
                setGameState(prev => ({
                    ...prev,
                    showSolution: true,
                    score: prev.gameMode === 'competition' ? prev.score + 5 : prev.score
                }));
            };

            const handleKeyPress = useCallback((e) => {
                if (e.key === 'Enter' && !gameState.showFeedback && gameState.userAnswer.trim()) {
                    checkAnswer();
                } else if (e.key === 'h' || e.key === 'H') {
                    if (!gameState.showFeedback && gameState.hintLevel < 3) {
                        showNextHint();
                    }
                } else if (e.key === 's' || e.key === 'S') {
                    if (gameState.incorrectAttempts >= 2 && !gameState.showSolution) {
                        revealSolution();
                    }
                } else if (e.key === 'f' || e.key === 'F') {
                    setGameState(prev => ({ ...prev, showFormulaCard: !prev.showFormulaCard }));
                } else if (e.key === 'r' || e.key === 'R') {
                    setAnimateBeakers(true);
                    setTimeout(() => setAnimateBeakers(false), 2000);
                } else if (e.key === '?') {
                    setShowInstructions(true);
                }
            }, [gameState.showFeedback, gameState.userAnswer, gameState.hintLevel, gameState.incorrectAttempts, gameState.showSolution]);

            useEffect(() => {
                document.addEventListener('keydown', handleKeyPress);
                return () => document.removeEventListener('keydown', handleKeyPress);
            }, [handleKeyPress]);

            const resetGame = () => {
                if (timerRef.current) clearInterval(timerRef.current);
                setGameState(prev => ({
                    ...prev,
                    currentProblem: null,
                    userAnswer: '',
                    score: 0,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    isPlaying: false,
                    gameOver: false,
                    showFeedback: false,
                    lastAnswerCorrect: null,
                    showHint: false,
                    hintLevel: 0,
                    problemsCompleted: 0,
                    streak: 0,
                    incorrectAttempts: 0,
                    showSolution: false,
                    inputError: null
                }));
                setCurrentFact(null);
            };

            useEffect(() => {
                if (gameState.isPlaying && !gameState.showFeedback && inputRef.current) {
                    inputRef.current.focus();
                }
            }, [gameState.isPlaying, gameState.showFeedback, gameState.currentProblem]);

            // Clear input error when user types
            useEffect(() => {
                if (gameState.userAnswer && gameState.inputError) {
                    const validation = validateInput(gameState.userAnswer);
                    if (validation.valid) {
                        setGameState(prev => ({ ...prev, inputError: null }));
                    }
                }
            }, [gameState.userAnswer, gameState.inputError, validateInput]);

            const themeColor = gameState.gameMode === 'practice' ? 'var(--practice-green)' : 'var(--kvenno-orange)';
            const themeColorDark = gameState.gameMode === 'practice' ? 'var(--practice-green-dark)' : 'var(--kvenno-orange-dark)';

            if (showInstructions) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-4 md:p-8">
                        <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-center mb-6" style={{color: 'var(--kvenno-orange)'}}>
                                üíß Lausnir
                            </h1>

                            <div className="space-y-4 text-gray-700">
                                <h2 className="text-xl md:text-2xl font-semibold" style={{color: 'var(--kvenno-orange)'}}>Lei√∞beiningar</h2>

                                <div className="bg-orange-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">Markmi√∞:</h3>
                                    <p>Leys√∞u verkefni um m√≥lstyrk, √∫t√æynningu og bl√∂ndun lausna! Sj√°√∞u sj√≥nr√¶n bollal√≠k√∂n og l√¶r√∞u me√∞ skref-fyrir-skref lausnum.</p>
                                </div>

                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">Verkefnategundir:</h3>
                                    <ol className="list-decimal list-inside space-y-2">
                                        <li><strong>√öt√æynning:</strong> M‚ÇÅV‚ÇÅ = M‚ÇÇV‚ÇÇ</li>
                                        <li><strong>M√≥lstyrkur:</strong> M = m√≥l / l√≠trar</li>
                                        <li><strong>Bl√∂ndun:</strong> Tv√¶r lausnir blanda√∞ar</li>
                                        <li><strong>Massi ‚Üî M√≥lstyrkur:</strong> Umreiknun me√∞ m√≥l√æyngd</li>
                                    </ol>
                                </div>

                                <div className="bg-green-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">Form√∫lur:</h3>
                                    <div className="font-mono text-sm space-y-1 bg-white p-3 rounded">
                                        <p>M‚ÇÅV‚ÇÅ = M‚ÇÇV‚ÇÇ (√∫t√æynning)</p>
                                        <p>M = m√≥l / L (m√≥lstyrkur)</p>
                                        <p>m√≥l = massi(g) / m√≥l√æyngd(g/mol)</p>
                                        <p>M = (M‚ÇÅV‚ÇÅ + M‚ÇÇV‚ÇÇ) / (V‚ÇÅ + V‚ÇÇ) (bl√∂ndun)</p>
                                        <p>1 L = 1000 mL</p>
                                    </div>
                                </div>

                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">N√Ωir eiginleikar:</h3>
                                    <ul className="list-disc list-inside space-y-1 text-sm">
                                        <li>üî¨ Sj√≥nr√¶n bollal√≠k√∂n me√∞ hreyfingum</li>
                                        <li>üìù Skref-fyrir-skref lausnir</li>
                                        <li>üî• R√∂√∞ (streak) kerfi me√∞ umbun</li>
                                        <li>üí° 3-√ærepa √°bendingakerfi</li>
                                        <li>‚å®Ô∏è Fl√Ωtilyklar (H=√°bending, F=form√∫lur, R=endurtaka hreyfingu, ?=hj√°lp)</li>
                                        <li>üéØ √Üfinga- e√∞a keppnisstilling</li>
                                        <li>üßÆ Reiknisv√¶√∞i (hj√°lpart√≥l)</li>
                                    </ul>
                                </div>

                                <div className="bg-yellow-50 p-4 rounded-lg">
                                    <h3 className="font-semibold mb-2">Stigagj√∂f:</h3>
                                    <ul className="space-y-1 text-sm">
                                        <li><strong>Au√∞velt:</strong> 10 stig √ó 8 spurningar = 80 max</li>
                                        <li><strong>Mi√∞lungs:</strong> 15 stig √ó 10 spurningar = 150 max</li>
                                        <li><strong>Erfitt:</strong> 20 stig √ó 12 spurningar = 240 max</li>
                                        <li><strong>√Åbendin gar:</strong> -2, -2, -3 stig (1., 2., 3. √°bending)</li>
                                        <li><strong>R√∂√∞:</strong> +5 fyrir 3 √≠ r√∂√∞, +10 fyrir 5 √≠ r√∂√∞</li>
                                        <li><strong>Hra√∞aumbu√∞:</strong> +10 ef &lt;20s, +5 ef &lt;30s (√≠ t√≠mam√≥ti)</li>
                                    </ul>
                                </div>
                            </div>

                            <button
                                onClick={() => setShowInstructions(false)}
                                className="w-full mt-6 text-white font-bold py-4 px-6 rounded-xl transition-colors duration-200 text-lg"
                                style={{backgroundColor: 'var(--kvenno-orange)'}}
                                onMouseOver={(e) => e.target.style.backgroundColor = 'var(--kvenno-orange-dark)'}
                                onMouseOut={(e) => e.target.style.backgroundColor = 'var(--kvenno-orange)'}
                            >
                                Byrja a√∞ spila üöÄ
                            </button>
                        </div>
                    </div>
                );
            }

            if (!gameState.isPlaying && !gameState.gameOver) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-4 md:p-8">
                        <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-center mb-6" style={{color: 'var(--kvenno-orange)'}}>
                                üíß Lausnir
                            </h1>

                            <div className="space-y-6">
                                {/* Game mode selection */}
                                <div className="text-center">
                                    <p className="text-lg text-gray-700 mb-4">
                                        Veldu leikstillingu:
                                    </p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <button
                                            onClick={() => setGameState(prev => ({ ...prev, gameMode: 'competition' }))}
                                            className={`p-6 rounded-xl border-4 transition-all ${
                                                gameState.gameMode === 'competition'
                                                    ? 'border-orange-500 bg-orange-50'
                                                    : 'border-gray-200 bg-white hover:border-orange-200'
                                            }`}
                                        >
                                            <div className="text-3xl mb-2">üèÜ</div>
                                            <div className="text-xl font-bold">Keppnisstilling</div>
                                            <div className="text-sm mt-2 text-gray-600">Stigagj√∂f, t√≠mam√≥t, √°bendingar kosta stig</div>
                                        </button>
                                        <button
                                            onClick={() => setGameState(prev => ({ ...prev, gameMode: 'practice' }))}
                                            className={`p-6 rounded-xl border-4 transition-all ${
                                                gameState.gameMode === 'practice'
                                                    ? 'border-green-500 bg-green-50'
                                                    : 'border-gray-200 bg-white hover:border-green-200'
                                            }`}
                                        >
                                            <div className="text-3xl mb-2">üìö</div>
                                            <div className="text-xl font-bold">√Üfingastilling</div>
                                            <div className="text-sm mt-2 text-gray-600">Engin stig, √≥keypis √°bendingar, √≥takmarka√∞</div>
                                        </button>
                                    </div>
                                </div>

                                <div className="text-center">
                                    <p className="text-lg text-gray-700 mb-4">
                                        Veldu erfi√∞leikastig:
                                    </p>
                                </div>

                                <div className="grid gap-4">
                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({ ...prev, difficulty: 'easy' }));
                                            setTimeout(startGame, 100);
                                        }}
                                        className="bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-6 rounded-xl transition-colors"
                                    >
                                        <div className="text-2xl mb-2">üòä</div>
                                        <div className="text-xl">Au√∞velt</div>
                                        <div className="text-sm opacity-90 mt-2">8 spurningar - Einf√∂ld √∫t√æynning og m√≥lstyrkur</div>
                                    </button>

                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({ ...prev, difficulty: 'medium' }));
                                            setTimeout(startGame, 100);
                                        }}
                                        className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-6 px-6 rounded-xl transition-colors"
                                    >
                                        <div className="text-2xl mb-2">ü§î</div>
                                        <div className="text-xl">Mi√∞lungs</div>
                                        <div className="text-sm opacity-90 mt-2">10 spurningar - Me√∞ massi og m√≥l√æyngd</div>
                                    </button>

                                    <button
                                        onClick={() => {
                                            setGameState(prev => ({ ...prev, difficulty: 'hard' }));
                                            setTimeout(startGame, 100);
                                        }}
                                        className="bg-red-500 hover:bg-red-600 text-white font-bold py-6 px-6 rounded-xl transition-colors"
                                    >
                                        <div className="text-2xl mb-2">üò∞</div>
                                        <div className="text-xl">Erfitt</div>
                                        <div className="text-sm opacity-90 mt-2">12 spurningar - Bl√∂ndun og fl√≥kin verkefni</div>
                                    </button>
                                </div>

                                {/* Optional settings */}
                                <div className="bg-gray-50 p-4 rounded-xl">
                                    <h3 className="font-semibold mb-3">Valfrj√°lsar stillingar:</h3>
                                    <div className="space-y-2">
                                        <label className="flex items-center gap-3 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={gameState.timerMode}
                                                onChange={(e) => setGameState(prev => ({ ...prev, timerMode: e.target.checked }))}
                                                className="w-5 h-5"
                                            />
                                            <span>‚è±Ô∏è T√≠mam√≥t (90 sek √° spurningu, hra√∞ab√≥nus)</span>
                                        </label>
                                        <label className="flex items-center gap-3 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={gameState.showBeakers}
                                                onChange={(e) => setGameState(prev => ({ ...prev, showBeakers: e.target.checked }))}
                                                className="w-5 h-5"
                                            />
                                            <span>üî¨ S√Ωna sj√≥nr√¶n bollal√≠k√∂n</span>
                                        </label>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setShowInstructions(true)}
                                    className="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-colors"
                                >
                                    üìñ Sj√° lei√∞beiningar
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState.gameOver) {
                const accuracy = gameState.questionsAnswered > 0
                    ? ((gameState.correctAnswers / gameState.questionsAnswered) * 100).toFixed(1)
                    : '0';

                const maxScore = gameState.difficulty === 'easy' ? 80 :
                                 gameState.difficulty === 'medium' ? 150 : 240;
                const percentage = gameState.gameMode === 'competition' ?
                    ((gameState.score / maxScore) * 100).toFixed(0) : accuracy;

                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-4 md:p-8">
                        <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-center mb-6" style={{color: themeColor}}>
                                üéâ Til hamingju!
                            </h1>

                            <div className="space-y-6">
                                {gameState.gameMode === 'competition' && (
                                    <div className="bg-gradient-to-r from-orange-100 to-orange-200 p-6 rounded-xl">
                                        <div className="text-center">
                                            <div className="text-4xl md:text-6xl font-bold mb-2" style={{color: 'var(--kvenno-orange)'}}>{gameState.score}</div>
                                            <div className="text-lg md:text-xl text-gray-700">af {maxScore} stigum m√∂gulegum</div>
                                            <div className="text-2xl md:text-3xl font-bold text-blue-600 mt-2">{percentage}%</div>
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-blue-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-blue-600">{gameState.totalProblems}</div>
                                        <div className="text-sm text-gray-700">Spurningar</div>
                                    </div>

                                    <div className="bg-green-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-green-600">{gameState.correctAnswers}</div>
                                        <div className="text-sm text-gray-700">R√©tt</div>
                                    </div>

                                    <div className="bg-yellow-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-yellow-600">{accuracy}%</div>
                                        <div className="text-sm text-gray-700">N√°kv√¶mni</div>
                                    </div>

                                    <div className="bg-red-50 p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-red-600">{gameState.bestStreak}</div>
                                        <div className="text-sm text-gray-700">Lengsta r√∂√∞</div>
                                    </div>
                                </div>

                                <div className="bg-orange-50 p-4 rounded-xl">
                                    <h3 className="font-semibold text-center mb-2">
                                        {parseInt(percentage) >= 90 ? 'üåü Fullkomi√∞!' :
                                         parseInt(percentage) >= 75 ? 'üëç Fr√°b√¶rt!' :
                                         parseInt(percentage) >= 60 ? 'üí™ Vel gert!' :
                                         'üìö Haltu √°fram!'}
                                    </h3>
                                    <p className="text-center text-sm text-gray-700">
                                        {parseInt(percentage) >= 90 ? '√û√∫ skilur m√≥lstyrk fullkomlega!' :
                                         parseInt(percentage) >= 75 ? 'Mj√∂g g√≥√∞ √æekking √° lausnum!' :
                                         parseInt(percentage) >= 60 ? '√Å g√≥√∞ri lei√∞!' :
                                         '√Üf√∞u meira me√∞ form√∫lunum!'}
                                    </p>
                                </div>

                                <div className="flex flex-col md:flex-row gap-4">
                                    <button
                                        onClick={resetGame}
                                        className="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                                    >
                                        ‚Üª Velja stig
                                    </button>
                                    <button
                                        onClick={() => startGame()}
                                        className="flex-1 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                                        style={{backgroundColor: themeColor}}
                                        onMouseOver={(e) => e.target.style.backgroundColor = themeColorDark}
                                        onMouseOut={(e) => e.target.style.backgroundColor = themeColor}
                                    >
                                        Spila aftur
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-2xl p-4 md:p-6 mb-6">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <h1 className="text-xl md:text-3xl font-bold flex items-center gap-2" style={{color: themeColor}}>
                                    üíß Lausnir
                                    <span className="text-sm md:text-base font-normal text-gray-600">
                                        ({gameState.gameMode === 'practice' ? '√Üfing' : 'Keppni'})
                                    </span>
                                </h1>

                                <div className="flex gap-2 md:gap-4 items-center flex-wrap">
                                    {gameState.gameMode === 'competition' && (
                                        <div className="text-center">
                                            <div className="flex items-center gap-2 mb-1" style={{color: themeColor}}>
                                                <span>üèÜ</span>
                                                <span className="text-xl md:text-2xl font-bold">{gameState.score}</span>
                                            </div>
                                            <div className="text-xs text-gray-600">Stig</div>
                                        </div>
                                    )}

                                    {gameState.streak > 0 && (
                                        <div className="text-center">
                                            <div className="flex items-center gap-2 mb-1 text-red-600">
                                                <span className="streak-flame">üî•</span>
                                                <span className="text-xl md:text-2xl font-bold">{gameState.streak}</span>
                                            </div>
                                            <div className="text-xs text-gray-600">R√∂√∞</div>
                                        </div>
                                    )}

                                    <div className="text-center">
                                        <div className="text-xl md:text-2xl font-bold text-blue-600">
                                            {gameState.problemsCompleted}/{gameState.totalProblems}
                                        </div>
                                        <div className="text-xs text-gray-600">Framvinda</div>
                                    </div>

                                    {gameState.timerMode && gameState.timeRemaining > 0 && (
                                        <div className={`text-center ${gameState.timeRemaining < 15 ? 'timer-warning' : ''}`}>
                                            <div className={`text-xl md:text-2xl font-bold ${gameState.timeRemaining < 15 ? 'text-red-600' : 'text-purple-600'}`}>
                                                ‚è±Ô∏è {gameState.timeRemaining}s
                                            </div>
                                            <div className="text-xs text-gray-600">T√≠mi</div>
                                        </div>
                                    )}

                                    <button
                                        onClick={() => setGameState(prev => ({ ...prev, showFormulaCard: !prev.showFormulaCard }))}
                                        className="p-2 rounded-lg transition-colors text-sm md:text-base"
                                        style={{color: themeColor}}
                                        onMouseOver={(e) => e.target.style.backgroundColor = '#fff7ed'}
                                        onMouseOut={(e) => e.target.style.backgroundColor = 'transparent'}
                                        title="Form√∫lur (F)"
                                    >
                                        üìê
                                    </button>

                                    <button
                                        onClick={() => setShowInstructions(true)}
                                        className="p-2 rounded-lg transition-colors text-sm md:text-base"
                                        style={{color: themeColor}}
                                        onMouseOver={(e) => e.target.style.backgroundColor = '#fff7ed'}
                                        onMouseOut={(e) => e.target.style.backgroundColor = 'transparent'}
                                        title="Hj√°lp (?)"
                                    >
                                        ‚ùì
                                    </button>
                                </div>
                            </div>

                            <div className="mt-4 bg-gray-200 rounded-full h-2 md:h-3">
                                <div
                                    className="h-2 md:h-3 rounded-full transition-all duration-500"
                                    style={{
                                        width: `${(gameState.problemsCompleted / gameState.totalProblems) * 100}%`,
                                        background: `linear-gradient(to right, ${themeColor}, ${themeColorDark})`
                                    }}
                                />
                            </div>
                        </div>

                        {/* Achievement notification */}
                        {gameState.achievementShown && (
                            <div className="mb-6 bg-gradient-to-r from-yellow-100 to-yellow-200 border-4 border-yellow-400 rounded-xl p-4 text-center animate-pulse">
                                <div className="text-2xl md:text-3xl font-bold text-yellow-800">{gameState.achievementShown}</div>
                            </div>
                        )}

                        {/* Formula reference card */}
                        {gameState.showFormulaCard && (
                            <div className="formula-card" role="complementary" aria-label="Form√∫lukort">
                                <h3 className="font-bold mb-2 text-lg" style={{color: themeColor}}>üìê Form√∫lur</h3>
                                <div className="text-sm space-y-1 font-mono">
                                    <p><strong>√öt√æynning:</strong> M‚ÇÅV‚ÇÅ = M‚ÇÇV‚ÇÇ</p>
                                    <p><strong>M√≥lstyrkur:</strong> M = mol / L</p>
                                    <p><strong>M√≥l:</strong> mol = massi(g) / m√≥l√æyngd(g/mol)</p>
                                    <p><strong>Bl√∂ndun:</strong> M = (M‚ÇÅV‚ÇÅ + M‚ÇÇV‚ÇÇ) / (V‚ÇÅ + V‚ÇÇ)</p>
                                    <hr className="my-2" />
                                    <p><strong>Umreikningar:</strong></p>
                                    <p>1 L = 1000 mL</p>
                                    <p>1 g = 1000 mg</p>
                                </div>
                            </div>
                        )}

                        {/* Chemistry fact */}
                        {currentFact && (
                            <div className="mb-6 bg-blue-50 border-2 border-blue-300 rounded-xl p-4">
                                <h3 className="font-bold text-blue-800 mb-2">üí° Visstu a√∞...?</h3>
                                <p className="text-blue-900">{currentFact}</p>
                            </div>
                        )}

                        {/* Problem Area */}
                        <div className="bg-white rounded-2xl shadow-2xl p-4 md:p-8">
                            {gameState.currentProblem && (
                                <>
                                    <div className="mb-6">
                                        <div className="inline-block bg-orange-100 px-4 py-2 rounded-full text-sm font-semibold mb-4" style={{color: themeColorDark}}>
                                            {gameState.currentProblem.description}
                                        </div>

                                        <div className="text-lg md:text-xl text-gray-800 leading-relaxed">
                                            {gameState.currentProblem.question}
                                        </div>
                                    </div>

                                    {/* Beaker visualization */}
                                    {gameState.showBeakers && (
                                        <div className="mb-6">
                                            <div className="flex justify-center mb-2">
                                                <button
                                                    onClick={() => {
                                                        setAnimateBeakers(true);
                                                        setTimeout(() => setAnimateBeakers(false), 2000);
                                                    }}
                                                    className="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded"
                                                    title="Endurtaka hreyfingu (R)"
                                                >
                                                    üîÑ Endurtaka hreyfingu
                                                </button>
                                            </div>
                                            <BeakerVisualization problem={gameState.currentProblem} animate={animateBeakers} />
                                        </div>
                                    )}

                                    {/* Hints */}
                                    {gameState.showHint && gameState.hintLevel > 0 && (
                                        <div className="mb-4 bg-yellow-50 border-2 border-yellow-300 p-4 rounded-xl">
                                            <h4 className="font-semibold text-yellow-800 mb-2 flex items-center gap-2">
                                                üí° √Åbending {gameState.hintLevel}:
                                                {gameState.gameMode === 'competition' && (
                                                    <span className="text-sm">(-{gameState.hintLevel === 1 ? 2 : gameState.hintLevel === 2 ? 2 : 3} stig)</span>
                                                )}
                                            </h4>
                                            <p className="text-yellow-900">{gameState.currentProblem.hints[gameState.hintLevel - 1]}</p>
                                        </div>
                                    )}

                                    {/* Show solution */}
                                    {gameState.showSolution && (
                                        <div className="mb-4 bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
                                            <h4 className="font-semibold text-blue-800 mb-2">
                                                üìñ Fullkomin lausn
                                                {gameState.gameMode === 'competition' && <span className="text-sm"> (+5 stig fyrir tilraun)</span>}
                                            </h4>
                                            <StepBySolution problem={gameState.currentProblem} />
                                        </div>
                                    )}

                                    {/* Answer Input */}
                                    <div className="max-w-md mx-auto">
                                        {!gameState.showFeedback ? (
                                            <div className="space-y-4">
                                                <div className="flex gap-2 items-end">
                                                    <div className="flex-1">
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            Svar:
                                                        </label>
                                                        <input
                                                            ref={inputRef}
                                                            type="number"
                                                            inputMode="decimal"
                                                            step="any"
                                                            value={gameState.userAnswer}
                                                            onChange={(e) => setGameState(prev => ({ ...prev, userAnswer: e.target.value }))}
                                                            placeholder="0.000"
                                                            className={`w-full p-3 text-xl border-2 rounded-lg focus:outline-none text-center font-bold ${
                                                                gameState.inputError ? 'input-error' : ''
                                                            }`}
                                                            style={{borderColor: gameState.inputError ? '#ef4444' : themeColor}}
                                                            onFocus={(e) => !gameState.inputError && (e.target.style.borderColor = themeColorDark)}
                                                            onBlur={(e) => !gameState.inputError && (e.target.style.borderColor = themeColor)}
                                                            autoFocus
                                                            aria-label="Svarsv√¶√∞i"
                                                            aria-invalid={gameState.inputError ? 'true' : 'false'}
                                                            aria-describedby={gameState.inputError ? 'input-error' : undefined}
                                                        />
                                                        {gameState.inputError && (
                                                            <div id="input-error" className="error-message" role="alert">
                                                                ‚ö†Ô∏è {gameState.inputError}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="text-xl font-bold text-gray-600 pb-3">
                                                        {gameState.currentProblem.unit}
                                                    </div>
                                                </div>

                                                <div className="flex flex-col md:flex-row gap-2">
                                                    {gameState.hintLevel < 3 && (
                                                        <button
                                                            onClick={showNextHint}
                                                            className="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                                                            title="√Åbending (H)"
                                                        >
                                                            üí° √Åbending {gameState.hintLevel + 1}
                                                            {gameState.gameMode === 'competition' &&
                                                                ` (-${gameState.hintLevel === 0 ? 2 : gameState.hintLevel === 1 ? 2 : 3})`
                                                            }
                                                        </button>
                                                    )}
                                                    {gameState.incorrectAttempts >= 2 && !gameState.showSolution && (
                                                        <button
                                                            onClick={revealSolution}
                                                            className="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                                                            title="S√Ωna lausn (S)"
                                                        >
                                                            üìñ S√Ωna lausn
                                                            {gameState.gameMode === 'competition' && ' (+5)'}
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={checkAnswer}
                                                        disabled={!gameState.userAnswer.trim() || gameState.inputError}
                                                        className="flex-1 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                                        style={{backgroundColor: (gameState.userAnswer.trim() && !gameState.inputError) ? themeColor : undefined}}
                                                        onMouseOver={(e) => {if (gameState.userAnswer.trim() && !gameState.inputError) e.target.style.backgroundColor = themeColorDark}}
                                                        onMouseOut={(e) => {if (gameState.userAnswer.trim() && !gameState.inputError) e.target.style.backgroundColor = themeColor}}
                                                        title="Athuga (Enter)"
                                                    >
                                                        Athuga ‚úì
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div>
                                                <div className={`p-6 rounded-xl mb-4 ${gameState.lastAnswerCorrect ? 'bg-green-50 border-4 border-green-300' : 'bg-red-50 border-4 border-red-300'}`}>
                                                    <div className="text-center">
                                                        <div className="text-4xl mb-2">
                                                            {gameState.lastAnswerCorrect ? '‚úÖ' : '‚ùå'}
                                                        </div>
                                                        <div className="text-2xl font-bold mb-2">
                                                            {gameState.lastAnswerCorrect ? 'R√©tt!' : 'Rangt'}
                                                        </div>
                                                        <div className="text-lg text-gray-700">
                                                            R√©tt svar: <span className="font-bold">{gameState.currentProblem.answer.toFixed(3)} {gameState.currentProblem.unit}</span>
                                                        </div>
                                                        {!gameState.lastAnswerCorrect && (
                                                            <>
                                                                <div className="text-sm text-gray-600 mt-2">
                                                                    √ûitt svar: {gameState.userAnswer} {gameState.currentProblem.unit}
                                                                </div>
                                                                <div className="text-sm text-red-700 mt-2 font-semibold">
                                                                    {getContextualFeedback(parseFloat(gameState.userAnswer), gameState.currentProblem.answer)}
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Always show step-by-step after answering */}
                                                <StepBySolution problem={gameState.currentProblem} />
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Keyboard shortcuts reminder */}
                        <div className="mt-4 text-center text-sm text-gray-600">
                            <p>‚å®Ô∏è Fl√Ωtilyklar: <strong>Enter</strong>=athuga, <strong>H</strong>=√°bending, <strong>S</strong>=s√Ωna lausn, <strong>F</strong>=form√∫lur, <strong>R</strong>=endurtaka, <strong>?</strong>=hj√°lp</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SolutionLab />);
    </script>
</body>
</html>
