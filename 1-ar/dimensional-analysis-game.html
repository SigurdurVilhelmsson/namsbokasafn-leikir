<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einingagreining - Námsleiðin</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .primary-orange {
            color: #f36b22;
        }

        .bg-primary-orange {
            background-color: #f36b22;
        }

        .bg-dark-orange {
            background-color: #d95a1a;
        }

        .border-primary-orange {
            border-color: #f36b22;
        }

        .hover-orange:hover {
            background-color: #f36b22;
        }

        .animate-fill {
            animation: fillUp 2s ease-in-out;
        }

        @keyframes fillUp {
            from { height: 0%; }
            to { height: 100%; }
        }

        .cancel-animation {
            animation: cancelOut 0.5s ease-out;
        }

        @keyframes cancelOut {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ==================== DATA BANKS ====================

        const lessons = [
            {
                id: 1,
                title: "Hvað er umbreytingarstuðull?",
                content: "Umbreytingarstuðull er brot sem jafngildir 1. Vegna þess að teljari og nefnari tákna sama magn, getum við margfaldað með honum án þess að breyta raunverulegu magni.",
                animation: "beakers",
                quiz: {
                    question: "Hvaða gildi hefur 1000 mL / 1 L?",
                    options: ["0.001", "1", "1000", "1000000"],
                    correct: 1,
                    explanation: "Vegna þess að 1000 mL = 1 L þá er þessi brot jafn og 1"
                }
            },
            {
                id: 2,
                title: "Af hverju strikast einingar út?",
                content: "Þegar sama einingin birtist bæði í teljara og nefnara getum við strikað hana út, alveg eins og með tölur í brotum.",
                animation: "cancellation",
                quiz: {
                    question: "Hvaða pör strikast út? (Veldu öll rétt)",
                    options: ["g/g", "mL/L", "kg/g", "cm/cm"],
                    correct: [0, 3],
                    multiSelect: true,
                    explanation: "Aðeins nákvæmlega sama einingin strikast út: g með g, cm með cm"
                }
            },
            {
                id: 3,
                title: "Hvernig vel ég rétta stefnu?",
                content: "Til að velja rétta stefnu á umbreytingarstuðli þarftu að hugsa um hvaða eining þarf að vera í nefnara til að strikast út við upphafseiningu.",
                animation: "orientation",
                quiz: {
                    question: "Til að breyta g → kg, hvaða stuðull er réttur?",
                    options: ["1 kg / 1000 g", "1000 g / 1 kg", "Báðir virka", "Hvorugur virkar"],
                    correct: 0,
                    explanation: "Við þurfum 'g' í nefnara til að strika út við upphafs 'g', svo 1 kg / 1000 g er rétt"
                }
            }
        ];

        const level1Questions = [
            {
                id: 'L1-1',
                type: 'equivalence',
                prompt: 'Hvað af þessu jafngildir 1? (Veldu öll rétt)',
                options: [
                    { text: '1000 mL / 1 L', correct: true },
                    { text: '1000 g / 1 kg', correct: true },
                    { text: '100 mL / 1 L', correct: false },
                    { text: '60 s / 1 mín', correct: true },
                    { text: '50 cm / 1 m', correct: false }
                ],
                multiSelect: true,
                explanationRequired: false
            },
            {
                id: 'L1-2',
                type: 'cancellation_prediction',
                prompt: 'Ef þú byrjar með 2000 g og margfaldar með (1 kg / 1000 g), hvað verður eftir?',
                options: ['g', 'kg', 'g·kg', 'g/kg'],
                correct: 1,
                explanationRequired: true,
                explanationOptions: [
                    { text: 'Vegna þess að g strikast út og kg verður eftir', correct: true },
                    { text: 'Vegna þess að kg er stærra', correct: false },
                    { text: 'Vegna þess að talan minnkar', correct: false }
                ]
            },
            {
                id: 'L1-3',
                type: 'factor_selection',
                prompt: 'Þú þarft að breyta úr mL í L. Hvaða stuðul velur þú?',
                factors: [
                    { text: '1000 mL / 1 L', correct: false },
                    { text: '1 L / 1000 mL', correct: true }
                ],
                explanationOptions: [
                    { text: 'Vegna þess að mL þarf að vera í nefnara til að strikast út', correct: true },
                    { text: 'Vegna þess að L er stærri eining', correct: false },
                    { text: 'Vegna þess að þetta er einfaldara', correct: false }
                ]
            },
            {
                id: 'L1-4',
                type: 'error_identification',
                prompt: 'Anna reyndi að breyta 5000 mg í g. Hún notaði (1000 mg / 1 g). Hvað fór úrskeiðis?',
                options: [
                    'Hún notaði rangan stuðul',
                    'Stuðullinn er rétt snúinn',
                    'Hún þurfti fleiri stuðla',
                    'Ekkert fór úrskeiðis'
                ],
                correct: 1,
                correctText: 'Stuðullinn er rangur snúinn - mg þarf að vera í nefnara',
                visualization: 'Útkoman yrði 5000000 mg²/g í stað 5 g'
            },
            {
                id: 'L1-5',
                type: 'conceptual',
                prompt: 'Af hverju breytist talan þegar við breytum einingum, þó magn efnisins sé það sama?',
                options: [
                    'Vegna þess að mismunandi einingar mæla mismunandi magn',
                    'Vegna þess að einingar af mismunandi stærð þurfa mismunandi fjölda til að tákna sama magn',
                    'Vegna þess að umbreyting breytir efninu',
                    'Talan breytist ekki'
                ],
                correct: 1
            },
            {
                id: 'L1-6',
                type: 'equivalence',
                prompt: 'Hvað af þessu jafngildir 1? (Veldu öll rétt)',
                options: [
                    { text: '100 cm / 1 m', correct: true },
                    { text: '1 km / 100 m', correct: false },
                    { text: '1000 mm / 1 m', correct: true },
                    { text: '24 klst / 1 dagur', correct: true },
                    { text: '100 g / 1 kg', correct: false }
                ],
                multiSelect: true
            },
            {
                id: 'L1-7',
                type: 'cancellation_prediction',
                prompt: 'Ef þú byrjar með 500 mL og margfaldar með (1 L / 1000 mL), hvað verður eftir?',
                options: ['mL', 'L', 'mL·L', 'mL/L'],
                correct: 1,
                explanationRequired: true,
                explanationOptions: [
                    { text: 'Vegna þess að mL strikast út og L verður eftir', correct: true },
                    { text: 'Vegna þess að við deildum með 1000', correct: false },
                    { text: 'Vegna þess að L er í teljaranum', correct: false }
                ]
            },
            {
                id: 'L1-8',
                type: 'factor_selection',
                prompt: 'Þú þarft að breyta úr km í m. Hvaða stuðul velur þú?',
                factors: [
                    { text: '1 km / 1000 m', correct: false },
                    { text: '1000 m / 1 km', correct: true }
                ],
                explanationOptions: [
                    { text: 'Vegna þess að km þarf að vera í nefnara til að strikast út', correct: true },
                    { text: 'Vegna þess að 1000 er stærri tala', correct: false },
                    { text: 'Vegna þess að m er minni eining', correct: false }
                ]
            },
            {
                id: 'L1-9',
                type: 'error_identification',
                prompt: 'Jón reyndi að breyta 2 L í mL. Hann notaði (1 L / 1000 mL). Hvað fór úrskeiðis?',
                options: [
                    'Hann notaði rangan stuðul',
                    'Stuðullinn er rangur snúinn',
                    'Hann þurfti fleiri stuðla',
                    'Ekkert fór úrskeiðis'
                ],
                correct: 1,
                correctText: 'Stuðullinn er rangur snúinn - L þarf að vera í nefnara',
                visualization: 'Útkoman yrði 0.002 L²/mL í stað 2000 mL'
            },
            {
                id: 'L1-10',
                type: 'conceptual',
                prompt: 'Hvað gerir umbreytingarstuðul svo gagnlegan?',
                options: [
                    'Hann breytir magninu',
                    'Hann jafngildir 1 svo að margföldun breytir ekki raunverulegu magni',
                    'Hann gerir tölurnar stærri',
                    'Hann eyðir einingunum'
                ],
                correct: 1
            }
        ];

        const conversionFactors = [
            { num: '1 kg', den: '1000 g', units: ['kg', 'g'] },
            { num: '1000 g', den: '1 kg', units: ['g', 'kg'] },
            { num: '1 g', den: '1000 mg', units: ['g', 'mg'] },
            { num: '1000 mg', den: '1 g', units: ['mg', 'g'] },
            { num: '1 L', den: '1000 mL', units: ['L', 'mL'] },
            { num: '1000 mL', den: '1 L', units: ['mL', 'L'] },
            { num: '1 km', den: '1000 m', units: ['km', 'm'] },
            { num: '1000 m', den: '1 km', units: ['m', 'km'] },
            { num: '1 m', den: '100 cm', units: ['m', 'cm'] },
            { num: '100 cm', den: '1 m', units: ['cm', 'm'] },
            { num: '1 m', den: '1000 mm', units: ['m', 'mm'] },
            { num: '1000 mm', den: '1 m', units: ['mm', 'm'] },
            { num: '1 klst', den: '3600 s', units: ['klst', 's'] },
            { num: '3600 s', den: '1 klst', units: ['s', 'klst'] },
            { num: '1 klst', den: '60 mín', units: ['klst', 'mín'] },
            { num: '60 mín', den: '1 klst', units: ['mín', 'klst'] },
            { num: '1 mín', den: '60 s', units: ['mín', 's'] },
            { num: '60 s', den: '1 mín', units: ['s', 'mín'] }
        ];

        const level2Problems = [
            {
                id: 'L2-1',
                difficulty: 'scaffolded_high',
                context: 'Lyfjagjöf er 500 mg. Umbúðirnar sýna styrk í g.',
                startValue: 500,
                startUnit: 'mg',
                targetUnit: 'g',
                correctPath: ['1 g / 1000 mg'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-2',
                difficulty: 'scaffolded_high',
                context: 'Breyttu rúmmáli úr mL í L.',
                startValue: 2500,
                startUnit: 'mL',
                targetUnit: 'L',
                correctPath: ['1 L / 1000 mL'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-3',
                difficulty: 'scaffolded_high',
                context: 'Breyttu massa úr g í kg.',
                startValue: 3500,
                startUnit: 'g',
                targetUnit: 'kg',
                correctPath: ['1 kg / 1000 g'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-4',
                difficulty: 'scaffolded_high',
                context: 'Breyttu lengd úr cm í m.',
                startValue: 250,
                startUnit: 'cm',
                targetUnit: 'm',
                correctPath: ['1 m / 100 cm'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-5',
                difficulty: 'scaffolded_high',
                context: 'Breyttu massa úr kg í g.',
                startValue: 2.5,
                startUnit: 'kg',
                targetUnit: 'g',
                correctPath: ['1000 g / 1 kg'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-6',
                difficulty: 'medium',
                context: 'Breyttu lengd úr km í cm.',
                startValue: 0.5,
                startUnit: 'km',
                targetUnit: 'cm',
                correctPath: ['1000 m / 1 km', '100 cm / 1 m'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-7',
                difficulty: 'medium',
                context: 'Breyttu massa úr mg í kg.',
                startValue: 5000,
                startUnit: 'mg',
                targetUnit: 'kg',
                correctPath: ['1 g / 1000 mg', '1 kg / 1000 g'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-8',
                difficulty: 'medium',
                context: 'Breyttu hraða úr km/klst í m/s.',
                startValue: 90,
                startUnit: 'km/klst',
                targetUnit: 'm/s',
                correctPath: ['1000 m / 1 km', '1 klst / 3600 s'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-9',
                difficulty: 'medium',
                context: 'Breyttu tíma úr klst í s.',
                startValue: 2,
                startUnit: 'klst',
                targetUnit: 's',
                correctPath: ['3600 s / 1 klst'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-10',
                difficulty: 'medium',
                context: 'Breyttu lengd úr mm í km.',
                startValue: 5000000,
                startUnit: 'mm',
                targetUnit: 'km',
                correctPath: ['1 m / 1000 mm', '1 km / 1000 m'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-11',
                difficulty: 'advanced',
                context: 'Breyttu hraða úr m/s í km/klst.',
                startValue: 25,
                startUnit: 'm/s',
                targetUnit: 'km/klst',
                correctPath: ['1 km / 1000 m', '3600 s / 1 klst'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-12',
                difficulty: 'advanced',
                context: 'Breyttu lengd úr cm í km.',
                startValue: 150000,
                startUnit: 'cm',
                targetUnit: 'km',
                correctPath: ['1 m / 100 cm', '1 km / 1000 m'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-13',
                difficulty: 'advanced',
                context: 'Breyttu rúmmál úr mL í L og síðan aftur í mL með öðru gildi.',
                startValue: 500,
                startUnit: 'mL',
                targetUnit: 'L',
                correctPath: ['1 L / 1000 mL'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-14',
                difficulty: 'advanced',
                context: 'Breyttu tíma úr s í klst.',
                startValue: 7200,
                startUnit: 's',
                targetUnit: 'klst',
                correctPath: ['1 klst / 3600 s'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-15',
                difficulty: 'advanced',
                context: 'Breyttu eðlismassa úr g/mL í kg/L.',
                startValue: 1.5,
                startUnit: 'g/mL',
                targetUnit: 'kg/L',
                correctPath: ['1 kg / 1000 g', '1000 mL / 1 L'],
                scaffoldingLevel: 1
            }
        ];

        const level3Challenges = [
            {
                id: 'L3-1',
                type: 'reverse',
                prompt: 'Nemandi byrjaði með 5000 mg og endaði með 0.005 kg. Hvaða umbreytingarstuðla notaði hann líklega?',
                setup: { start: '5000 mg', end: '0.005 kg', startValue: 5000, endValue: 0.005 },
                options: [
                    {
                        text: '1 g / 1000 mg, síðan 1 kg / 1000 g',
                        factors: ['1 g / 1000 mg', '1 kg / 1000 g'],
                        correct: true,
                        steps: 2
                    },
                    {
                        text: '1 kg / 1000000 mg',
                        factors: ['1 kg / 1000000 mg'],
                        correct: true,
                        steps: 1
                    },
                    {
                        text: '1000 g / 1 kg, síðan 1000 mg / 1 g',
                        factors: ['1000 g / 1 kg', '1000 mg / 1 g'],
                        correct: false,
                        steps: 2
                    }
                ],
                explanationPrompt: 'Útskýrðu hvernig umbreytingin virkar:'
            },
            {
                id: 'L3-2',
                type: 'error_analysis',
                prompt: 'María reyndi að breyta 250 mL í L. Hún fékk 250000 L. Hvað fór úrskeiðis og hvað er rétta svarið?',
                incorrectWork: '250 mL × (1000 mL / 1 L) = 250000 L',
                correctAnswer: 0.25,
                correctUnit: 'L',
                errorExplanation: 'María notaði stuðulinn öfugan - hún margfaldaði með mL í stað þess að deila',
                correctMethod: ['1 L / 1000 mL']
            },
            {
                id: 'L3-3',
                type: 'efficiency',
                prompt: 'Breyttu 0.000005 km í mm. Finndu skilvirkustu leiðina (fæst skref).',
                startValue: 0.000005,
                startUnit: 'km',
                targetUnit: 'mm',
                possiblePaths: [
                    { steps: ['1000 m / 1 km', '1000 mm / 1 m'], stepCount: 2, efficient: true },
                    { steps: ['1000 m / 1 km', '100 cm / 1 m', '10 mm / 1 cm'], stepCount: 3, efficient: false },
                    { steps: ['100000 cm / 1 km', '10 mm / 1 cm'], stepCount: 2, efficient: true }
                ],
                targetAnswer: 5
            },
            {
                id: 'L3-4',
                type: 'synthesis',
                prompt: 'Þú mælir 50.0 mL af lausn með eðlismassa 2.50 g/mL. Hversu mörg kg er þetta? Gefðu svar í 3 markverðum tölustöfum.',
                startValue: 50.0,
                startUnit: 'mL',
                density: 2.50,
                densityUnit: 'g/mL',
                targetUnit: 'kg',
                expectedAnswer: 0.125,
                significantFigures: 3,
                requiredSteps: ['multiply by density', 'convert g to kg']
            },
            {
                id: 'L3-5',
                type: 'real_world',
                prompt: 'Þú átt 2.0 L af stofnlausn og þarft að útbúa 150 mL skammta. Hversu marga skammta getur þú útbúið?',
                startValue: 2.0,
                startUnit: 'L',
                portionSize: 150,
                portionUnit: 'mL',
                expectedAnswer: 13,
                requireInteger: true,
                explanation: 'Svar verður að vera heiltala vegna þess að ekki er hægt að útbúa hluta af skammti'
            },
            {
                id: 'L3-6',
                type: 'derivation',
                prompt: 'Hraði ljóss er 3.00 × 10⁸ m/s. Birtu svarið í km/klst.',
                startValue: 3.00e8,
                startUnit: 'm/s',
                targetUnit: 'km/klst',
                expectedAnswer: 1.08e12,
                scientificNotation: true,
                correctMethod: ['1 km / 1000 m', '3600 s / 1 klst']
            },
            {
                id: 'L3-7',
                type: 'reverse',
                prompt: 'Nemandi byrjaði með 72 km/klst og endaði með 20 m/s. Hvaða stuðla notaði hann?',
                setup: { start: '72 km/klst', end: '20 m/s', startValue: 72, endValue: 20 },
                options: [
                    {
                        text: '1000 m / 1 km, síðan 1 klst / 3600 s',
                        factors: ['1000 m / 1 km', '1 klst / 3600 s'],
                        correct: true,
                        steps: 2
                    },
                    {
                        text: '1 km / 1000 m, síðan 3600 s / 1 klst',
                        factors: ['1 km / 1000 m', '3600 s / 1 klst'],
                        correct: false,
                        steps: 2
                    }
                ],
                explanationPrompt: 'Útskýrðu umbreytinguna:'
            },
            {
                id: 'L3-8',
                type: 'synthesis',
                prompt: 'Eðlismassi kopar er 8.96 g/cm³. Breyttu þessu í kg/m³.',
                startValue: 8.96,
                startUnit: 'g/cm³',
                targetUnit: 'kg/m³',
                expectedAnswer: 8960,
                significantFigures: 3,
                requiredSteps: ['convert g to kg', 'convert cm³ to m³']
            },
            {
                id: 'L3-9',
                type: 'error_analysis',
                prompt: 'Jón reyndi að breyta 3 klst í sekúndur. Hann fékk 180 s. Hvað fór úrskeiðis?',
                incorrectWork: '3 klst × (60 mín / 1 klst) = 180',
                correctAnswer: 10800,
                correctUnit: 's',
                errorExplanation: 'Jón gleymdi að breyta mínútum í sekúndur',
                correctMethod: ['60 mín / 1 klst', '60 s / 1 mín']
            },
            {
                id: 'L3-10',
                type: 'efficiency',
                prompt: 'Breyttu 500000 mg í kg. Veldu skilvirkustu leiðina.',
                startValue: 500000,
                startUnit: 'mg',
                targetUnit: 'kg',
                possiblePaths: [
                    { steps: ['1 g / 1000 mg', '1 kg / 1000 g'], stepCount: 2, efficient: true },
                    { steps: ['1 kg / 1000000 mg'], stepCount: 1, efficient: true },
                    { steps: ['1000 g / 1 kg'], stepCount: 1, efficient: false }
                ],
                targetAnswer: 0.5
            }
        ];

        // ==================== UTILITY FUNCTIONS ====================

        const saveProgress = (gameState) => {
            localStorage.setItem('dimensionalAnalysisProgress', JSON.stringify(gameState));
        };

        const loadProgress = () => {
            const saved = localStorage.getItem('dimensionalAnalysisProgress');
            if (saved) {
                return JSON.parse(saved);
            }
            return null;
        };

        const checkLevel1Mastery = (level1Data) => {
            const { questionsCorrect, questionsAnswered, explanationScores } = level1Data;
            if (questionsAnswered < 10) return false;

            const avgExplanation = explanationScores.length > 0
                ? explanationScores.reduce((a, b) => a + b, 0) / explanationScores.length
                : 1;

            return questionsCorrect >= 8 && avgExplanation >= 0.7;
        };

        const checkLevel2Mastery = (level2Data) => {
            const { problemsCompleted, predictionsMade, predictionsCorrect, finalAnswersCorrect } = level2Data;
            if (problemsCompleted < 15) return false;

            const predictionAccuracy = predictionsMade > 0 ? predictionsCorrect / predictionsMade : 0;
            const answerAccuracy = problemsCompleted > 0 ? finalAnswersCorrect / problemsCompleted : 0;

            return predictionAccuracy >= 0.7 && answerAccuracy >= 0.8;
        };

        const checkLevel3Mastery = (level3Data) => {
            const { compositeScores } = level3Data;
            if (compositeScores.length < 10) return false;

            const avgScore = compositeScores.reduce((a, b) => a + b, 0) / compositeScores.length;
            return avgScore >= 0.75;
        };

        const calculateCompositeScore = (answerScore, methodScore, explanationScore, efficiencyScore = 0) => {
            // Weighted composite: answer 40%, method 30%, explanation 20%, efficiency 10%
            return (answerScore * 0.4) + (methodScore * 0.3) + (explanationScore * 0.2) + (efficiencyScore * 0.1);
        };

        const countSignificantFigures = (numStr) => {
            // Count significant figures in a number string
            numStr = numStr.trim();

            // Handle scientific notation (e.g., "1.08e12")
            if (numStr.toLowerCase().includes('e')) {
                const [base] = numStr.toLowerCase().split('e');
                numStr = base;
            }

            // Remove leading zeros and decimal point for counting
            const hasDecimal = numStr.includes('.');
            const cleaned = numStr.replace(/^-/, ''); // Remove negative sign

            if (!hasDecimal) {
                // No decimal: count from first non-zero to end, trailing zeros don't count
                const trimmed = cleaned.replace(/^0+/, ''); // Remove leading zeros
                const withoutTrailingZeros = trimmed.replace(/0+$/, '');
                // If all zeros were removed, the trailing zeros were significant
                return trimmed === withoutTrailingZeros ? trimmed.length : trimmed.length;
            } else {
                // Has decimal: all digits count except leading zeros
                const [whole, decimal] = cleaned.split('.');
                const wholeTrimmed = whole.replace(/^0+/, '') || '0';
                const sigFigs = (wholeTrimmed === '0' ? 0 : wholeTrimmed.length) + (decimal?.length || 0);
                return sigFigs;
            }
        };

        const checkSignificantFigures = (userAnswer, expectedSigFigs) => {
            const sigFigs = countSignificantFigures(userAnswer);
            return sigFigs === expectedSigFigs;
        };

        const checkAchievements = (level3Data) => {
            const achievements = [];
            const { compositeScores, problemsCompleted, totalSteps } = level3Data;

            if (compositeScores.length >= 10) {
                const avgScore = compositeScores.reduce((a, b) => a + b, 0) / compositeScores.length;

                if (avgScore >= 0.95) {
                    achievements.push({ id: 'gold', name: 'Gullstjarna', description: '95%+ heildareinkunn' });
                } else if (avgScore >= 0.85) {
                    achievements.push({ id: 'silver', name: 'Silfurstjarna', description: '85%+ heildareinkunn' });
                } else if (avgScore >= 0.75) {
                    achievements.push({ id: 'bronze', name: 'Bronsstjarna', description: '75%+ heildareinkunn' });
                }

                const avgSteps = totalSteps / problemsCompleted;
                if (avgSteps < 3) {
                    achievements.push({ id: 'efficiency', name: 'Skilvirkni', description: 'Að meðaltali færri en 3 skref' });
                }

                const perfectExplanations = compositeScores.every(score => score >= 0.9);
                if (perfectExplanations) {
                    achievements.push({ id: 'explainer', name: 'Útskýrandi', description: 'Fullkomnar útskýringar' });
                }
            }

            return achievements;
        };

        const parseUnit = (unitString) => {
            // Parse compound units like "km/klst" or simple units like "g"
            if (unitString.includes('/')) {
                const [num, den] = unitString.split('/');
                return { numerator: num.trim(), denominator: den.trim() };
            }
            return { numerator: unitString.trim(), denominator: null };
        };

        const predictResultingUnit = (currentUnit, factor) => {
            // Predict what unit will result from applying a factor
            const current = parseUnit(currentUnit);
            const factorParsed = { numerator: factor.num.split(' ')[1], denominator: factor.den.split(' ')[1] };

            if (!current.denominator) {
                // Simple unit: current is just numerator
                if (current.numerator === factorParsed.denominator) {
                    // Cancellation happens
                    return factorParsed.numerator;
                } else {
                    // No cancellation - creates compound unit
                    return `${current.numerator}·${factorParsed.numerator}/${factorParsed.denominator}`;
                }
            } else {
                // Compound unit: current has both numerator and denominator
                let newNum = current.numerator;
                let newDen = current.denominator;

                // Check if factor denominator cancels with current numerator
                if (current.numerator === factorParsed.denominator) {
                    newNum = factorParsed.numerator;
                } else {
                    // No cancellation in numerator - they multiply
                    newNum = `${current.numerator}·${factorParsed.numerator}`;
                }

                // Check if factor numerator cancels with current denominator
                if (current.denominator === factorParsed.numerator) {
                    // Factor numerator cancels with current denominator
                    // Check if we just have numerator left
                    if (factorParsed.denominator === '1' || !factorParsed.denominator) {
                        return newNum; // Simple unit result
                    }
                    newDen = factorParsed.denominator;
                } else if (current.denominator === factorParsed.denominator) {
                    // Both denominators are the same - they cancel out
                    return newNum;
                } else {
                    // No cancellation in denominator - they multiply
                    newDen = `${current.denominator}·${factorParsed.denominator}`;
                }

                // Simplify if numerator is just 1
                if (newNum === '1') {
                    return `1/${newDen}`;
                }

                return `${newNum}/${newDen}`;
            }
        };

        // ==================== COMPONENTS ====================

        function AnimationDisplay({ type }) {
            if (type === 'beakers') {
                return (
                    <div className="flex justify-center items-end gap-8 h-64 p-8">
                        <div className="text-center">
                            <div className="relative w-32 h-48 border-4 border-blue-500 rounded-b-lg bg-blue-100">
                                <div className="absolute bottom-0 w-full h-full bg-blue-400 animate-fill rounded-b-lg"></div>
                            </div>
                            <p className="mt-2 font-bold">1000 mL</p>
                        </div>
                        <div className="text-2xl font-bold self-center">=</div>
                        <div className="text-center">
                            <div className="relative w-32 h-48 border-4 border-green-500 rounded-b-lg bg-green-100">
                                <div className="absolute bottom-0 w-full h-full bg-green-400 animate-fill rounded-b-lg"></div>
                            </div>
                            <p className="mt-2 font-bold">1 L</p>
                        </div>
                    </div>
                );
            }

            if (type === 'cancellation') {
                return (
                    <div className="flex flex-col items-center justify-center h-64 p-8">
                        <div className="text-4xl mb-8">
                            <span className="inline-block relative">
                                <span className="text-red-600 font-bold">g</span>
                                <span className="absolute top-1/2 left-0 w-full h-0.5 bg-red-600"></span>
                            </span>
                            <span className="mx-2">/</span>
                            <span className="inline-block relative">
                                <span className="text-red-600 font-bold">g</span>
                                <span className="absolute top-1/2 left-0 w-full h-0.5 bg-red-600"></span>
                            </span>
                            <span className="mx-4">=</span>
                            <span className="font-bold text-green-600">1</span>
                        </div>
                        <p className="text-lg text-gray-700">Sama einingin strikast út!</p>
                    </div>
                );
            }

            if (type === 'orientation') {
                return (
                    <div className="flex flex-col items-center justify-center h-64 p-8 space-y-4">
                        <div className="text-2xl">
                            500 <span className="text-blue-600 font-bold">g</span>
                            <span className="mx-2">×</span>
                            <span className="border-2 border-green-500 px-3 py-1 rounded">
                                1 kg / 1000 <span className="text-blue-600 font-bold">g</span>
                            </span>
                        </div>
                        <div className="text-xl text-green-600">✓ g strikast út!</div>
                        <div className="h-px w-64 bg-gray-300 my-4"></div>
                        <div className="text-2xl">
                            500 <span className="text-blue-600 font-bold">g</span>
                            <span className="mx-2">×</span>
                            <span className="border-2 border-red-500 px-3 py-1 rounded">
                                1000 <span className="text-blue-600 font-bold">g</span> / 1 kg
                            </span>
                        </div>
                        <div className="text-xl text-red-600">✗ g margfaldast!</div>
                    </div>
                );
            }

            return null;
        }

        function LessonScreen({ lesson, onComplete }) {
            const [quizAnswer, setQuizAnswer] = useState(null);
            const [selectedOptions, setSelectedOptions] = useState([]);
            const [showFeedback, setShowFeedback] = useState(false);

            const handleSubmit = () => {
                if (lesson.quiz.multiSelect) {
                    const correct = selectedOptions.length === lesson.quiz.correct.length &&
                        selectedOptions.every(idx => lesson.quiz.correct.includes(idx));
                    setShowFeedback(true);
                    if (correct) {
                        setTimeout(() => onComplete(), 2000);
                    }
                } else {
                    setShowFeedback(true);
                    if (quizAnswer === lesson.quiz.correct) {
                        setTimeout(() => onComplete(), 2000);
                    }
                }
            };

            const toggleOption = (idx) => {
                if (selectedOptions.includes(idx)) {
                    setSelectedOptions(selectedOptions.filter(i => i !== idx));
                } else {
                    setSelectedOptions([...selectedOptions, idx]);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-2xl font-bold primary-orange mb-4">
                                Kennsla {lesson.id}/3: {lesson.title}
                            </h2>

                            <div className="mb-6">
                                <AnimationDisplay type={lesson.animation} />
                            </div>

                            <p className="text-lg text-gray-700 mb-6">{lesson.content}</p>

                            <div className="border-t pt-6">
                                <h3 className="text-xl font-semibold mb-4">{lesson.quiz.question}</h3>

                                <div className="space-y-3">
                                    {lesson.quiz.options.map((option, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => {
                                                if (lesson.quiz.multiSelect) {
                                                    toggleOption(idx);
                                                } else {
                                                    setQuizAnswer(idx);
                                                }
                                            }}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                lesson.quiz.multiSelect
                                                    ? selectedOptions.includes(idx)
                                                        ? 'border-primary-orange bg-orange-50'
                                                        : 'border-gray-300 hover:border-gray-400'
                                                    : quizAnswer === idx
                                                        ? 'border-primary-orange bg-orange-50'
                                                        : 'border-gray-300 hover:border-gray-400'
                                            }`}
                                        >
                                            {option}
                                        </button>
                                    ))}
                                </div>

                                {showFeedback && (
                                    <div className={`mt-4 p-4 rounded-lg ${
                                        (lesson.quiz.multiSelect
                                            ? selectedOptions.length === lesson.quiz.correct.length &&
                                              selectedOptions.every(idx => lesson.quiz.correct.includes(idx))
                                            : quizAnswer === lesson.quiz.correct)
                                            ? 'bg-green-100 text-green-800'
                                            : 'bg-red-100 text-red-800'
                                    }`}>
                                        {(lesson.quiz.multiSelect
                                            ? selectedOptions.length === lesson.quiz.correct.length &&
                                              selectedOptions.every(idx => lesson.quiz.correct.includes(idx))
                                            : quizAnswer === lesson.quiz.correct) ? (
                                            <>
                                                <p className="font-bold">✓ Rétt!</p>
                                                <p>{lesson.quiz.explanation}</p>
                                            </>
                                        ) : (
                                            <p className="font-bold">✗ Reyndu aftur</p>
                                        )}
                                    </div>
                                )}

                                <button
                                    onClick={handleSubmit}
                                    disabled={lesson.quiz.multiSelect ? selectedOptions.length === 0 : quizAnswer === null}
                                    className="mt-6 w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    Staðfesta svar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function QuestionScreen({ question, questionNumber, totalQuestions, onAnswer, onBack }) {
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [selectedOptions, setSelectedOptions] = useState([]);
            const [selectedExplanation, setSelectedExplanation] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [hintUsed, setHintUsed] = useState(false);
            const [showHint, setShowHint] = useState(false);

            const handleSubmit = () => {
                let correct = false;
                let explanationCorrect = true;

                if (question.multiSelect) {
                    const correctOptions = question.options
                        .map((opt, idx) => opt.correct ? idx : -1)
                        .filter(idx => idx !== -1);
                    correct = selectedOptions.length === correctOptions.length &&
                        selectedOptions.every(idx => correctOptions.includes(idx));
                } else if (question.type === 'factor_selection') {
                    correct = question.factors[selectedAnswer]?.correct || false;
                    if (question.explanationOptions && selectedExplanation !== null) {
                        explanationCorrect = question.explanationOptions[selectedExplanation]?.correct || false;
                    }
                } else {
                    correct = selectedAnswer === question.correct;
                }

                if (question.explanationRequired && selectedExplanation !== null) {
                    explanationCorrect = question.explanationOptions[selectedExplanation]?.correct || false;
                }

                const finalCorrect = correct && explanationCorrect;
                setIsCorrect(finalCorrect);
                setShowFeedback(true);
            };

            const handleContinue = () => {
                // If hint was used, don't award points (Level 1 rule: unlimited hints, but disable points)
                const earnedPoints = hintUsed ? false : isCorrect;
                const explanationPoints = hintUsed ? false : (question.explanationRequired ? (selectedExplanation !== null && question.explanationOptions[selectedExplanation]?.correct) : true);
                onAnswer(earnedPoints, explanationPoints);
            };

            const getHint = () => {
                // Generate contextual hints based on question type
                if (question.type === 'equivalence') {
                    return 'Stuðlar sem jafngilda 1 hafa sama magn í teljara og nefnara. Til dæmis, 1000 mL = 1 L, svo 1000 mL / 1 L = 1.';
                } else if (question.type === 'cancellation_prediction') {
                    return 'Einingar strikast út þegar sama einingin birtist í bæði teljara og nefnara. Skoðaðu hvaða eining er í nefnara stuðulsins.';
                } else if (question.type === 'factor_selection') {
                    return 'Einingin sem þú vilt losna við þarf að vera í nefnara stuðulsins til að strikast út við upphafseiningu.';
                } else if (question.type === 'error_identification') {
                    return 'Athugaðu hvort einingin sem á að strikast út sé í réttri stöðu (teljara eða nefnara).';
                } else if (question.type === 'conceptual') {
                    return 'Hugsaðu um mismunandi stærðir eininga - minni einingar þurfa stærri tölur til að tákna sama magn.';
                }
                return 'Lestu spurninguna vandlega og hugsaðu um það sem þú lærðir í kennslustundunum.';
            };

            const toggleOption = (idx) => {
                if (selectedOptions.includes(idx)) {
                    setSelectedOptions(selectedOptions.filter(i => i !== idx));
                } else {
                    setSelectedOptions([...selectedOptions, idx]);
                }
            };

            const canSubmit = () => {
                if (question.multiSelect) {
                    return selectedOptions.length > 0;
                }
                if (question.explanationRequired || question.type === 'factor_selection') {
                    return selectedAnswer !== null && selectedExplanation !== null;
                }
                return selectedAnswer !== null;
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-4 flex items-center justify-between">
                            <button
                                onClick={onBack}
                                className="text-gray-600 hover:text-gray-800 flex items-center gap-2"
                            >
                                ← Til baka
                            </button>
                            <span className="text-gray-600">
                                Spurning {questionNumber} / {totalQuestions}
                            </span>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold mb-6">{question.prompt}</h2>

                            {question.type === 'error_identification' && question.visualization && (
                                <div className="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400">
                                    <p className="text-sm text-yellow-800">{question.visualization}</p>
                                </div>
                            )}

                            <div className="space-y-3 mb-6">
                                {question.multiSelect ? (
                                    question.options.map((option, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => !showFeedback && toggleOption(idx)}
                                            disabled={showFeedback}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                selectedOptions.includes(idx)
                                                    ? 'border-primary-orange bg-orange-50'
                                                    : 'border-gray-300 hover:border-gray-400'
                                            } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                        >
                                            {option.text || option}
                                        </button>
                                    ))
                                ) : question.type === 'factor_selection' ? (
                                    question.factors.map((factor, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => !showFeedback && setSelectedAnswer(idx)}
                                            disabled={showFeedback}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                selectedAnswer === idx
                                                    ? 'border-primary-orange bg-orange-50'
                                                    : 'border-gray-300 hover:border-gray-400'
                                            } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                        >
                                            {factor.text}
                                        </button>
                                    ))
                                ) : (
                                    question.options.map((option, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => !showFeedback && setSelectedAnswer(idx)}
                                            disabled={showFeedback}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                selectedAnswer === idx
                                                    ? 'border-primary-orange bg-orange-50'
                                                    : 'border-gray-300 hover:border-gray-400'
                                            } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                        >
                                            {option}
                                        </button>
                                    ))
                                )}
                            </div>

                            {(question.explanationRequired || question.type === 'factor_selection') && selectedAnswer !== null && (
                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <h3 className="font-semibold mb-3">Af hverju?</h3>
                                    <div className="space-y-2">
                                        {question.explanationOptions.map((exp, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => !showFeedback && setSelectedExplanation(idx)}
                                                disabled={showFeedback}
                                                className={`w-full p-3 rounded border-2 text-left text-sm transition-all ${
                                                    selectedExplanation === idx
                                                        ? 'border-blue-500 bg-blue-100'
                                                        : 'border-gray-300 hover:border-gray-400'
                                                } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                            >
                                                {exp.text}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {showHint && !showFeedback && (
                                <div className="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                                    <p className="text-sm font-semibold text-blue-800 mb-2">💡 Vísbending:</p>
                                    <p className="text-sm text-blue-700">{getHint()}</p>
                                    {hintUsed && (
                                        <p className="text-xs text-blue-600 mt-2">⚠️ Athugið: Þú færð ekki stig fyrir þessa spurningu þar sem þú notaðir vísbendingu.</p>
                                    )}
                                </div>
                            )}

                            {showFeedback && (
                                <div className={`mb-6 p-4 rounded-lg ${
                                    isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                }`}>
                                    <p className="font-bold text-lg mb-2">
                                        {isCorrect ? '✓ Rétt svar!' : '✗ Rangt svar'}
                                    </p>
                                    {hintUsed && (
                                        <p className="text-sm mt-2">Þú fékkst ekki stig fyrir þessa spurningu vegna notkunar vísbendingar.</p>
                                    )}
                                    {question.type === 'error_identification' && !isCorrect && question.correctText && (
                                        <p>{question.correctText}</p>
                                    )}
                                    {!isCorrect && question.explanationRequired && (
                                        <p className="mt-2">Athugaðu bæði svarið og útskýringuna.</p>
                                    )}
                                </div>
                            )}

                            {!showFeedback ? (
                                <div className="space-y-3">
                                    <button
                                        onClick={() => {
                                            setShowHint(!showHint);
                                            setHintUsed(true);
                                        }}
                                        className="w-full border-2 border-blue-400 text-blue-600 py-2 rounded-lg font-semibold hover:bg-blue-50"
                                    >
                                        {showHint ? '🔼 Fela vísbendingu' : '💡 Sýna vísbendingu'}
                                    </button>
                                    <button
                                        onClick={handleSubmit}
                                        disabled={!canSubmit()}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        Staðfesta svar
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={handleContinue}
                                    className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange"
                                >
                                    Halda áfram
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function PredictionModal({ factor, currentUnit, onPredict, onClose }) {
            const [prediction, setPrediction] = useState('');
            const [feedback, setFeedback] = useState(null);

            const handleSubmit = () => {
                const actualResult = predictResultingUnit(currentUnit, factor);
                const isCorrect = prediction.trim().toLowerCase() === actualResult.toLowerCase();

                setFeedback({
                    correct: isCorrect,
                    expected: actualResult
                });

                if (isCorrect) {
                    setTimeout(() => {
                        onPredict(true, actualResult);
                        onClose();
                    }, 1500);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <h3 className="text-xl font-bold mb-4">Spá um niðurstöðu</h3>

                        <div className="mb-4 p-4 bg-gray-50 rounded">
                            <p className="text-sm text-gray-600 mb-2">Þú valdir:</p>
                            <p className="text-lg font-mono font-bold text-center">
                                {factor.num} / {factor.den}
                            </p>
                        </div>

                        <p className="mb-4">
                            Ef þú bætir þessum stuðli við <span className="font-bold">{currentUnit}</span>,
                            hvaða eining verður útkoman?
                        </p>

                        <input
                            type="text"
                            value={prediction}
                            onChange={(e) => setPrediction(e.target.value)}
                            placeholder="t.d. kg, m/s, L"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 font-mono"
                            autoFocus
                        />

                        {feedback && (
                            <div className={`mb-4 p-3 rounded ${
                                feedback.correct ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }`}>
                                {feedback.correct ? (
                                    <p className="font-bold">✓ Rétt! Einingin verður {feedback.expected}</p>
                                ) : (
                                    <>
                                        <p className="font-bold">✗ Rangt</p>
                                        <p className="text-sm mt-1">Rétt svar: {feedback.expected}</p>
                                        <p className="text-sm mt-2">Reyndu aftur eða veldu annan stuðul.</p>
                                    </>
                                )}
                            </div>
                        )}

                        <div className="flex gap-3">
                            {!feedback?.correct && (
                                <>
                                    <button
                                        onClick={handleSubmit}
                                        disabled={!prediction.trim()}
                                        className="flex-1 bg-primary-orange text-white py-2 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300"
                                    >
                                        Staðfesta spá
                                    </button>
                                    <button
                                        onClick={onClose}
                                        className="px-4 border-2 border-gray-300 rounded-lg hover:border-gray-400"
                                    >
                                        Hætta við
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function Level3({ onComplete, onBack, initialProgress }) {
            const [currentProblemIndex, setCurrentProblemIndex] = useState(
                initialProgress?.problemsCompleted || 0
            );
            const [progress, setProgress] = useState(
                initialProgress || {
                    problemsCompleted: 0,
                    compositeScores: [],
                    totalSteps: 0,
                    achievements: [],
                    mastered: false
                }
            );
            const [userAnswer, setUserAnswer] = useState('');
            const [selectedOption, setSelectedOption] = useState(null);
            const [selectedPath, setSelectedPath] = useState(null);
            const [explanation, setExplanation] = useState('');
            const [showFeedback, setShowFeedback] = useState(false);
            const [scores, setScores] = useState(null);
            const [hintUsed, setHintUsed] = useState(false);
            const [showHint, setShowHint] = useState(false);

            const problem = level3Challenges[currentProblemIndex];

            useEffect(() => {
                if (problem) {
                    setUserAnswer('');
                    setSelectedOption(null);
                    setSelectedPath(null);
                    setExplanation('');
                    setShowFeedback(false);
                    setScores(null);
                    setHintUsed(false);
                    setShowHint(false);
                }
            }, [currentProblemIndex]);

            const scoreExplanation = (explanationText, problemType) => {
                // Improved explanation scoring with keyword matching
                const text = explanationText.toLowerCase().trim();

                if (text.length < 10) return 0; // Too short

                let score = 0;
                let maxScore = 0;

                // Common quality indicators (apply to all types)
                const qualityKeywords = ['umbreyti', 'stuðul', 'eining', 'margfalda', 'deila', 'strika'];
                const qualityCount = qualityKeywords.filter(kw => text.includes(kw)).length;
                score += Math.min(qualityCount * 0.15, 0.3); // Up to 30% for vocabulary
                maxScore += 0.3;

                // Type-specific keywords
                if (problemType === 'reverse') {
                    const keywords = ['afturábak', 'byrja', 'enda', 'leið'];
                    const found = keywords.filter(kw => text.includes(kw)).length;
                    score += (found / keywords.length) * 0.4;
                    maxScore += 0.4;
                } else if (problemType === 'error_analysis') {
                    const keywords = ['rang', 'öfug', 'villa', 'snúinn', 'nefnara'];
                    const found = keywords.filter(kw => text.includes(kw)).length;
                    score += (found / keywords.length) * 0.4;
                    maxScore += 0.4;
                } else if (problemType === 'efficiency') {
                    const keywords = ['fæst', 'skref', 'skilvirkn', 'bein'];
                    const found = keywords.filter(kw => text.includes(kw)).length;
                    score += (found / keywords.length) * 0.4;
                    maxScore += 0.4;
                } else if (problemType === 'synthesis') {
                    const keywords = ['eðlismassi', 'rúmmál', 'massi', 'margfalda'];
                    const found = keywords.filter(kw => text.includes(kw)).length;
                    score += (found / keywords.length) * 0.4;
                    maxScore += 0.4;
                } else if (problemType === 'real_world') {
                    const keywords = ['skammta', 'deila', 'fjöldi', 'heiltala'];
                    const found = keywords.filter(kw => text.includes(kw)).length;
                    score += (found / keywords.length) * 0.4;
                    maxScore += 0.4;
                } else if (problemType === 'derivation') {
                    const keywords = ['vísindatölustaf', 'umbreyti', 'hraði'];
                    const found = keywords.filter(kw => text.includes(kw)).length;
                    score += (found / keywords.length) * 0.4;
                    maxScore += 0.4;
                }

                // Length bonus (up to 30%)
                if (text.length >= 50) {
                    score += 0.3;
                } else if (text.length >= 30) {
                    score += 0.2;
                } else if (text.length >= 20) {
                    score += 0.1;
                }
                maxScore += 0.3;

                return Math.min(score / maxScore, 1); // Normalize to 0-1
            };

            const getLevel3Hint = () => {
                // Provide contextual hints based on problem type
                if (problem.type === 'reverse') {
                    return 'Byrjaðu með upphafsgildinu og spyrðu þig: Hvaða stuðlar myndu breyta því í lokagildið? Prófaðu að vinna aftur á bak frá svarinu.';
                } else if (problem.type === 'error_analysis') {
                    return 'Athugaðu hvort stuðullinn sé snúinn rétt - einingin sem á að hverfa þarf að vera í nefnara.';
                } else if (problem.type === 'efficiency') {
                    return 'Leitaðu að beinum stuðlum í stað þess að fara í gegnum margar millistig. Færri skref = meiri skilvirkni.';
                } else if (problem.type === 'synthesis') {
                    return 'Byrjaðu á að margfalda rúmmál með eðlismassa til að fá massa, síðan umbreyttu einingum.';
                } else if (problem.type === 'real_world') {
                    return 'Umbreyttu öllum gildum í sömu einingar áður en þú reiknar fjölda skammta.';
                } else if (problem.type === 'derivation') {
                    return 'Notaðu vísindatölustafi (t.d. 3.00e8) fyrir mjög stórar eða litlar tölur.';
                }
                return 'Hugsaðu vel um hvaða stuðla þú þarft og í hvaða röð.';
            };

            const handleSubmit = () => {
                let answerScore = 0;
                let methodScore = 0;
                let explanationScore = scoreExplanation(explanation, problem.type);
                let efficiencyScore = 0;
                let sigFigScore = null;
                let userSigFigs = null;

                // Score based on problem type
                if (problem.type === 'reverse') {
                    const selected = problem.options[selectedOption];
                    if (selected && selected.correct) {
                        answerScore = 1;
                        methodScore = 1;
                        // Efficiency bonus for fewer steps
                        if (selected.steps === 1) efficiencyScore = 1;
                        else if (selected.steps === 2) efficiencyScore = 0.8;
                    }
                } else if (problem.type === 'error_analysis') {
                    const userNum = parseFloat(userAnswer);
                    if (Math.abs(userNum - problem.correctAnswer) < 0.01) {
                        answerScore = 1;
                    }
                    if (explanation.toLowerCase().includes('öfug') || explanation.toLowerCase().includes('rang')) {
                        methodScore = 1;
                    }
                } else if (problem.type === 'efficiency') {
                    const userNum = parseFloat(userAnswer);
                    if (Math.abs(userNum - problem.targetAnswer) < 0.01) {
                        answerScore = 1;
                    }
                    if (selectedPath !== null) {
                        const path = problem.possiblePaths[selectedPath];
                        if (path.efficient) {
                            efficiencyScore = 1;
                            methodScore = 1;
                        } else {
                            methodScore = 0.5;
                        }
                    }
                } else if (problem.type === 'synthesis' || problem.type === 'derivation') {
                    const userNum = parseFloat(userAnswer);
                    const tolerance = problem.expectedAnswer * 0.01; // 1% tolerance
                    if (Math.abs(userNum - problem.expectedAnswer) < tolerance) {
                        answerScore = 1;
                    }

                    // Check significant figures if required
                    if (problem.significantFigures) {
                        userSigFigs = countSignificantFigures(userAnswer);
                        sigFigScore = userSigFigs === problem.significantFigures ? 1 : 0;
                        // Reduce answer score if sig figs are wrong (weighted: 70% value, 30% sig figs)
                        answerScore = answerScore * 0.7 + sigFigScore * 0.3;
                    }

                    if (explanation.length > 20) {
                        methodScore = 1;
                    }
                } else if (problem.type === 'real_world') {
                    const userNum = parseInt(userAnswer);
                    if (userNum === problem.expectedAnswer) {
                        answerScore = 1;
                        methodScore = 1;
                    }
                }

                let composite = calculateCompositeScore(answerScore, methodScore, explanationScore, efficiencyScore);

                // Level 3 rule: Hints cost points (reduce composite score by 15%)
                if (hintUsed) {
                    composite = composite * 0.85;
                }

                setScores({
                    answer: answerScore,
                    method: methodScore,
                    explanation: explanationScore,
                    efficiency: efficiencyScore,
                    composite: composite,
                    sigFig: sigFigScore,
                    userSigFigs: userSigFigs,
                    hintPenalty: hintUsed ? 0.15 : 0
                });

                setShowFeedback(true);

                // Update progress
                const newProgress = {
                    ...progress,
                    compositeScores: [...progress.compositeScores, composite],
                    totalSteps: progress.totalSteps + (selectedPath !== null ? problem.possiblePaths[selectedPath].stepCount : 2)
                };
                setProgress(newProgress);

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level3 = newProgress;
                saveProgress(saved);
            };

            const handleContinue = () => {
                const newProgress = {
                    ...progress,
                    problemsCompleted: progress.problemsCompleted + 1
                };

                // Check mastery and achievements after 10 problems
                if (newProgress.problemsCompleted >= 10) {
                    newProgress.mastered = checkLevel3Mastery(newProgress);
                    newProgress.achievements = checkAchievements(newProgress);
                }

                setProgress(newProgress);

                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level3 = newProgress;
                saveProgress(saved);

                if (currentProblemIndex < level3Challenges.length - 1) {
                    setCurrentProblemIndex(currentProblemIndex + 1);
                } else {
                    onComplete(newProgress);
                }
            };

            if (!problem) return null;

            const avgScore = progress.compositeScores.length > 0
                ? Math.round((progress.compositeScores.reduce((a, b) => a + b, 0) / progress.compositeScores.length) * 100)
                : 0;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-4 flex items-center justify-between">
                            <button
                                onClick={onBack}
                                className="text-gray-600 hover:text-gray-800 flex items-center gap-2"
                            >
                                ← Til baka
                            </button>
                            <div className="text-sm text-gray-600">
                                <span>Áskorun {progress.problemsCompleted + 1} / 10</span>
                                <span className="ml-4">Meðaleinkunn: {avgScore}%</span>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="mb-4">
                                <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold">
                                    {problem.type === 'reverse' && 'Öfug greining'}
                                    {problem.type === 'error_analysis' && 'Villugreining'}
                                    {problem.type === 'efficiency' && 'Skilvirkni'}
                                    {problem.type === 'synthesis' && 'Samsetning'}
                                    {problem.type === 'real_world' && 'Raunveruleiki'}
                                    {problem.type === 'derivation' && 'Afleiðing'}
                                </span>
                            </div>

                            <h2 className="text-2xl font-bold mb-6">{problem.prompt}</h2>

                            {(problem.type === 'synthesis' || problem.type === 'derivation') && problem.density && (
                                <div className="mb-6 p-4 bg-purple-50 border-l-4 border-purple-400 rounded">
                                    <p className="text-sm font-semibold text-purple-800 mb-2">📊 Gefnar upplýsingar:</p>
                                    <div className="space-y-1">
                                        {problem.startValue && problem.startUnit && (
                                            <p className="text-sm text-purple-700">
                                                <span className="font-semibold">Rúmmál:</span> {problem.startValue} {problem.startUnit}
                                            </p>
                                        )}
                                        {problem.density && problem.densityUnit && (
                                            <p className="text-sm text-purple-700">
                                                <span className="font-semibold">Eðlismassi:</span> {problem.density} {problem.densityUnit}
                                            </p>
                                        )}
                                        {problem.targetUnit && (
                                            <p className="text-sm text-purple-700">
                                                <span className="font-semibold">Markeining:</span> {problem.targetUnit}
                                            </p>
                                        )}
                                        {problem.significantFigures && (
                                            <p className="text-sm text-purple-700">
                                                <span className="font-semibold">Markverðir tölustafir:</span> {problem.significantFigures}
                                            </p>
                                        )}
                                    </div>
                                </div>
                            )}

                            {problem.type === 'real_world' && (problem.startValue || problem.portionSize) && (
                                <div className="mb-6 p-4 bg-green-50 border-l-4 border-green-400 rounded">
                                    <p className="text-sm font-semibold text-green-800 mb-2">📊 Gefnar upplýsingar:</p>
                                    <div className="space-y-1">
                                        {problem.startValue && problem.startUnit && (
                                            <p className="text-sm text-green-700">
                                                <span className="font-semibold">Heildarmagn:</span> {problem.startValue} {problem.startUnit}
                                            </p>
                                        )}
                                        {problem.portionSize && problem.portionUnit && (
                                            <p className="text-sm text-green-700">
                                                <span className="font-semibold">Skammtastærð:</span> {problem.portionSize} {problem.portionUnit}
                                            </p>
                                        )}
                                    </div>
                                </div>
                            )}

                            {problem.type === 'error_analysis' && problem.incorrectWork && (
                                <div className="mb-6 p-4 bg-red-50 border-l-4 border-red-400">
                                    <p className="text-sm text-gray-600 mb-1">Röng vinna:</p>
                                    <p className="font-mono text-red-800">{problem.incorrectWork}</p>
                                </div>
                            )}

                            {!showFeedback && (
                                <div className="space-y-6">
                                    {problem.type === 'reverse' && (
                                        <div className="space-y-3">
                                            <p className="font-semibold">Veldu rétta leið:</p>
                                            {problem.options.map((option, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => setSelectedOption(idx)}
                                                    className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                        selectedOption === idx
                                                            ? 'border-primary-orange bg-orange-50'
                                                            : 'border-gray-300 hover:border-gray-400'
                                                    }`}
                                                >
                                                    {option.text}
                                                    <span className="text-sm text-gray-500 ml-2">({option.steps} skref)</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    {problem.type === 'efficiency' && (
                                        <>
                                            <div className="space-y-3">
                                                <p className="font-semibold">Veldu leið:</p>
                                                {problem.possiblePaths.map((path, idx) => (
                                                    <button
                                                        key={idx}
                                                        onClick={() => setSelectedPath(idx)}
                                                        className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                            selectedPath === idx
                                                                ? 'border-primary-orange bg-orange-50'
                                                                : 'border-gray-300 hover:border-gray-400'
                                                        }`}
                                                    >
                                                        <div className="space-y-1">
                                                            {path.steps.map((step, sidx) => (
                                                                <div key={sidx} className="font-mono text-sm">{step}</div>
                                                            ))}
                                                        </div>
                                                        <span className="text-sm text-gray-500 mt-2 block">
                                                            {path.stepCount} skref
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                        </>
                                    )}

                                    <div>
                                        <label className="block font-semibold mb-2">
                                            {problem.type === 'error_analysis' ? 'Hvað er rétta svarið?' : 'Svar:'}
                                        </label>
                                        <input
                                            type="text"
                                            value={userAnswer}
                                            onChange={(e) => setUserAnswer(e.target.value)}
                                            placeholder={problem.scientificNotation ? 't.d. 1.08e12' : 'Sláðu inn svar'}
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg font-mono"
                                        />
                                        {problem.targetUnit && (
                                            <p className="text-sm text-gray-600 mt-1">Eining: {problem.targetUnit}</p>
                                        )}
                                    </div>

                                    <div>
                                        <label className="block font-semibold mb-2">
                                            Útskýring (hvernig leystir þú þetta?):
                                        </label>
                                        <textarea
                                            value={explanation}
                                            onChange={(e) => setExplanation(e.target.value)}
                                            placeholder="T.d. 'Fyrst breytti ég X í Y með stuðlinum Z. Síðan margfaldaði ég með eðlismassa til að fá massa...'"
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg h-24"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            💡 Tip: Notaðu orð eins og "umbreyti", "stuðull", "eining", "margfalda" fyrir betri einkunn
                                        </p>
                                    </div>

                                    {showHint && (
                                        <div className="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                                            <p className="text-sm font-semibold text-blue-800 mb-2">💡 Vísbending:</p>
                                            <p className="text-sm text-blue-700">{getLevel3Hint()}</p>
                                            <p className="text-xs text-orange-600 mt-2">⚠️ Athugið: Notkun vísbendingar dregur 15% frá heildareinkunnnum.</p>
                                        </div>
                                    )}

                                    <div className="space-y-3">
                                        {!showHint && (
                                            <button
                                                onClick={() => {
                                                    setShowHint(true);
                                                    setHintUsed(true);
                                                }}
                                                className="w-full border-2 border-blue-400 text-blue-600 py-2 rounded-lg font-semibold hover:bg-blue-50"
                                            >
                                                💡 Sýna vísbendingu (kostar 15% af einkunn)
                                            </button>
                                        )}
                                        <button
                                            onClick={handleSubmit}
                                            disabled={!userAnswer.trim() || !explanation.trim()}
                                            className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300"
                                        >
                                            Senda inn
                                        </button>
                                    </div>
                                </div>
                            )}

                            {showFeedback && scores && (
                                <>
                                    <div className={`mb-6 p-6 rounded-lg ${
                                        scores.composite >= 0.75 ? 'bg-green-100' : 'bg-yellow-100'
                                    }`}>
                                        <h3 className="text-xl font-bold mb-4">
                                            {scores.composite >= 0.75 ? '✓ Vel gert!' : '○ Þú getur gert betur'}
                                        </h3>

                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <p className="text-sm text-gray-600">Svar</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.answer * 100)}%</p>
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">Aðferð</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.method * 100)}%</p>
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">Útskýring</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.explanation * 100)}%</p>
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">Skilvirkni</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.efficiency * 100)}%</p>
                                            </div>
                                        </div>

                                        <div className="border-t pt-4">
                                            <p className="text-lg font-bold">
                                                Heildareinkunn: {Math.round(scores.composite * 100)}%
                                            </p>
                                            {scores.hintPenalty > 0 && (
                                                <p className="text-sm text-orange-600 mt-1">
                                                    (15% dregið frá vegna vísbendingar)
                                                </p>
                                            )}
                                        </div>

                                        {problem.type === 'error_analysis' && (
                                            <div className="mt-4 p-3 bg-white rounded">
                                                <p className="text-sm font-semibold mb-1">Útskýring á villunni:</p>
                                                <p className="text-sm">{problem.errorExplanation}</p>
                                            </div>
                                        )}

                                        {problem.significantFigures && scores.sigFig !== null && (
                                            <div className={`mt-4 p-3 rounded ${scores.sigFig === 1 ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>
                                                <p className="text-sm font-semibold mb-1">
                                                    {scores.sigFig === 1 ? '✓ Markverðir tölustafir réttir' : '✗ Markverðir tölustafir rangir'}
                                                </p>
                                                <p className="text-sm">
                                                    Þitt svar hefur {scores.userSigFigs} markverða tölustafi.
                                                    Ætti að hafa {problem.significantFigures}.
                                                </p>
                                            </div>
                                        )}
                                    </div>

                                    <button
                                        onClick={handleContinue}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange"
                                    >
                                        {currentProblemIndex < level3Challenges.length - 1 ? 'Næsta áskorun' : 'Ljúka'}
                                    </button>
                                </>
                            )}
                        </div>

                        {progress.achievements.length > 0 && (
                            <div className="mt-6 bg-white rounded-lg shadow-lg p-6">
                                <h3 className="text-xl font-bold mb-4">🏆 Afrek</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    {progress.achievements.map((achievement) => (
                                        <div key={achievement.id} className="p-4 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-lg">
                                            <p className="font-bold">{achievement.name}</p>
                                            <p className="text-sm text-gray-600">{achievement.description}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function Level2({ onComplete, onBack, initialProgress }) {
            const [currentProblemIndex, setCurrentProblemIndex] = useState(
                initialProgress?.problemsCompleted || 0
            );
            const [progress, setProgress] = useState(
                initialProgress || {
                    problemsCompleted: 0,
                    predictionsMade: 0,
                    predictionsCorrect: 0,
                    finalAnswersCorrect: 0,
                    mastered: false
                }
            );
            const [selectedFactors, setSelectedFactors] = useState([]);
            const [currentUnit, setCurrentUnit] = useState('');
            const [currentValue, setCurrentValue] = useState(0);
            const [showPredictionModal, setShowPredictionModal] = useState(false);
            const [pendingFactor, setPendingFactor] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [wrongPredictions, setWrongPredictions] = useState(0);
            const [showHint, setShowHint] = useState(false);

            const problem = level2Problems[currentProblemIndex];

            useEffect(() => {
                if (problem) {
                    setCurrentUnit(problem.startUnit);
                    setCurrentValue(problem.startValue);
                    setSelectedFactors([]);
                    setShowFeedback(false);
                    setWrongPredictions(0);
                    setShowHint(false);
                }
            }, [currentProblemIndex]);

            // Keyboard shortcuts for Level 2
            useEffect(() => {
                const handleKeyPress = (e) => {
                    // Don't trigger if user is typing in an input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    if (showFeedback) return; // Don't handle keys during feedback

                    const availableFactors = getAvailableFactors();

                    // Number keys (1-9) to select factors
                    if (e.key >= '1' && e.key <= '9') {
                        const index = parseInt(e.key) - 1;
                        if (index < availableFactors.length) {
                            handleFactorClick(availableFactors[index]);
                        }
                    }

                    // 'H' for hint
                    if (e.key.toLowerCase() === 'h' && wrongPredictions >= 1) {
                        setShowHint(!showHint);
                    }

                    // 'Enter' to submit
                    if (e.key === 'Enter' && selectedFactors.length > 0) {
                        handleSubmit();
                    }

                    // 'Esc' to clear last factor
                    if (e.key === 'Escape' && selectedFactors.length > 0) {
                        setSelectedFactors(selectedFactors.slice(0, -1));
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [showFeedback, selectedFactors, wrongPredictions, showHint, currentUnit]);

            const getAvailableFactors = () => {
                // Filter factors based on scaffolding level
                if (problem.scaffoldingLevel === 3) {
                    // Level 3 (Beginner): Only show factors that contain current unit
                    return conversionFactors.filter(f =>
                        f.units.includes(currentUnit) ||
                        (currentUnit.includes('/') && f.units.some(u => currentUnit.includes(u)))
                    );
                } else if (problem.scaffoldingLevel === 2) {
                    // Level 2 (Intermediate): Show all relevant factors (no obvious distractors)
                    // Relevant means: units that could be part of a conversion path to target
                    const targetUnit = problem.targetUnit;
                    return conversionFactors.filter(f => {
                        // Keep factors that involve current unit, target unit, or intermediate units
                        return f.units.includes(currentUnit) ||
                               f.units.includes(targetUnit) ||
                               (currentUnit.includes('/') && f.units.some(u => currentUnit.includes(u))) ||
                               (targetUnit.includes('/') && f.units.some(u => targetUnit.includes(u)));
                    });
                } else if (problem.scaffoldingLevel === 1) {
                    // Level 1 (Advanced): Show all factors including distractors
                    return conversionFactors;
                } else {
                    // Level 0 (Free practice): Show all factors
                    return conversionFactors;
                }
            };

            const isFactorCorrect = (factor) => {
                // Check if this factor is in the correct path
                const factorString = `${factor.num} / ${factor.den}`;
                return problem.correctPath.includes(factorString);
            };

            const isFactorRelevant = (factor) => {
                // Check if factor could help reach target from current position
                const factorParsed = { numerator: factor.num.split(' ')[1], denominator: factor.den.split(' ')[1] };

                // Parse current unit
                const currentParsed = currentUnit.includes('/')
                    ? { numerator: currentUnit.split('/')[0].trim(), denominator: currentUnit.split('/')[1].trim() }
                    : { numerator: currentUnit, denominator: null };

                // Relevant if the factor's denominator matches current numerator or denominator
                if (currentParsed.denominator) {
                    return factorParsed.denominator === currentParsed.numerator ||
                           factorParsed.denominator === currentParsed.denominator;
                } else {
                    return factorParsed.denominator === currentParsed.numerator;
                }
            };

            const handleFactorClick = (factor) => {
                setPendingFactor(factor);
                setShowPredictionModal(true);
            };

            const handlePrediction = (correct, resultingUnit) => {
                const newProgress = {
                    ...progress,
                    predictionsMade: progress.predictionsMade + 1,
                    predictionsCorrect: progress.predictionsCorrect + (correct ? 1 : 0)
                };
                setProgress(newProgress);

                // Save prediction progress immediately to localStorage
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level2 = newProgress;
                saveProgress(saved);

                // Track wrong predictions for hint system (Level 2 rule: require one wrong prediction)
                if (!correct) {
                    setWrongPredictions(wrongPredictions + 1);
                }

                if (correct) {
                    // Apply the factor
                    setSelectedFactors([...selectedFactors, pendingFactor]);
                    setCurrentUnit(resultingUnit);

                    // Calculate new value (simplified)
                    const factorNum = parseFloat(pendingFactor.num.split(' ')[0]);
                    const factorDen = parseFloat(pendingFactor.den.split(' ')[0]);
                    setCurrentValue(currentValue * factorNum / factorDen);
                }

                setPendingFactor(null);
            };

            const getLevel2Hint = () => {
                // Provide hint about the next step
                const nextStepIndex = selectedFactors.length;
                if (nextStepIndex < problem.correctPath.length) {
                    const nextFactor = problem.correctPath[nextStepIndex];
                    return `Næsta skref: Leita að stuðli sem inniheldur "${currentUnit}" í nefnara. Prófaðu: ${nextFactor}`;
                }
                return `Þú ert næstum því búin/n! Athugaðu hvort þú hafir náð markeiningu: ${problem.targetUnit}`;
            };

            const handleSubmit = () => {
                // Check if path matches correct path
                const selectedPath = selectedFactors.map(f => `${f.num} / ${f.den}`);
                const pathCorrect = problem.correctPath.every((step, idx) => selectedPath[idx] === step);
                const finalUnitCorrect = currentUnit === problem.targetUnit;

                const finalCorrect = pathCorrect && finalUnitCorrect;
                setIsCorrect(finalCorrect);
                setShowFeedback(true);

                const newProgress = {
                    ...progress,
                    finalAnswersCorrect: progress.finalAnswersCorrect + (finalCorrect ? 1 : 0)
                };
                setProgress(newProgress);

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level2 = newProgress;
                saveProgress(saved);
            };

            const handleContinue = () => {
                const newProgress = {
                    ...progress,
                    problemsCompleted: progress.problemsCompleted + 1
                };

                // Check mastery after 15 problems
                if (newProgress.problemsCompleted >= 15) {
                    newProgress.mastered = checkLevel2Mastery(newProgress);
                }

                setProgress(newProgress);

                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level2 = newProgress;
                saveProgress(saved);

                if (currentProblemIndex < level2Problems.length - 1) {
                    setCurrentProblemIndex(currentProblemIndex + 1);
                } else {
                    onComplete(newProgress);
                }
            };

            if (!problem) return null;

            const predictionAccuracy = progress.predictionsMade > 0
                ? Math.round((progress.predictionsCorrect / progress.predictionsMade) * 100)
                : 0;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-4 flex items-center justify-between">
                            <button
                                onClick={onBack}
                                className="text-gray-600 hover:text-gray-800 flex items-center gap-2"
                            >
                                ← Til baka
                            </button>
                            <div className="text-sm text-gray-600">
                                <span>Vandamál {progress.problemsCompleted + 1} / 15</span>
                                <span className="ml-4">Spágæði: {predictionAccuracy}%</span>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                <p className="text-sm text-gray-600 mb-1">Samhengi:</p>
                                <p className="font-semibold">{problem.context}</p>
                            </div>

                            <div className="mb-6 p-6 bg-gray-50 rounded-lg text-center">
                                <p className="text-sm text-gray-600 mb-2">Núverandi gildi:</p>
                                <p className="text-3xl font-bold primary-orange">
                                    {currentValue.toFixed(3)} {currentUnit}
                                </p>
                                <p className="text-sm text-gray-600 mt-4">Markeiining: {problem.targetUnit}</p>
                            </div>

                            {selectedFactors.length > 0 && (
                                <div className="mb-6">
                                    <p className="text-sm font-semibold mb-2">Stuðlar notaðir:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {selectedFactors.map((factor, idx) => (
                                            <div key={idx} className="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm font-mono">
                                                {factor.num} / {factor.den}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {!showFeedback && (
                                <>
                                    {showHint && (
                                        <div className="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                                            <p className="text-sm font-semibold text-blue-800 mb-2">💡 Vísbending:</p>
                                            <p className="text-sm text-blue-700">{getLevel2Hint()}</p>
                                        </div>
                                    )}

                                    {wrongPredictions >= 1 && !showHint && (
                                        <div className="mb-4">
                                            <button
                                                onClick={() => setShowHint(true)}
                                                className="w-full border-2 border-blue-400 text-blue-600 py-2 rounded-lg font-semibold hover:bg-blue-50"
                                            >
                                                💡 Sýna vísbendingu (í boði eftir ranga spá)
                                            </button>
                                        </div>
                                    )}

                                    <div className="mb-6">
                                        <p className="font-semibold mb-3">
                                            Veldu umbreytingarstuðul:
                                            <span className="ml-2 text-sm text-gray-500">
                                                (Stig {problem.scaffoldingLevel === 3 ? 'Byrjandi' : problem.scaffoldingLevel === 2 ? 'Miðlungs' : 'Framþróað'})
                                            </span>
                                        </p>
                                        <div className="grid grid-cols-2 gap-3">
                                            {getAvailableFactors().map((factor, idx) => {
                                                const relevant = isFactorRelevant(factor);
                                                const correct = isFactorCorrect(factor);

                                                // Scaffolding level 3: Gray out incorrect factors
                                                const isGrayed = problem.scaffoldingLevel === 3 && !relevant;

                                                // Scaffolding level 2: Show warning on hover for incorrect
                                                const showWarning = problem.scaffoldingLevel === 2 && !relevant;

                                                return (
                                                    <div key={idx} className="relative group">
                                                        <button
                                                            onClick={() => handleFactorClick(factor)}
                                                            disabled={isGrayed}
                                                            className={`w-full p-3 border-2 rounded-lg transition-all font-mono text-sm relative ${
                                                                isGrayed
                                                                    ? 'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed'
                                                                    : 'border-gray-300 hover:border-primary-orange hover:bg-orange-50'
                                                            }`}
                                                            title={isGrayed ? 'Þessi stuðull passar ekki við núverandi einingu' : ''}
                                                        >
                                                            {idx < 9 && (
                                                                <span className="absolute top-1 left-1 text-xs bg-gray-200 text-gray-600 rounded px-1">
                                                                    {idx + 1}
                                                                </span>
                                                            )}
                                                            {factor.num} / {factor.den}
                                                        </button>
                                                        {showWarning && !relevant && (
                                                            <div className="absolute z-10 hidden group-hover:block bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-yellow-100 border border-yellow-300 text-yellow-800 text-xs rounded shadow-lg whitespace-nowrap">
                                                                ⚠️ Gæti ekki verið besti kosturinn
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <button
                                        onClick={handleSubmit}
                                        disabled={selectedFactors.length === 0}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300"
                                    >
                                        Athuga svar
                                    </button>

                                    <div className="mt-4 p-3 bg-gray-50 rounded border border-gray-200">
                                        <p className="text-xs font-semibold text-gray-600 mb-2">⌨️ Flýtilyklar:</p>
                                        <div className="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                            <div><kbd className="px-1 bg-white border rounded">1-9</kbd> Velja stuðul</div>
                                            <div><kbd className="px-1 bg-white border rounded">Enter</kbd> Athuga svar</div>
                                            <div><kbd className="px-1 bg-white border rounded">H</kbd> Vísbending</div>
                                            <div><kbd className="px-1 bg-white border rounded">Esc</kbd> Eyða síðasta</div>
                                        </div>
                                    </div>
                                </>
                            )}

                            {showFeedback && (
                                <>
                                    <div className={`mb-6 p-4 rounded-lg ${
                                        isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`}>
                                        <p className="font-bold text-lg mb-2">
                                            {isCorrect ? '✓ Frábært! Rétt svar!' : '✗ Ekki alveg rétt'}
                                        </p>
                                        {!isCorrect && (
                                            <div className="text-sm mt-2">
                                                <p>Rétt leið:</p>
                                                <div className="mt-1 space-y-1">
                                                    {problem.correctPath.map((step, idx) => (
                                                        <div key={idx} className="font-mono">{step}</div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <button
                                        onClick={handleContinue}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange"
                                    >
                                        {currentProblemIndex < level2Problems.length - 1 ? 'Næsta vandamál' : 'Ljúka'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {showPredictionModal && pendingFactor && (
                        <PredictionModal
                            factor={pendingFactor}
                            currentUnit={currentUnit}
                            onPredict={handlePrediction}
                            onClose={() => {
                                setShowPredictionModal(false);
                                setPendingFactor(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        function Level1({ onComplete, onBack, initialProgress }) {
            const [phase, setPhase] = useState(initialProgress?.lessonsCompleted?.length === 3 ? 'questions' : 'lessons');
            const [currentLesson, setCurrentLesson] = useState(
                initialProgress?.lessonsCompleted?.length || 0
            );
            const [currentQuestion, setCurrentQuestion] = useState(
                initialProgress?.questionsAnswered || 0
            );
            const [progress, setProgress] = useState(
                initialProgress || {
                    lessonsCompleted: [],
                    questionsAnswered: 0,
                    questionsCorrect: 0,
                    explanationScores: [],
                    mastered: false
                }
            );

            const completeLesson = () => {
                const newProgress = {
                    ...progress,
                    lessonsCompleted: [...progress.lessonsCompleted, lessons[currentLesson].id]
                };
                setProgress(newProgress);

                if (currentLesson < lessons.length - 1) {
                    setCurrentLesson(currentLesson + 1);
                } else {
                    setPhase('questions');
                }

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level1 = newProgress;
                saveProgress(saved);
            };

            const answerQuestion = (correct, explanationCorrect) => {
                const newProgress = {
                    ...progress,
                    questionsAnswered: progress.questionsAnswered + 1,
                    questionsCorrect: progress.questionsCorrect + (correct ? 1 : 0),
                    explanationScores: [...progress.explanationScores, explanationCorrect ? 1 : 0]
                };

                setProgress(newProgress);

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level1 = newProgress;

                // Check mastery
                if (newProgress.questionsAnswered === 10) {
                    newProgress.mastered = checkLevel1Mastery(newProgress);
                    saved.levelProgress.level1 = newProgress;
                }

                saveProgress(saved);

                if (currentQuestion < level1Questions.length - 1) {
                    setCurrentQuestion(currentQuestion + 1);
                } else {
                    onComplete(newProgress);
                }
            };

            if (phase === 'lessons') {
                return (
                    <LessonScreen
                        lesson={lessons[currentLesson]}
                        onComplete={completeLesson}
                    />
                );
            }

            return (
                <QuestionScreen
                    question={level1Questions[currentQuestion]}
                    questionNumber={currentQuestion + 1}
                    totalQuestions={level1Questions.length}
                    onAnswer={answerQuestion}
                    onBack={onBack}
                />
            );
        }

        function MainMenu({ onStartLevel1, onStartLevel2, onStartLevel3, onViewStats, onReset, progress }) {
            const level1Progress = progress?.levelProgress?.level1 || {
                questionsAnswered: 0,
                questionsCorrect: 0,
                mastered: false
            };

            const level2Progress = progress?.levelProgress?.level2 || {
                problemsCompleted: 0,
                predictionsMade: 0,
                predictionsCorrect: 0,
                finalAnswersCorrect: 0,
                mastered: false
            };

            const level3Progress = progress?.levelProgress?.level3 || {
                problemsCompleted: 0,
                compositeScores: [],
                totalSteps: 0,
                achievements: [],
                mastered: false
            };

            const level1Percentage = level1Progress.questionsAnswered > 0
                ? Math.round((level1Progress.questionsCorrect / 10) * 100)
                : 0;

            const level2Percentage = level2Progress.problemsCompleted > 0
                ? Math.round((level2Progress.finalAnswersCorrect / level2Progress.problemsCompleted) * 100)
                : 0;

            const level3Percentage = level3Progress.compositeScores.length > 0
                ? Math.round((level3Progress.compositeScores.reduce((a, b) => a + b, 0) / level3Progress.compositeScores.length) * 100)
                : 0;

            const level2Unlocked = level1Progress.mastered;
            const level3Unlocked = level2Progress.mastered;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold primary-orange mb-2">🔬 EININGAGREINING</h1>
                            <p className="text-xl text-gray-600">Námsleiðin</p>
                        </div>

                        <div className="space-y-4">
                            {/* Level 1 */}
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-bold">Level 1: Skilningur</h2>
                                    <button
                                        onClick={onStartLevel1}
                                        className="bg-primary-orange text-white px-6 py-2 rounded-lg font-bold hover:bg-dark-orange"
                                    >
                                        {level1Progress.questionsAnswered > 0 ? 'Halda áfram' : 'Byrja'}
                                    </button>
                                </div>
                                <div className="mb-2">
                                    <div className="w-full bg-gray-200 rounded-full h-4">
                                        <div
                                            className="bg-primary-orange h-4 rounded-full transition-all"
                                            style={{ width: `${level1Percentage}%` }}
                                        ></div>
                                    </div>
                                </div>
                                <p className="text-gray-600">
                                    {level1Progress.questionsCorrect}/10 rétt
                                    {level1Progress.mastered && <span className="ml-2 text-green-600 font-bold">✓ Námsmarkmið náð!</span>}
                                </p>
                                <p className="text-sm text-gray-500 mt-2">
                                    Þarfnast: 8/10 rétt með útskýringum
                                </p>
                            </div>

                            {/* Level 2 */}
                            <div className={`bg-white rounded-lg shadow-lg p-6 ${!level2Unlocked ? 'opacity-50' : ''}`}>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-bold">Level 2: Beiting</h2>
                                    <button
                                        onClick={onStartLevel2}
                                        disabled={!level2Unlocked}
                                        className={`px-6 py-2 rounded-lg font-bold ${
                                            level2Unlocked
                                                ? 'bg-primary-orange text-white hover:bg-dark-orange'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {!level2Unlocked ? '🔒 Læst' : level2Progress.problemsCompleted > 0 ? 'Halda áfram' : 'Byrja'}
                                    </button>
                                </div>
                                {level2Unlocked ? (
                                    <>
                                        <div className="mb-2">
                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                <div
                                                    className="bg-primary-orange h-4 rounded-full transition-all"
                                                    style={{ width: `${(level2Progress.problemsCompleted / 15) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                        <p className="text-gray-600">
                                            {level2Progress.problemsCompleted}/15 vandamál
                                            {level2Progress.mastered && <span className="ml-2 text-green-600 font-bold">✓ Námsmarkmið náð!</span>}
                                        </p>
                                        <p className="text-sm text-gray-500 mt-2">
                                            Þarfnast: 15 vandamál, 70%+ spágæði, 80%+ rétt svör
                                        </p>
                                    </>
                                ) : (
                                    <p className="text-gray-600">Kláraðu Level 1 til að opna</p>
                                )}
                            </div>

                            {/* Level 3 */}
                            <div className={`bg-white rounded-lg shadow-lg p-6 ${!level3Unlocked ? 'opacity-50' : ''}`}>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-bold">Level 3: Greining</h2>
                                    <button
                                        onClick={onStartLevel3}
                                        disabled={!level3Unlocked}
                                        className={`px-6 py-2 rounded-lg font-bold ${
                                            level3Unlocked
                                                ? 'bg-primary-orange text-white hover:bg-dark-orange'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {!level3Unlocked ? '🔒 Læst' : level3Progress.problemsCompleted > 0 ? 'Halda áfram' : 'Byrja'}
                                    </button>
                                </div>
                                {level3Unlocked ? (
                                    <>
                                        <div className="mb-2">
                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                <div
                                                    className="bg-primary-orange h-4 rounded-full transition-all"
                                                    style={{ width: `${(level3Progress.problemsCompleted / 10) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                        <p className="text-gray-600">
                                            {level3Progress.problemsCompleted}/10 áskoranir
                                            {level3Progress.mastered && <span className="ml-2 text-green-600 font-bold">✓ Námsmarkmið náð!</span>}
                                        </p>
                                        <p className="text-sm text-gray-500 mt-2">
                                            Þarfnast: 10 áskoranir, 75%+ heildareinkunn
                                        </p>
                                        {level3Progress.achievements.length > 0 && (
                                            <div className="mt-3 flex gap-2 flex-wrap">
                                                {level3Progress.achievements.map(a => (
                                                    <span key={a.id} className="text-2xl" title={a.description}>
                                                        {a.id === 'gold' && '🥇'}
                                                        {a.id === 'silver' && '🥈'}
                                                        {a.id === 'bronze' && '🥉'}
                                                        {a.id === 'efficiency' && '⚡'}
                                                        {a.id === 'explainer' && '📝'}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <p className="text-gray-600">Kláraðu Level 2 til að opna</p>
                                )}
                            </div>
                        </div>

                        <div className="mt-8 flex gap-4 justify-center">
                            <button
                                onClick={onViewStats}
                                className="border-2 border-gray-300 px-6 py-2 rounded-lg hover:border-gray-400"
                            >
                                Sjá tölfræði
                            </button>
                            <button
                                onClick={onReset}
                                className="border-2 border-red-300 text-red-600 px-6 py-2 rounded-lg hover:border-red-400"
                            >
                                Byrja aftur
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function StatsScreen({ progress, onBack }) {
            const level1Progress = progress?.levelProgress?.level1 || {
                questionsAnswered: 0,
                questionsCorrect: 0,
                explanationScores: []
            };

            const level2Progress = progress?.levelProgress?.level2 || {
                problemsCompleted: 0,
                predictionsMade: 0,
                predictionsCorrect: 0,
                finalAnswersCorrect: 0,
                mastered: false
            };

            const explanationAvg = level1Progress.explanationScores.length > 0
                ? Math.round((level1Progress.explanationScores.reduce((a, b) => a + b, 0) / level1Progress.explanationScores.length) * 100)
                : 0;

            const predictionAccuracy = level2Progress.predictionsMade > 0
                ? Math.round((level2Progress.predictionsCorrect / level2Progress.predictionsMade) * 100)
                : 0;

            const answerAccuracy = level2Progress.problemsCompleted > 0
                ? Math.round((level2Progress.finalAnswersCorrect / level2Progress.problemsCompleted) * 100)
                : 0;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <button
                            onClick={onBack}
                            className="mb-4 text-gray-600 hover:text-gray-800 flex items-center gap-2"
                        >
                            ← Til baka
                        </button>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold mb-6">Tölfræði</h2>

                            <div className="space-y-6">
                                <div>
                                    <h3 className="text-xl font-semibold mb-3 primary-orange">Level 1: Skilningur</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">Spurningar svaraðar</p>
                                            <p className="text-2xl font-bold">{level1Progress.questionsAnswered}/10</p>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">Rétt svör</p>
                                            <p className="text-2xl font-bold">{level1Progress.questionsCorrect}/10</p>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">Útskýringar</p>
                                            <p className="text-2xl font-bold">{explanationAvg}%</p>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">Staða</p>
                                            <p className="text-2xl font-bold">
                                                {level1Progress.mastered ? '✓ Náð' : '⋯ Í vinnslu'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="text-lg font-semibold mb-2">Námsmarkmið Level 1</h3>
                                    <ul className="space-y-2 text-sm">
                                        <li className={level1Progress.questionsCorrect >= 8 ? 'text-green-600' : 'text-gray-600'}>
                                            {level1Progress.questionsCorrect >= 8 ? '✓' : '○'} 8/10 rétt svör
                                        </li>
                                        <li className={explanationAvg >= 70 ? 'text-green-600' : 'text-gray-600'}>
                                            {explanationAvg >= 70 ? '✓' : '○'} 70%+ á útskýringum
                                        </li>
                                    </ul>
                                </div>

                                {level1Progress.mastered && (
                                    <>
                                        <div className="border-t pt-6">
                                            <h3 className="text-xl font-semibold mb-3 primary-orange">Level 2: Beiting</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Vandamál leyst</p>
                                                    <p className="text-2xl font-bold">{level2Progress.problemsCompleted}/15</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Spágæði</p>
                                                    <p className="text-2xl font-bold">{predictionAccuracy}%</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Rétt svör</p>
                                                    <p className="text-2xl font-bold">{answerAccuracy}%</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Staða</p>
                                                    <p className="text-2xl font-bold">
                                                        {level2Progress.mastered ? '✓ Náð' : '⋯ Í vinnslu'}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="border-t pt-6">
                                            <h3 className="text-lg font-semibold mb-2">Námsmarkmið Level 2</h3>
                                            <ul className="space-y-2 text-sm">
                                                <li className={level2Progress.problemsCompleted >= 15 ? 'text-green-600' : 'text-gray-600'}>
                                                    {level2Progress.problemsCompleted >= 15 ? '✓' : '○'} 15 vandamál lokið
                                                </li>
                                                <li className={predictionAccuracy >= 70 ? 'text-green-600' : 'text-gray-600'}>
                                                    {predictionAccuracy >= 70 ? '✓' : '○'} 70%+ spágæði
                                                </li>
                                                <li className={answerAccuracy >= 80 ? 'text-green-600' : 'text-gray-600'}>
                                                    {answerAccuracy >= 80 ? '✓' : '○'} 80%+ rétt svör
                                                </li>
                                            </ul>
                                        </div>
                                    </>
                                )}

                                {level2Progress.mastered && progress?.levelProgress?.level3 && (
                                    <>
                                        <div className="border-t pt-6">
                                            <h3 className="text-xl font-semibold mb-3 primary-orange">Level 3: Greining</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Áskoranir kláraðar</p>
                                                    <p className="text-2xl font-bold">{progress.levelProgress.level3.problemsCompleted}/10</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Meðaleinkunn</p>
                                                    <p className="text-2xl font-bold">
                                                        {progress.levelProgress.level3.compositeScores.length > 0
                                                            ? Math.round((progress.levelProgress.level3.compositeScores.reduce((a, b) => a + b, 0) / progress.levelProgress.level3.compositeScores.length) * 100)
                                                            : 0}%
                                                    </p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Afrek</p>
                                                    <p className="text-2xl font-bold">{progress.levelProgress.level3.achievements.length}</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Staða</p>
                                                    <p className="text-2xl font-bold">
                                                        {progress.levelProgress.level3.mastered ? '✓ Náð' : '⋯ Í vinnslu'}
                                                    </p>
                                                </div>
                                            </div>

                                            {progress.levelProgress.level3.achievements.length > 0 && (
                                                <div className="mt-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg">
                                                    <p className="font-semibold mb-2">Afrek:</p>
                                                    <div className="flex gap-3 flex-wrap">
                                                        {progress.levelProgress.level3.achievements.map(a => (
                                                            <div key={a.id} className="flex items-center gap-2 text-sm">
                                                                <span className="text-2xl">
                                                                    {a.id === 'gold' && '🥇'}
                                                                    {a.id === 'silver' && '🥈'}
                                                                    {a.id === 'bronze' && '🥉'}
                                                                    {a.id === 'efficiency' && '⚡'}
                                                                    {a.id === 'explainer' && '📝'}
                                                                </span>
                                                                <span>{a.name}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="border-t pt-6">
                                            <h3 className="text-lg font-semibold mb-2">Námsmarkmið Level 3</h3>
                                            <ul className="space-y-2 text-sm">
                                                <li className={progress.levelProgress.level3.problemsCompleted >= 10 ? 'text-green-600' : 'text-gray-600'}>
                                                    {progress.levelProgress.level3.problemsCompleted >= 10 ? '✓' : '○'} 10 áskoranir kláraðar
                                                </li>
                                                <li className={progress.levelProgress.level3.compositeScores.length > 0 && (progress.levelProgress.level3.compositeScores.reduce((a, b) => a + b, 0) / progress.levelProgress.level3.compositeScores.length) >= 0.75 ? 'text-green-600' : 'text-gray-600'}>
                                                    {progress.levelProgress.level3.compositeScores.length > 0 && (progress.levelProgress.level3.compositeScores.reduce((a, b) => a + b, 0) / progress.levelProgress.level3.compositeScores.length) >= 0.75 ? '✓' : '○'} 75%+ heildareinkunn
                                                </li>
                                            </ul>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [gameState, setGameState] = useState({
                screen: 'menu',
                progress: loadProgress() || {
                    currentLevel: 1,
                    levelProgress: {
                        level1: {
                            lessonsCompleted: [],
                            questionsAnswered: 0,
                            questionsCorrect: 0,
                            explanationScores: [],
                            mastered: false
                        },
                        level2: {
                            problemsCompleted: 0,
                            predictionsMade: 0,
                            predictionsCorrect: 0,
                            finalAnswersCorrect: 0,
                            mastered: false
                        },
                        level3: {
                            problemsCompleted: 0,
                            compositeScores: [],
                            totalSteps: 0,
                            achievements: [],
                            mastered: false
                        }
                    }
                }
            });

            const handleStartLevel1 = () => {
                setGameState({ ...gameState, screen: 'level1' });
            };

            const handleStartLevel2 = () => {
                setGameState({ ...gameState, screen: 'level2' });
            };

            const handleStartLevel3 = () => {
                setGameState({ ...gameState, screen: 'level3' });
            };

            const handleLevel1Complete = (level1Progress) => {
                const newProgress = { ...gameState.progress };
                newProgress.levelProgress.level1 = level1Progress;
                saveProgress(newProgress);
                setGameState({ ...gameState, progress: newProgress, screen: 'menu' });
            };

            const handleLevel2Complete = (level2Progress) => {
                const newProgress = { ...gameState.progress };
                newProgress.levelProgress.level2 = level2Progress;
                saveProgress(newProgress);
                setGameState({ ...gameState, progress: newProgress, screen: 'menu' });
            };

            const handleLevel3Complete = (level3Progress) => {
                const newProgress = { ...gameState.progress };
                newProgress.levelProgress.level3 = level3Progress;
                saveProgress(newProgress);
                setGameState({ ...gameState, progress: newProgress, screen: 'menu' });
            };

            const handleViewStats = () => {
                setGameState({ ...gameState, screen: 'stats' });
            };

            const handleReset = () => {
                if (confirm('Ertu viss um að þú viljir eyða öllum framförum?')) {
                    localStorage.removeItem('dimensionalAnalysisProgress');
                    setGameState({
                        screen: 'menu',
                        progress: {
                            currentLevel: 1,
                            levelProgress: {
                                level1: {
                                    lessonsCompleted: [],
                                    questionsAnswered: 0,
                                    questionsCorrect: 0,
                                    explanationScores: [],
                                    mastered: false
                                },
                                level2: {
                                    problemsCompleted: 0,
                                    predictionsMade: 0,
                                    predictionsCorrect: 0,
                                    finalAnswersCorrect: 0,
                                    mastered: false
                                },
                                level3: {
                                    problemsCompleted: 0,
                                    compositeScores: [],
                                    totalSteps: 0,
                                    achievements: [],
                                    mastered: false
                                }
                            }
                        }
                    });
                }
            };

            const handleBack = () => {
                setGameState({ ...gameState, screen: 'menu' });
            };

            if (gameState.screen === 'level1') {
                return (
                    <Level1
                        onComplete={handleLevel1Complete}
                        onBack={handleBack}
                        initialProgress={gameState.progress.levelProgress.level1}
                    />
                );
            }

            if (gameState.screen === 'level2') {
                return (
                    <Level2
                        onComplete={handleLevel2Complete}
                        onBack={handleBack}
                        initialProgress={gameState.progress.levelProgress.level2}
                    />
                );
            }

            if (gameState.screen === 'level3') {
                return (
                    <Level3
                        onComplete={handleLevel3Complete}
                        onBack={handleBack}
                        initialProgress={gameState.progress.levelProgress.level3}
                    />
                );
            }

            if (gameState.screen === 'stats') {
                return (
                    <StatsScreen
                        progress={gameState.progress}
                        onBack={handleBack}
                    />
                );
            }

            return (
                <MainMenu
                    onStartLevel1={handleStartLevel1}
                    onStartLevel2={handleStartLevel2}
                    onStartLevel3={handleStartLevel3}
                    onViewStats={handleViewStats}
                    onReset={handleReset}
                    progress={gameState.progress}
                />
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
